{% extends 'md3/base.html' %}
{% block head %}
  {{ super() }}
  <style>
    .md3-page { padding: 0; padding-top: 56px; background: var(--md-sys-color-surface-container-lowest); min-height: 100vh; }
    
    /* Hero Section mit Gradient */
    .profile-hero { 
      background: linear-gradient(135deg, #6750A4 0%, #9575CD 50%, #B39DDB 100%);
      padding: 60px 24px 80px;
      position: relative;
      overflow: hidden;
    }
    
    /* Organische Dekoration */
    .profile-hero::before {
      content: '';
      position: absolute;
      top: -50px;
      right: -50px;
      width: 200px;
      height: 200px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 63% 37% 54% 46% / 55% 48% 52% 45%;
      animation: float 6s ease-in-out infinite;
    }
    
    .profile-hero::after {
      content: '';
      position: absolute;
      bottom: -30px;
      left: -30px;
      width: 150px;
      height: 150px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 48% 52% 68% 32% / 42% 68% 32% 58%;
      animation: float 8s ease-in-out infinite reverse;
    }
    
    @keyframes float {
      0%, 100% { transform: translate(0, 0) rotate(0deg); }
      50% { transform: translate(-20px, 20px) rotate(10deg); }
    }
    
    /* Avatar mit organischer Form */
    .profile-avatar-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      position: relative;
      z-index: 1;
    }
    
    .avatar-blob {
      position: relative;
      width: 180px;
      height: 180px;
      background: linear-gradient(135deg, #FF6B9D 0%, #FFA06B 100%);
      border-radius: 63% 37% 54% 46% / 55% 48% 52% 45%;
      padding: 8px;
      animation: morph 8s ease-in-out infinite;
      cursor: pointer;
      transition: transform 0.3s ease;
    }
    
    .avatar-blob:hover {
      transform: scale(1.05);
    }
    
    @keyframes morph {
      0%, 100% { border-radius: 63% 37% 54% 46% / 55% 48% 52% 45%; }
      25% { border-radius: 48% 52% 68% 32% / 42% 68% 32% 58%; }
      50% { border-radius: 40% 60% 60% 40% / 70% 30% 70% 30%; }
      75% { border-radius: 58% 42% 38% 62% / 48% 70% 30% 52%; }
    }
    
    .avatar-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: inherit;
    }
    
    .profile-hero-name {
      font: var(--md-sys-typescale-headline-large-font);
      color: white;
      margin: 0;
      font-weight: 600;
      text-align: center;
      text-shadow: 0 2px 8px rgba(0,0,0,0.2);
      letter-spacing: -0.02em;
    }
    
    .profile-hero-username {
      font: var(--md-sys-typescale-title-medium-font);
      color: rgba(255, 255, 255, 0.9);
      margin: 0;
      text-align: center;
    }
    
    .profile-hero-role {
      background: rgba(255, 255, 255, 0.95);
      color: #6750A4;
      padding: 10px 24px;
      border-radius: 999px;
      font: var(--md-sys-typescale-label-large-font);
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    /* Content Container */
    .profile-content {
      max-width: 600px;
      margin: -40px auto 0;
      padding: 0 20px 40px;
      position: relative;
      z-index: 2;
    }
    
    /* Accordion Sections */
    .accordion-section {
      background: var(--md-sys-color-surface);
      border-radius: 24px;
      margin-bottom: 16px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: all 0.3s ease;
    }
    
    .accordion-section:hover {
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    }
    
    .accordion-header {
      padding: 20px 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(135deg, var(--md-sys-color-primary-container) 0%, var(--md-sys-color-secondary-container) 100%);
      transition: all 0.3s ease;
    }
    
    .accordion-header:hover {
      background: linear-gradient(135deg, var(--md-sys-color-secondary-container) 0%, var(--md-sys-color-tertiary-container) 100%);
    }
    
    .accordion-header-content {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }
    
    .accordion-icon {
      color: var(--md-sys-color-on-primary-container);
      font-size: 28px;
    }
    
    .accordion-title {
      font: var(--md-sys-typescale-title-large-font);
      color: var(--md-sys-color-on-primary-container);
      margin: 0;
      font-weight: 600;
    }
    
    .accordion-chevron {
      color: var(--md-sys-color-on-primary-container);
      font-size: 24px;
      transition: transform 0.3s ease;
    }
    
    .accordion-section.active .accordion-chevron {
      transform: rotate(180deg);
    }
    
    .accordion-body {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    
    .accordion-section.active .accordion-body {
      max-height: 1000px;
    }
    
    .accordion-content {
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .info-item {
      display: flex;
      align-items: start;
      gap: 12px;
      padding: 12px 16px;
      background: var(--md-sys-color-surface-container-lowest);
      border-radius: 16px;
      border-left: 4px solid var(--md-sys-color-primary);
      cursor: pointer;
      transition: opacity 0.2s ease;
      position: relative;
    }
    
    .info-item:hover {
      opacity: 0.9;
    }
    
    .info-item::after {
      content: 'edit';
      font-family: 'Material Symbols Outlined';
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--md-sys-color-primary);
      font-size: 20px;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    
    .info-item:hover::after {
      opacity: 1;
    }
    
    .info-item-icon {
      color: var(--md-sys-color-primary);
      font-size: 24px;
      min-width: 24px;
    }
    
    .info-item-content {
      flex: 1;
    }
    
    .info-item-label {
      font: var(--md-sys-typescale-label-small-font);
      color: var(--md-sys-color-on-surface-variant);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 4px;
    }
    
    .info-item-value {
      font: var(--md-sys-typescale-body-large-font);
      color: var(--md-sys-color-on-surface);
      font-weight: 500;
    }

    .profile-actions { margin-top: 24px; display: flex; justify-content: flex-end; }
    .md3-button { border: none; border-radius: 999px; padding: 14px 32px; cursor: pointer; display: inline-flex; align-items: center; gap: 10px; text-decoration: none; white-space: nowrap; font: var(--md-sys-typescale-label-large-font); font-weight: 500; transition: all 0.2s ease; box-shadow: var(--md-sys-elevation-level1); }
    .md3-button .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 20; font-size: 20px; }
    .md3-button-filled { background: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); }
    .md3-button-filled:hover { box-shadow: var(--md-sys-elevation-level3); transform: translateY(-2px); }
    .md3-button-filled:active { transform: translateY(0); box-shadow: var(--md-sys-elevation-level1); }
    .md3-button-tonal { background: var(--md-sys-color-secondary-container); color: var(--md-sys-color-on-secondary-container); }
    .md3-button-tonal:hover { box-shadow: var(--md-sys-elevation-level2); }
    .md3-button-outlined { background: transparent; color: var(--md-sys-color-primary); border: 1px solid var(--md-sys-color-outline); }
    .md3-button-outlined:hover { background: var(--md-sys-color-surface-container-high); }
    .md3-button-text { background: transparent; color: var(--md-sys-color-error); box-shadow: none; }
    .md3-button-text:hover { background: var(--md-sys-color-error-container); }
    .permission-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 12px; }
    .permission-tile { background: linear-gradient(135deg, var(--md-sys-color-tertiary-container) 0%, var(--md-sys-color-surface-container-high) 100%); border: 1px solid var(--md-sys-color-outline-variant); border-radius: 16px; padding: 16px; display: flex; gap: 12px; align-items: flex-start; transition: all 0.2s ease; }
    .permission-tile:hover { transform: translateY(-3px); box-shadow: var(--md-sys-elevation-level3); border-color: var(--md-sys-color-tertiary); }
    .permission-icon { color: var(--md-sys-color-tertiary); font-size: 24px; }
    .permission-name { font: var(--md-sys-typescale-body-large-font); color: var(--md-sys-color-on-surface); margin-bottom: 4px; font-weight: 500; }
    .permission-code { font: var(--md-sys-typescale-label-small-font); color: var(--md-sys-color-on-surface-variant); text-transform: uppercase; letter-spacing: 0.08em; }

    .flash-messages { margin-bottom: 16px; }
    .flash-message { padding: 12px 16px; border-radius: 12px; margin-bottom: 8px; }
    .flash-success { background: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container); }
    .flash-error { background: var(--md-sys-color-error-container); color: var(--md-sys-color-on-error-container); }
    .flash-warning { background: var(--md-sys-color-tertiary-container); color: var(--md-sys-color-on-tertiary-container); }
    .flash-info { background: var(--md-sys-color-secondary-container); color: var(--md-sys-color-on-secondary-container); }
    
    /* Modal styles */
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; display: none; align-items: center; justify-content: center; }
    .modal.is-active { display: flex; }
    .modal-card { background: var(--md-sys-color-surface); border-radius: 16px; max-width: 500px; width: 90%; max-height: 80vh; overflow: hidden; }
    .modal-card-head { padding: 16px 24px; border-bottom: 1px solid var(--md-sys-color-outline-variant); display: flex; align-items: center; justify-content: space-between; }
    .modal-card-title { font: var(--md-sys-typescale-title-large-font); color: var(--md-sys-color-on-surface); }
    .modal-card-body { padding: 24px; max-height: 60vh; overflow-y: auto; }
    .modal-card-foot { padding: 16px 24px; border-top: 1px solid var(--md-sys-color-outline-variant); display: flex; gap: 8px; justify-content: flex-end; }
    .delete { background: none; border: none; cursor: pointer; color: var(--md-sys-color-on-surface-variant); }
    
    .cropper-image { max-width: 100%; display: block; margin: auto; }
    .file-input { margin-bottom: 16px; }
    
    /* Save Button */
    .save-button-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 10;
    }
    
    .fab-save {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: linear-gradient(135deg, #6750A4 0%, #7E57C2 100%);
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 16px rgba(103, 80, 164, 0.4);
      transition: all 0.3s ease;
    }
    
    .fab-save:hover {
      transform: scale(1.1) rotate(10deg);
      box-shadow: 0 6px 24px rgba(103, 80, 164, 0.6);
    }
    
    .fab-save .material-symbols-outlined {
      font-size: 32px;
    }
    
    /* Chat-Widget ausblenden */
    #md3-livechat-toggle,
    #md3-livechat-slidein {
      display: none !important;
    }
    
    /* Edit Modal */
    .edit-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .edit-modal.active {
      display: flex;
    }
    
    .edit-modal-content {
      background: white;
      border-radius: 24px;
      padding: 32px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      animation: fadeInUp 0.3s ease;
    }
    
    .edit-modal-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
    }
    
    .edit-modal-icon {
      color: var(--md-sys-color-primary);
      font-size: 28px;
    }
    
    .edit-modal-title {
      font: var(--md-sys-typescale-headline-small-font);
      color: var(--md-sys-color-on-surface);
    }
    
    .edit-modal-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .edit-input {
      width: 100%;
      padding: 14px 16px;
      font-size: 16px;
      border: 2px solid var(--md-sys-color-outline-variant);
      border-radius: 12px;
      outline: none;
      transition: all 0.2s ease;
      box-sizing: border-box;
    }
    
    .edit-input:focus {
      border-color: var(--md-sys-color-primary);
      box-shadow: 0 0 0 4px rgba(103, 80, 164, 0.1);
    }
    
    .edit-modal-buttons {
      display: flex;
      gap: 12px;
      margin-top: 8px;
    }
    
    .edit-btn {
      flex: 1;
      padding: 14px;
      border-radius: 999px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s ease;
      border: none;
    }
    
    .edit-btn-cancel {
      background: var(--md-sys-color-surface-container);
      color: var(--md-sys-color-on-surface);
    }
    
    .edit-btn-save {
      background: linear-gradient(135deg, var(--md-sys-color-primary) 0%, #8A6EBB 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(103, 80, 164, 0.3);
    }
    
    .edit-btn:hover {
      opacity: 0.9;
    }
    
    @media (max-width: 768px) {
      .profile-hero { padding: 40px 16px 60px; }
      .avatar-blob { width: 150px; height: 150px; }
      .profile-hero-name { font-size: 28px; }
      .profile-content { padding: 0 16px 40px; }
      .accordion-header { padding: 16px 20px; }
      .accordion-title { font-size: 18px; }
      .permission-grid { grid-template-columns: 1fr; }
      .save-button-container { bottom: 16px; right: 16px; }
      .fab-save { width: 56px; height: 56px; }
    }
  </style>
{% endblock %}

{% block content %}
  {% include 'md3-nav.html' %}
  
  <div class="md3-page">
    <!-- Hero Section mit Avatar -->
    <div class="profile-hero">
      <div class="profile-avatar-container">
        <div class="avatar-blob" id="profileImage">
          {% if user.profile_image and image_exists %}
            <img src="{{ url_for('test_serve_profile_image', filename=user.profile_image) }}?v={{ cache_buster }}" class="avatar-image" alt="Profilbild">
          {% else %}
            <img src="https://ui-avatars.com/api/?name={{ avatar_name|urlencode }}&background=6750A4&color=fff&size=180" class="avatar-image" alt="Profilbild">
          {% endif %}
        </div>
        
        <h1 class="profile-hero-name">
          {{ user.vorname or user.username }}{% if user.nachname %} {{ user.nachname }}{% endif %}
        </h1>
        
        <p class="profile-hero-username">@{{ user.username }}</p>
        
        {% if current_user.role %}
          <div class="profile-hero-role">
            <span class="material-symbols-outlined">workspace_premium</span>
            {{ current_user.role.name }}
          </div>
        {% endif %}
      </div>
    </div>
    
    <!-- Content mit Accordions -->
    <div class="profile-content">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="flash-messages">
            {% for category, message in messages %}
              <div class="flash-message flash-{{ category }}">
                {{ message|safe }}
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}
      
      <!-- Kontakt Accordion -->
      <div class="accordion-section active">
        <div class="accordion-header" onclick="toggleAccordion(this)">
          <div class="accordion-header-content">
            <span class="material-symbols-outlined accordion-icon">contact_mail</span>
            <h3 class="accordion-title">Kontaktinformationen</h3>
          </div>
          <span class="material-symbols-outlined accordion-chevron">expand_more</span>
        </div>
        <div class="accordion-body">
          <div class="accordion-content">
            <div class="info-item">
              <span class="material-symbols-outlined info-item-icon">alternate_email</span>
              <div class="info-item-content">
                <div class="info-item-label">E-Mail</div>
                <div class="info-item-value">{{ user.email or 'Nicht angegeben' }}</div>
              </div>
            </div>
            <div class="info-item">
              <span class="material-symbols-outlined info-item-icon">call</span>
              <div class="info-item-content">
                <div class="info-item-label">Telefon</div>
                <div class="info-item-value">{{ user.phone or 'Nicht angegeben' }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Adresse Accordion -->
      <div class="accordion-section">
        <div class="accordion-header" onclick="toggleAccordion(this)">
          <div class="accordion-header-content">
            <span class="material-symbols-outlined accordion-icon">home</span>
            <h3 class="accordion-title">Adresse</h3>
          </div>
          <span class="material-symbols-outlined accordion-chevron">expand_more</span>
        </div>
        <div class="accordion-body">
          <div class="accordion-content">
            <div class="info-item">
              <span class="material-symbols-outlined info-item-icon">signpost</span>
              <div class="info-item-content">
                <div class="info-item-label">Straße</div>
                <div class="info-item-value">{{ user.street or 'Nicht angegeben' }}</div>
              </div>
            </div>
            <div class="info-item">
              <span class="material-symbols-outlined info-item-icon">location_city</span>
              <div class="info-item-content">
                <div class="info-item-label">PLZ & Stadt</div>
                <div class="info-item-value">{{ user.postal_code or '' }}{% if user.city %} {{ user.city }}{% else %}Nicht angegeben{% endif %}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Berechtigungen Accordion -->
      {% if current_user.role and current_user.role.permissions %}
      <div class="accordion-section">
        <div class="accordion-header" onclick="toggleAccordion(this)">
          <div class="accordion-header-content">
            <span class="material-symbols-outlined accordion-icon">security</span>
            <h3 class="accordion-title">Berechtigungen</h3>
          </div>
          <span class="material-symbols-outlined accordion-chevron">expand_more</span>
        </div>
        <div class="accordion-body">
          <div class="accordion-content">
            <div class="permission-grid">
              {% for perm in current_user.role.permissions|sort(attribute='description') %}
                <div class="permission-tile">
                  <span class="material-symbols-outlined permission-icon">verified</span>
                  <div>
                    <div class="permission-name">{{ perm.description or perm.name }}</div>
                    <div class="permission-code">{{ perm.name }}</div>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
    
    <!-- Floating Save Button -->
    <form method="POST" enctype="multipart/form-data" id="profileForm">
      {{ form.hidden_tag() }}
      <input type="hidden" name="cropped_image_data" id="croppedImageData">
      <input type="hidden" name="delete_image_flag" id="deleteImageFlag" value="">
      <input type="hidden" name="md3" value="1">
      <input type="hidden" name="vorname" value="{{ user.vorname or '' }}">
      <input type="hidden" name="nachname" value="{{ user.nachname or '' }}">
      <input type="hidden" name="email" value="{{ user.email or '' }}">
      <input type="hidden" name="street" value="{{ user.street or '' }}">
      <input type="hidden" name="postal_code" value="{{ user.postal_code or '' }}">
      <input type="hidden" name="city" value="{{ user.city or '' }}">
      <input type="hidden" name="phone" value="{{ user.phone or '' }}">
      
      <div class="save-button-container">
        <button type="submit" class="fab-save" title="Profil speichern">
          <span class="material-symbols-outlined">save</span>
        </button>
      </div>
    </form>
  </div>

  <!-- Modal für Bildzuschnitt (außerhalb der Container) -->
  <div id="cropperModal" class="modal">
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Profilbild zuschneiden</p>
        <button class="delete" aria-label="close" id="closeCropper">
          <span class="material-symbols-outlined">close</span>
        </button>
      </header>
      <section class="modal-card-body">
        <input type="file" id="modalFileInput" accept="image/*" class="form-input file-input">
        <img id="cropperImage" src="" class="cropper-image">
      </section>
      <footer class="modal-card-foot">
        <button class="md3-button md3-button-outlined" id="resetCropper">Reset</button>
        <button class="md3-button md3-button-text" id="deleteImage">
          <span class="material-symbols-outlined">delete</span>
          Bild löschen
        </button>
        <button class="md3-button md3-button-tonal" id="cancelCropper">Abbrechen</button>
        <button class="md3-button md3-button-filled" id="saveCropped">
          <span class="material-symbols-outlined">check</span>
          Übernehmen
        </button>
      </footer>
    </div>
  </div>

  <!-- Edit Modal für Kontaktdaten -->
  <div id="editModal" class="edit-modal">
    <div class="edit-modal-content">
      <div class="edit-modal-header">
        <span class="material-symbols-outlined edit-modal-icon" id="editModalIcon">edit</span>
        <h3 class="edit-modal-title" id="editModalTitle">Feld bearbeiten</h3>
      </div>
      <div class="edit-modal-form">
        <input type="text" id="editInput" class="edit-input" placeholder="Wert eingeben">
        <div class="edit-modal-buttons">
          <button class="edit-btn edit-btn-cancel" id="editCancel">Abbrechen</button>
          <button class="edit-btn edit-btn-save" id="editSave">Speichern</button>
        </div>
      </div>
    </div>
  </div>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  <script>
    // Accordion Toggle Function
    function toggleAccordion(header) {
      const section = header.parentElement;
      const wasActive = section.classList.contains('active');
      
      // Optional: Close all other accordions
      // document.querySelectorAll('.accordion-section').forEach(s => s.classList.remove('active'));
      
      if (wasActive) {
        section.classList.remove('active');
      } else {
        section.classList.add('active');
      }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
      let cropper;
      const profileImage = document.getElementById('profileImage');
      const cropperModal = document.getElementById('cropperModal');
      const cropperImage = document.getElementById('cropperImage');
      const closeCropper = document.getElementById('closeCropper');
      const cancelCropper = document.getElementById('cancelCropper');
      const saveCropped = document.getElementById('saveCropped');
      const resetCropper = document.getElementById('resetCropper');
      const deleteImage = document.getElementById('deleteImage');
      const modalFileInput = document.getElementById('modalFileInput');

    if(profileImage) {
      profileImage.onclick = function() {
        cropperModal.classList.add('is-active');
        const avatarImg = profileImage.querySelector('.avatar-image');
        const previewData = document.getElementById('croppedImageData').value;
        if (previewData && previewData.startsWith('data:image/')) {
          cropperImage.src = previewData;
        } else if (avatarImg && avatarImg.src) {
          cropperImage.src = avatarImg.src;
        } else {
          cropperImage.src = '';
        }
        if(cropper) cropper.destroy();
        cropperImage.onload = function() {
          if(cropper) cropper.destroy();
          if (cropperImage.src) {
            cropper = new Cropper(cropperImage, {
              aspectRatio: 1,
              viewMode: 1,
              background: false,
              movable: true,
              zoomable: true,
              rotatable: false,
              scalable: false
            });
          }
        };
      };
    }

    if(modalFileInput) {
      modalFileInput.addEventListener('change', function(e) {
        if(modalFileInput.files && modalFileInput.files[0]) {
          const reader = new FileReader();
          reader.onload = function(evt) {
            cropperImage.src = evt.target.result;
            if(cropper) cropper.destroy();
            cropper = new Cropper(cropperImage, {
              aspectRatio: 1,
              viewMode: 1,
              background: false,
              movable: true,
              zoomable: true,
              rotatable: false,
              scalable: false
            });
          };
          reader.readAsDataURL(modalFileInput.files[0]);
        }
      });
    }

    function closeModal() {
      cropperModal.classList.remove('is-active');
      if (cropper) { cropper.destroy(); cropper = null; }
    }

    closeCropper.onclick = closeModal;
    cancelCropper.onclick = closeModal;

    saveCropped.onclick = function() {
      if (cropper && cropperImage.src && cropperImage.src.startsWith('data:image/')) {
        const canvas = cropper.getCroppedCanvas({ width: 240, height: 240 });
        const dataUrl = canvas.toDataURL('image/png');
        const avatarImg = profileImage ? profileImage.querySelector('.avatar-image') : null;
        if(avatarImg) avatarImg.src = dataUrl;
        document.getElementById('croppedImageData').value = dataUrl;
        document.getElementById('deleteImageFlag').value = '';
        closeModal();
      } else {
        alert('Bitte lade zuerst ein Bild hoch!');
      }
    };

    if(deleteImage) {
      deleteImage.onclick = function() {
        const avatarImg = profileImage ? profileImage.querySelector('.avatar-image') : null;
        const fallbackUrl = "https://ui-avatars.com/api/?name={{ avatar_name|urlencode }}&background=6750A4&color=fff&size=180";
        if(avatarImg) avatarImg.src = fallbackUrl;
        cropperImage.src = fallbackUrl;
        document.getElementById('croppedImageData').value = '';
        document.getElementById('deleteImageFlag').value = '1';
        if(cropper) cropper.destroy();
        closeModal();
      };
    }

    if(resetCropper) {
      resetCropper.onclick = function() {
        const previewData = document.getElementById('croppedImageData').value;
        if (previewData && previewData.startsWith('data:image/')) {
          cropperImage.src = previewData;
        } else if (profileImage && profileImage.src) {
          cropperImage.src = profileImage.src;
        }
        if(cropper) cropper.destroy();
      };
    }

    closeCropper.onclick = closeModal;
    cancelCropper.onclick = closeModal;

    // Edit Modal Funktionalität
    const editModal = document.getElementById('editModal');
    const editModalTitle = document.getElementById('editModalTitle');
    const editModalIcon = document.getElementById('editModalIcon');
    const editInput = document.getElementById('editInput');
    const editCancel = document.getElementById('editCancel');
    const editSave = document.getElementById('editSave');
    let currentEditField = null;
    let currentEditElement = null;
    
    // Alle info-items klickbar machen
    document.querySelectorAll('.info-item').forEach(item => {
      item.addEventListener('click', function() {
        const label = this.querySelector('.info-item-label').textContent;
        const value = this.querySelector('.info-item-value');
        const icon = this.querySelector('.info-item-icon').textContent;
        const currentValue = value.textContent.trim();
        
        // Welches Feld wird bearbeitet?
        if (label === 'E-Mail') currentEditField = 'email';
        else if (label === 'Telefon') currentEditField = 'phone';
        else if (label === 'Straße') currentEditField = 'street';
        else if (label === 'PLZ & Stadt') currentEditField = 'postal_code_city';
        else return; // Andere Felder ignorieren
        
        currentEditElement = value;
        editModalTitle.textContent = label + ' bearbeiten';
        editModalIcon.textContent = icon;
        editInput.value = currentValue === 'Nicht angegeben' ? '' : currentValue;
        editModal.classList.add('active');
        editInput.focus();
      });
    });
    
    // Modal schließen
    editCancel.addEventListener('click', () => {
      editModal.classList.remove('active');
      currentEditField = null;
      currentEditElement = null;
    });
    
    // Bei Klick außerhalb schließen
    editModal.addEventListener('click', (e) => {
      if (e.target === editModal) {
        editModal.classList.remove('active');
        currentEditField = null;
        currentEditElement = null;
      }
    });
    
    // Speichern
    editSave.addEventListener('click', () => {
      const newValue = editInput.value.trim();
      if (currentEditElement && currentEditField) {
        // Wert im UI updaten
        currentEditElement.textContent = newValue || 'Nicht angegeben';
        
        // Wert im Hidden-Form-Field updaten
        if (currentEditField === 'postal_code_city') {
          // Spezialfall: PLZ & Stadt aufteilen
          const parts = newValue.split(' ', 2);
          const postalCode = parts[0] || '';
          const city = parts.slice(1).join(' ') || '';
          document.querySelector('input[name="postal_code"]').value = postalCode;
          document.querySelector('input[name="city"]').value = city;
        } else {
          const hiddenField = document.querySelector(`input[name="${currentEditField}"]`);
          if (hiddenField) hiddenField.value = newValue;
        }
        
        // Modal schließen
        editModal.classList.remove('active');
        currentEditField = null;
        currentEditElement = null;
      }
    });
    
    // Enter-Taste zum Speichern
    editInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        editSave.click();
      }
    });

    }); // Ende DOMContentLoaded
  </script>
{% endblock %}
