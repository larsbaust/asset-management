{% extends "base.html" %}

{% block head %}

<!-- Google Maps Styling -->
<style>
  .md3-map-info-window {
    font-family: var(--md-sys-typescale-body-medium-font-family);
    color: var(--md-sys-color-on-surface);
    max-width: 300px;
    padding: 8px 0;
  }
  .md3-map-info-title {
    margin: 0 0 8px 0; 
    color: var(--md-sys-color-primary); 
    font-family: var(--md-sys-typescale-title-medium-font-family);
    font-weight: 500;
  }
  .md3-map-info-address {
    margin: 0; 
    color: var(--md-sys-color-on-surface-variant);
  }
  .md3-map-info-count {
    margin-top: 8px;
  }
  .md3-map-info-count span {
    color: var(--md-sys-color-primary);
    font-weight: 500;
  }

  /* Google Maps Container Styling */
  #location-map {
    height: 340px;
    min-height: 340px;
    width: 100%;
    border-radius: 16px;
    overflow: hidden;
  }
  
  /* Loading Indikator */
  .map-loading {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100%;
    font-family: var(--md-sys-typescale-body-medium-font-family);
    color: var(--md-sys-color-on-surface-variant);
  }

  /* MD3 Styled Map Controls */
  .gm-style .gm-style-iw-c {
    padding: 12px !important;
    box-shadow: var(--md-sys-elevation-3) !important;
    border-radius: 16px !important;
  }
</style>
{{ super() }}
{% endblock %}

{% block content %}
<!-- MD3 Navigation einbinden -->
{% include 'md3-nav.html' %}

<!-- Dashboard Header mit Karte -->
<div class="md-dashboard-header">
  <div class="md-dashboard-header-content">
    <!-- Kompakte Standorte-Karte im Header -->
    <div class="md-dashboard-map-header">
      <!-- Style für die Karte, um unerwünschte Labels zu verstecken -->
      <style>
        /* Spezifische CSS-Regel für den Karten-Header */
        #map-card .md-card-header span {
          display: none !important; /* Versteckt alle spans im Header */
        }
        
        /* Falls es sich um ein anderes Element handelt */
        #map-card .md-card-header *:not(.md-card-title) {
          display: none !important; /* Versteckt alle Elemente außer dem Titel */
        }
      </style>
      
      {% set card_content %}
        <!-- Karten-Container mit MD3-Styling -->
        <div id="location-map" style="height: 340px; width: 100%; border-radius: var(--md-sys-shape-corner-medium); position: relative; overflow: hidden; display: block;"></div>
        <!-- Fallback falls Karte nicht geladen werden kann -->
        <div id="map-loading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; display: none;">
          <div style="color: var(--md-sys-color-primary); font-family: var(--md-sys-typescale-body-medium-font-family);">Karte wird geladen...</div>
        </div>
        
        <!-- MD3 Google Maps Styling -->
        <script>
        // MD3-kompatible Google Maps Stilvorlage
        window.md3MapStyles = [
          {
            "elementType": "geometry",
            "stylers": [
              {
                "color": "#f2f0f7" // MD3 Surface Container
              }
            ]
          },
          {
            "elementType": "labels.icon",
            "stylers": [
              {
                "visibility": "off"
              }
            ]
          },
          {
            "elementType": "labels.text.fill",
            "stylers": [
              {
                "color": "#615f6c" // MD3 On Surface Variant
              }
            ]
          },
          {
            "elementType": "labels.text.stroke",
            "stylers": [
              {
                "color": "#faf9fd" // MD3 Surface
              }
            ]
          },
          {
            "featureType": "administrative.land_parcel",
            "elementType": "labels",
            "stylers": [
              {
                "visibility": "off"
              }
            ]
          },
          {
            "featureType": "poi",
            "elementType": "labels.text",
            "stylers": [
              {
                "visibility": "off"
              }
            ]
          },
          {
            "featureType": "poi.business",
            "stylers": [
              {
                "visibility": "off"
              }
            ]
          },
          {
            "featureType": "road",
            "elementType": "geometry",
            "stylers": [
              {
                "color": "#e8e4f0" // Sanfteres Grau für Straßen
              }
            ]
          },
          {
            "featureType": "road",
            "elementType": "labels.icon",
            "stylers": [
              {
                "visibility": "off"
              }
            ]
          },
          {
            "featureType": "road.arterial",
            "elementType": "labels.text.fill",
            "stylers": [
              {
                "color": "#9c98a6" // MD3 Outline
              }
            ]
          },
          {
            "featureType": "road.highway",
            "elementType": "geometry",
            "stylers": [
              {
                "color": "#d8c3a5" // Sanfte Beige-Töne
              }
            ]
          },
          {
            "featureType": "road.highway",
            "elementType": "labels.text.fill",
            "stylers": [
              {
                "color": "#8b5a3c"
              }
            ]
          },
          {
            "featureType": "road.local",
            "elementType": "labels.text.fill",
            "stylers": [
              {
                "color": "#9c98a6"
              }
            ]
          },
          {
            "featureType": "transit",
            "elementType": "labels.icon",
            "stylers": [
              {
                "visibility": "off"
              }
            ]
          },
          {
            "featureType": "water",
            "elementType": "geometry",
            "stylers": [
              {
                "color": "#d1becf" // Sanftes Lavendel statt Blau
              }
            ]
          },
          {
            "featureType": "water",
            "elementType": "labels.text.fill",
            "stylers": [
              {
                "color": "#9c98a6"
              }
            ]
          },
          {
            "featureType": "landscape",
            "elementType": "geometry",
            "stylers": [
              {
                "color": "#f9f7fd" // MD3 Surface - sehr sanft
              }
            ]
          },
          {
            "featureType": "landscape.natural",
            "elementType": "geometry",
            "stylers": [
              {
                "color": "#f2f0f7" // Noch sanfter statt grün
              }
            ]
          },
          {
            "featureType": "landscape.natural.landcover",
            "elementType": "geometry",
            "stylers": [
              {
                "color": "#e8e4f0" // Sanftes Grau statt grün
              }
            ]
          },
          {
            "featureType": "landscape.natural.terrain",
            "elementType": "geometry",
            "stylers": [
              {
                "color": "#f2f0f7"
              }
            ]
          },
          {
            "featureType": "administrative",
            "elementType": "geometry.stroke",
            "stylers": [
              {
                "color": "#c3b2cf" // MD3 Outline Variant
              }
            ]
          },
          {
            "featureType": "administrative.country",
            "elementType": "labels.text.fill",
            "stylers": [
              {
                "color": "#a394e0" // MD3 Primary
              }
            ]
          }
        ];
        </script>
      {% endset %}
      
      {% set title = 'Standorte auf der Karte' %}
      {% set elevation = 1 %}
      <div id="map-card">
        {% include 'md3/components/card.html' %}
      </div>
      
      <!-- Google Maps Clean Styling -->
      <style>
        /* Verstecke alle Google Maps Controls und UI-Elemente */
        /* Zoom Controls */
        #location-map .gm-style .gm-style-cc,
        #location-map .gm-style .gm-bundled-control,
        #location-map .gm-style .gm-bundled-control div,
        #location-map .gm-style .gm-style-mtc,
        #location-map .gm-style .gm-style-mtc *,
        /* Map/Satellite Toggle */
        #location-map .gm-style .gm-svpc,
        #location-map .gm-style [data-control-width],
        #location-map .gm-style [data-control-height],
        /* Street View Controls */
        #location-map .gm-style .gm-sv-label,
        #location-map .gm-style .gm-sv-label *,
        /* Keyboard Shortcuts */
        #location-map .gm-style-cc,
        /* Fullscreen Control */
        #location-map .gm-style .gm-fullscreen-control,
        /* Terms of Use / Report a map error */
        #location-map .gmnoprint,
        #location-map .gm-style .gmnoprint,
        #location-map .gm-style-cc a,
        /* Alle Controls in der oberen rechten Ecke */
        #location-map .gm-style > div:first-child > div + div > div:first-child,
        #location-map .gm-style > div:first-child > div + div > div:first-child + div,
        /* Logo und Copyright */
        #location-map .gm-style .gm-style-cc div,
        #location-map .gm-style-cc img[src*="google"],
        /* Aktive Labels und sonstige UI */
        #location-map [title*="active"],
        #location-map [aria-label*="active"],
        #location-map [class*="active"],
        /* Sonstige störende Elemente */
        #location-map .gm-style div[style*="position: absolute"][style*="right: 0px"],
        #location-map .gm-style div[style*="position: absolute"][style*="top: 0px"][style*="right"],
        /* Card Header Elemente */
        #map-card .md-card-header:after,
        #map-card .md-card-header [class*="tag"],
        #map-card .md-card-header [class*="button"],
        #map-card .md-card-header > *:not(.md-card-title) {
          display: none !important;
          opacity: 0 !important;
          visibility: hidden !important;
          width: 0 !important;
          height: 0 !important;
          overflow: hidden !important;
          pointer-events: none !important;
        }
        
        /* Sauberes Map Container Styling */
        #location-map {
          border-radius: var(--md-sys-shape-corner-medium);
          overflow: hidden;
          position: relative;
        }
        
        /* Verstecke alle potentiell störenden iFrames und Controls */
        #location-map iframe + div,
        #location-map .gm-style > div:last-child {
          display: none !important;
        }
      </style>
      
      <!-- JavaScript für saubere Google Maps -->
      <script>
        function cleanUpGoogleMaps() {
          console.log('Google Maps Clean-Up wird ausgeführt...');
          
          function removeControls() {
            const mapContainer = document.getElementById('location-map');
            if (!mapContainer) return;
            
            // 1. Alle störenden Controls entfernen
            const selectorsToHide = [
              '.gm-style-cc', '.gm-bundled-control', '.gm-style-mtc', 
              '.gmnoprint', '.gm-fullscreen-control', '.gm-svpc',
              '[data-control-width]', '[data-control-height]',
              '[title*="active"]', '[aria-label*="active"]'
            ];
            
            selectorsToHide.forEach(selector => {
              mapContainer.querySelectorAll(selector).forEach(el => {
                el.style.display = 'none';
                el.style.opacity = '0';
                el.style.visibility = 'hidden';
                el.style.pointerEvents = 'none';
              });
            });
            
            // 2. Controls in der oberen rechten Ecke (der "raue Bereich")
            const topRightControls = mapContainer.querySelectorAll(
              '.gm-style > div:first-child > div + div > div'
            );
            topRightControls.forEach(control => {
              const rect = control.getBoundingClientRect();
              const mapRect = mapContainer.getBoundingClientRect();
              
              // Wenn es in der oberen rechten Ecke ist
              if (rect.right >= mapRect.right - 50 && rect.top <= mapRect.top + 50) {
                control.style.display = 'none !important';
              }
            });
            
            // 3. Alle absolut positionierten Elemente rechts oben
            mapContainer.querySelectorAll('div[style*="position: absolute"]').forEach(el => {
              const style = el.style.cssText;
              if (style.includes('right: 0px') || 
                  (style.includes('right:') && style.includes('top:'))) {
                el.style.display = 'none';
              }
            });
            
            // 4. Text-basierte Entfernung von "active" Labels
            mapContainer.querySelectorAll('*').forEach(el => {
              if (el.textContent && 
                  el.textContent.trim().toLowerCase() === 'active' &&
                  el.offsetParent !== null) {
                el.style.display = 'none';
              }
            });
          }
          
          // Mehrfach ausführen für dynamisch geladene Inhalte
          removeControls();
          setTimeout(removeControls, 100);
          setTimeout(removeControls, 500);
          setTimeout(removeControls, 1000);
          setTimeout(removeControls, 2000);
          
          // Observer für dynamische Änderungen
          const observer = new MutationObserver(removeControls);
          const mapContainer = document.getElementById('location-map');
          if (mapContainer) {
            observer.observe(mapContainer, { 
              childList: true, 
              subtree: true 
            });
          }
        }
        
        // Ausführung bei verschiedenen Events
        document.addEventListener('DOMContentLoaded', cleanUpGoogleMaps);
        window.addEventListener('load', cleanUpGoogleMaps);
        
        // MD3 Map Styling anwenden
        function applyMD3MapStyling() {
          if (window.map && window.md3MapStyles) {
            console.log('Wende MD3 Styling auf Google Maps an...');
            window.map.setOptions({
              styles: window.md3MapStyles,
              mapTypeControl: false,
              streetViewControl: false,
              fullscreenControl: false,
              zoomControl: true,
              zoomControlOptions: {
                position: google.maps.ControlPosition.RIGHT_BOTTOM,
                style: google.maps.ZoomControlStyle.SMALL
              }
            });
            
            // Custom MD3-Marker Style
            if (window.markers && Array.isArray(window.markers)) {
              window.markers.forEach(marker => {
                if (marker.setIcon) {
                  marker.setIcon({
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 8,
                    fillColor: '#a394e0', // MD3 Primary
                    fillOpacity: 0.9,
                    strokeWeight: 2,
                    strokeColor: '#ffffff',
                    strokeOpacity: 1
                  });
                }
              });
            }
          }
        }
        
        // Falls Google Maps callback existiert
        if (window.initMap) {
          const originalInitMap = window.initMap;
          window.initMap = function() {
            originalInitMap.apply(this, arguments);
            setTimeout(() => {
              cleanUpGoogleMaps();
              applyMD3MapStyling();
            }, 500);
          };
        }
        
        // Falls initializeGoogleMapsWhenLoaded existiert
        if (window.initializeGoogleMapsWhenLoaded) {
          const originalInit = window.initializeGoogleMapsWhenLoaded;
          window.initializeGoogleMapsWhenLoaded = function() {
            originalInit.apply(this, arguments);
            setTimeout(() => {
              cleanUpGoogleMaps();
              applyMD3MapStyling();
            }, 1000);
          };
        }
        
        // Observer für Map-Erstellung
        const mapObserver = setInterval(() => {
          if (window.map && window.md3MapStyles) {
            applyMD3MapStyling();
            clearInterval(mapObserver);
          }
        }, 500);
      </script>
      
      <!-- Versteckte Locations-Daten, vom Backend gefüllt -->
      <script type="application/json" id="locations-data">
        {{ locations_json|safe if locations_json else '[]' }}
      </script>
      
      <!-- Tracking-Daten für Lieferungen, vom Backend gefüllt -->
    </div>

    <!-- Standortübersicht -->
    <div class="md-dashboard-grid-half">
      {% set card_content %}
        <div class="md3-location-summary">
          <div class="md3-location-stat">
            {% set value = location_count|default(0) %}
            {% set badge_text = 'Standorte gesamt' %}
            {% set badge_type = 'primary' %}
            {% set id = 'count-locations' %}
            {% set animation_duration = 1500 %}
            {% set icon = 'location_on' %}
            {% include 'md3/components/stat-card.html' %}
          </div>
          <p class="md3-location-hint">Alle aktuell im System angelegten Standorte.</p>
          <a class="md3-location-link" href="{{ url_for('md3_locations') }}">
            <span class="material-symbols-outlined">open_in_new</span>
            Standorte ansehen
          </a>
        </div>
        <style>
          .md3-location-summary {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            text-align: center;
            padding: 12px 0;
          }

          .md3-location-stat {
            display: flex;
            justify-content: center;
            width: 100%;
          }

          .md3-location-hint {
            margin: 0;
            color: var(--md-sys-color-on-surface-variant);
            font-size: 0.9rem;
          }

          .md3-location-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: var(--md-sys-color-primary);
            text-decoration: none;
            font-weight: 500;
          }

          .md3-location-link .material-symbols-outlined {
            font-size: 18px;
          }

          .md3-location-link:hover {
            text-decoration: underline;
          }
        </style>
      {% endset %}
      {% set title = 'Standorte' %}
      {% set elevation = 1 %}
      {% include 'md3/components/card.html' %}
    </div>

    <!-- Standortausschreibungen -->
    <div class="md-dashboard-grid-half">
      {% set card_content %}
        <div class="md3-location-summary">
          <div class="md3-location-stat">
            {% set value = 12 %}  {# TODO: Dummy-Wert, später durch echte Daten ersetzen #}
            {% set badge_text = 'Aktive Ausschreibungen' %}
            {% set badge_type = 'tertiary' %}
            {% set id = 'count-tenders' %}
            {% set animation_duration = 1500 %}
            {% set icon = 'description' %}
            {% include 'md3/components/stat-card.html' %}
          </div>
          <p class="md3-location-hint">Anzahl der laufenden Standortausschreibungen.</p>
          <a class="md3-location-link" href="{{ url_for('main.location_tenders') }}">
            <span class="material-symbols-outlined">open_in_new</span>
            Ausschreibungen ansehen
          </a>
        </div>
      {% endset %}
      {% set title = 'Standortausschreibungen' %}
      {% set elevation = 1 %}
      {% include 'md3/components/card.html' %}
    </div>

    <!-- Standort Budgetierung -->
    <div class="md-dashboard-grid-half">
      {% set card_content %}
        <div class="md3-budget-summary">
          <div class="md3-budget-stats" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; width: 100%;">
            <div class="md3-budget-item">
              <div style="text-align: center;">
                <div style="font-size: 24px; font-weight: 600; color: var(--md-sys-color-primary); margin-bottom: 4px;">
                  <span class="material-symbols-outlined" style="font-size: 20px; vertical-align: middle;">euro</span>
                  <span id="budget-per-location">8.500</span>
                </div>
                <div style="font-size: 12px; color: var(--md-sys-color-on-surface-variant); text-transform: uppercase; letter-spacing: 0.5px;">
                  Ø pro Standort
                </div>
              </div>
            </div>
            <div class="md3-budget-item">
              <div style="text-align: center;">
                <div style="font-size: 24px; font-weight: 600; color: var(--md-sys-color-secondary); margin-bottom: 4px;">
                  <span class="material-symbols-outlined" style="font-size: 20px; vertical-align: middle;">account_balance</span>
                  <span id="budget-total">42.500</span>
                </div>
                <div style="font-size: 12px; color: var(--md-sys-color-on-surface-variant); text-transform: uppercase; letter-spacing: 0.5px;">
                  Gesamtbudget
                </div>
              </div>
            </div>
          </div>
          <p class="md3-location-hint" style="margin-top: 16px;">Geplante Budgetierung für alle Standorte (in €).</p>
          <div style="text-align: center; margin-top: 8px; font-size: 11px; color: var(--md-sys-color-outline); font-style: italic;">
            Dummy-Daten • In Entwicklung
          </div>
        </div>
        <style>
          .md3-budget-summary {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 0;
          }
          
          .md3-budget-item {
            background: var(--md-sys-color-surface-container);
            border-radius: 12px;
            padding: 16px;
          }
        </style>
      {% endset %}
      {% set title = 'Standort Budgetierung' %}
      {% set elevation = 1 %}
      {% include 'md3/components/card.html' %}
    </div>

    <!-- Status der Assets -->
    {% if has_permission(current_user, 'view_chart_asset_status') %}
      <div class="md-dashboard-grid-half">
        {% set card_content %}
          <!-- Asset Status -->
      <div class="row mb-4">
        <div class="col-12">
          <!-- Titel wird über card.html gesetzt -->
        </div>
        <div class="col-12">
          <div class="md-chart-container">
            <div class="md3-stat-cards-container">
            <div class="md3-stat-card-horizontal">
              {% set value = asset_counts.active if asset_counts else '0' %}
              {% set badge_text = 'Aktiv' %}
              {% set badge_type = 'success' %}
              {% set id = 'count-active' %}
              {% set animation_duration = 1500 %}
              {% set icon = 'check_circle' %}
              {% include 'md3/components/stat-card.html' %}
            </div>
            <div class="md3-stat-card-horizontal">
              {% set value = asset_counts.on_loan if asset_counts else '0' %}
              {% set badge_text = 'Ausgeliehen' %}
              {% set badge_type = 'secondary' %}
              {% set id = 'count-borrowed' %}
              {% set animation_duration = 1500 %}
              {% set icon = 'sync' %}
              {% include 'md3/components/stat-card.html' %}
            </div>
            <div class="md3-stat-card-horizontal">
              {% set value = asset_counts.inactive if asset_counts else '0' %}
              {% set badge_text = 'Inaktiv' %}
              {% set badge_type = 'neutral' %}
              {% set id = 'count-inactive' %}
              {% set animation_duration = 1500 %}
              {% set icon = 'block' %}
              {% include 'md3/components/stat-card.html' %}
            </div>
          </div>
          </div>
        </div>
      </div>
      
      <style>
        /* Horizontales Layout für Asset Status Cards */
        .md3-stat-cards-container {
          display: flex;
          flex-direction: row;
          justify-content: center;
          align-items: center;
          gap: 40px;
          margin: 0 auto 20px auto;
          max-width: 600px;
          text-align: center;
        }
        
        .md3-stat-card-horizontal {
          flex: 1;
          display: flex;
          justify-content: center;
          padding: 10px;
          text-align: center;
        }
        
        /* Zentrieren der Zahlen und Labels innerhalb der Stat Cards */
        .md3-stat-card {
          margin: 0 auto;
        }
        
        @media (max-width: 768px) {
          .md3-stat-cards-container {
            flex-direction: column;
            gap: 15px;
          }
          
          .md3-stat-card-horizontal {
            width: 100%;
          }
        }
      </style>
      
      <style>
        /* Asset Status Card-Styling */
        .md3-stat-card-wrapper {
          margin: 0 auto;
          max-width: 190px;
        }
        
        /* Farben für die Stat Icons */
        .md-stat-icon-success .material-symbols-outlined {
          color: var(--md-sys-color-tertiary);
        }
        
        .md-stat-icon-secondary .material-symbols-outlined {
          color: var(--md-sys-color-secondary);
        }
        
        .md-stat-icon-primary .material-symbols-outlined {
          color: var(--md-sys-color-primary);
        }
        
        .md-stat-icon-neutral .material-symbols-outlined {
          color: var(--md-sys-color-outline);
        }
        
        .md-stat-icon-warning .material-symbols-outlined {
          color: var(--md-sys-color-error-container);
        }
        
        .md-stat-icon-error .material-symbols-outlined {
          color: var(--md-sys-color-error);
        }
      </style>
          </div>
        {% endset %}
        
        {% set title = 'Asset Status' %}
        {% set elevation = 1 %}
        {% include 'md3/components/card.html' %}
      </div>
    {% endif %}

    <!-- Kostenverteilung (MD3 Style) -->
    {% if has_permission(current_user, 'view_chart_cost_distribution') %}
      <div class="md-dashboard-grid-third" style="position: relative; z-index: 1; overflow: visible;">
        <!-- Hier wird die chart-card.html Komponente verwendet -->
        {% set title = 'Kostenverteilung' %}
        {% set canvas_id = 'costChart' %}
        {% set height = '300px' %}
        {% set circle_chart = true %}
        {% include 'md3/components/chart-card.html' %}
        
        <!-- Hidden data fallback -->
        <script type="application/json" id="cost-chart-fallback-data">
          {"cost_distribution": {"labels": [], "data": []}}
        </script>
      </div>
    {% endif %}

    <!-- Wertentwicklung (MD3 Style) -->
    <style>
  /* Direkte CSS-Überschreibung für die Chart-Füllung */
  canvas#valueChart {
    --chart-fill-color: rgba(232, 222, 248, 0.3);
  }
  /* Spezifischer Selektor für die Chart.js Füllung */
  .chartjs-fill-area {
    fill: rgba(232, 222, 248, 0.3) !important;
  }
  
  /* MD3 Loading Indicator Styling */
  .md3-loading-container {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background-color: var(--md-sys-color-surface);
    z-index: 5;
    border-radius: var(--md-sys-shape-corner-medium);
    transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
  }
  
  .md3-loading-container.hidden {
    opacity: 0 !important;
    visibility: hidden !important;
    display: none !important;
  }
  
  .md3-loading-text {
    margin-top: 16px;
    font-family: var(--md-sys-typescale-body-medium-font-family-name);
    font-size: var(--md-sys-typescale-body-medium-font-size);
    color: var(--md-sys-color-on-surface-variant);
  }
  
  /* MD3 Spinner Styling */
  .md3-spinner {
    position: relative;
    width: 48px;
    height: 48px;
  }
  
  .md3-spinner-circle {
    position: absolute;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    border: 4px solid transparent;
    border-top-color: var(--md-sys-color-primary);
    animation: md3-spinner-rotate 1.2s cubic-bezier(0.4, 0, 0.2, 1) infinite;
  }
  
  .md3-spinner-circle-2 {
    border-top-color: var(--md-sys-color-tertiary);
    animation-delay: 0.3s;
  }
  
  .md3-spinner-circle-3 {
    border-top-color: var(--md-sys-color-secondary);
    animation-delay: 0.6s;
  }
  
  .md3-spinner-circle-4 {
    border-top-color: var(--md-sys-color-error);
    animation-delay: 0.9s;
  }
  
  @keyframes md3-spinner-rotate {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>
    <div id="value-chart-container" class="md-dashboard-grid-item md-dashboard-grid-wide" style="position: relative; z-index: 1; overflow: visible;">
      
      <!-- Hier wird die chart-card.html Komponente verwendet -->
      {% set title = 'Wertentwicklung' %}
      {% set canvas_id = 'valueChart' %}
      {% set height = '300px' %}
      {% set circle_chart = false %}
      {% include 'md3/components/chart-card.html' %}
      
      
      <!-- Chart Animation Styling -->
      <style>
        /* Enhanced Chart Animations */
        #valueChart {
          animation: chartFadeIn 0.6s ease-out;
        }
        
        @keyframes chartFadeIn {
          from {
            opacity: 0;
            transform: translateY(20px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }
        
        /* Canvas hover effects */
        .md-chart-container canvas {
          transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
      </style>
      
      
      
      <!-- Hidden data fallback -->
      <script type="application/json" id="value-chart-fallback-data">
        {"value_development": {"labels": ["Jan", "Feb", "März", "Apr", "Mai", "Jun", "Jul", "Aug", "Sep", "Okt", "Nov", "Dez"], "data": [120000, 118000, 125000, 132000, 130000, 135000, 142000, 148000, 152000, 149000, 155000, 160000]}}
      </script>
    </div>
        
<!-- Chart Initialization Script (extern) -->
<script src="{{ url_for('static', filename='md3/components/dashboard-charts.js') }}" defer></script>

<!-- Ende der Chart-Komponente -->
      </div>

    <!-- Wertentwicklung Chart wurde entfernt, um Duplikate zu vermeiden. Bereits vorhanden in "Wertentwicklung (MD3 Style)" oben -->

    <!-- Abteilungsverteilung -->
    {% if has_permission(current_user, 'view_chart_department_distribution') %}
      <div class="md-dashboard-grid-third">
        {% set title = 'Abteilungsverteilung' %}
        {% set canvas_id = 'deptChart' %}
        {% set height = '300px' %}
        {% set full_width = true %}
        {% set circle_chart = true %}
        {% include 'md3/components/chart-card.html' %}
      </div>
    {% endif %}

    <!-- Auslastung nach Monaten -->
    {% if has_permission(current_user, 'view_chart_monthly_usage') %}
      <div class="md-dashboard-grid-item md-dashboard-grid-wide">
        {% set title = 'Auslastung nach Monaten' %}
        {% set canvas_id = 'usageChart' %}
        {% set height = '300px' %}
        {% set full_width = true %}
        {% set circle_chart = false %}
        {% include 'md3/components/chart-card.html' %}
      </div>
    {% endif %}


    
    <!-- Assets nach Kategorie und Zuordnung -->
    <div class="md-dashboard-grid-item md-dashboard-grid-wide">
      {% set title = 'Assets nach Kategorie und Zuordnung' %}
      {% set canvas_id = 'categoryAssignmentChart' %}
      {% set height = '300px' %}
      {% set full_width = true %}
      {% set circle_chart = false %}
      {% include 'md3/components/chart-card.html' %}
    </div>
    
    <!-- Assets nach Hersteller -->
    <div class="md-dashboard-grid-third">
      {% set title = 'Assets nach Hersteller' %}
      {% set canvas_id = 'manufacturerChart' %}
      {% set height = '400px' %}
      {% set full_width = true %}
      {% set circle_chart = false %}
      {% include 'md3/components/chart-card.html' %}
    </div>
    
    <!-- Standorte mit laufender Lieferung -->
    <div class="md-dashboard-grid-third">
      {% set title = 'Standorte mit laufender Lieferung' %}
      {% set canvas_id = 'deliveryChart' %}
      {% set height = '300px' %}
      {% set full_width = true %}
      {% set circle_chart = true %}
      {% include 'md3/components/chart-card.html' %}
      
      <!-- Zusätzliche Statistiken für Lieferungen -->
      <div class="md3-delivery-stats">
        <div class="md3-delivery-stat-item">
          <span class="md3-delivery-count" id="deliveries-in-transit">0</span>
          <span class="md3-delivery-label">In Transport</span>
        </div>
        <div class="md3-delivery-stat-item">
          <span class="md3-delivery-count" id="deliveries-delivered">0</span>
          <span class="md3-delivery-label">Geliefert</span>
        </div>
        <div class="md3-delivery-stat-item">
          <span class="md3-delivery-count" id="deliveries-pending">0</span>
          <span class="md3-delivery-label">Ausstehend</span>
        </div>
      </div>
      
      <style>
        .md3-delivery-stats {
          display: flex;
          justify-content: space-around;
          margin-top: 1rem;
          padding: 1rem;
        }
        .md3-delivery-stat-item {
          display: flex;
          flex-direction: column;
          align-items: center;
        }
        .md3-delivery-count {
          font-family: var(--md-sys-typescale-headline-medium-font-family);
          font-size: var(--md-sys-typescale-headline-medium-font-size);
          font-weight: var(--md-sys-typescale-headline-medium-font-weight);
          color: var(--md-sys-color-primary);
        }
        .md3-delivery-label {
          font-family: var(--md-sys-typescale-body-medium-font-family);
          font-size: var(--md-sys-typescale-body-medium-font-size);
          color: var(--md-sys-color-on-surface-variant);
          margin-top: 0.25rem;
        }
      </style>
    </div>

    <!-- Letzte Assets -->
    <div class="md-dashboard-grid-item md-dashboard-grid-wide">
      {% set card_content %}
        {% set table_content %}
          {% for asset in latest_assets %}
          <tr class="md3-asset-row">
            <td class="md3-asset-id">{{ asset.asset_id }}</td>
            <td class="md3-asset-name">{{ asset.name }}</td>
            <td class="md3-asset-category">
              {% set category_text = asset.category|replace('<Category Lizenz>', 'Lizenz')|replace('<Category', '')|replace('>', '') %}
              <span class="md3-category-chip">
                <span class="md3-category-icon material-symbols-outlined">
                  {% if 'Lizenz' in category_text %}
                    key
                  {% elif 'Server' in category_text %}
                    dns
                  {% elif 'Hardware' in category_text %}
                    memory
                  {% elif 'Software' in category_text %}
                    apps
                  {% elif 'Netzwerk' in category_text %}
                    router
                  {% else %}
                    category
                  {% endif %}
                </span>
                <span class="md3-category-text">{{ category_text }}</span>
              </span>
            </td>
            <td class="md3-asset-status">
              <div class="md3-status-indicator {% if asset.status|lower == 'active' %}md3-status-active{% else %}md3-status-inactive{% endif %}">
                <span class="md3-status-icon material-symbols-outlined">
                  {% if asset.status|lower == 'active' %}check_circle{% else %}cancel{% endif %}
                </span>
                <span class="md3-status-text">
                  {% if asset.status|lower == 'active' %}Aktiv
                  {% elif asset.status|lower == 'inactive' %}Inaktiv
                  {% elif asset.status|lower == 'on_loan' %}Ausgeliehen
                  {% elif asset.status|lower == 'maintenance' %}Wartung
                  {% elif asset.status|lower == 'retired' %}Ausgemustert
                  {% else %}Inaktiv{% endif %}
                </span>
              </div>
            </td>
            <td class="md3-asset-date">{{ asset.updated_at.strftime('%d.%m.%Y') }}</td>
          </tr>
          {% endfor %}
        {% endset %}
        
        {% set headers = ['Asset-ID', 'Name', 'Kategorie', 'Status', 'Letztes Update'] %}
        {% set responsive = true %}
        {% set hover = true %}
        {% set zebra = true %}
        {% include 'md3/components/table.html' %}
        
        <style>
          /* MD3-Styling für Asset-Tabelle */
          .md3-asset-row {
            transition: background-color 0.2s ease;
          }
          
          .md3-asset-id {
            font-family: var(--md-sys-typescale-label-medium-font-family);
            font-size: var(--md-sys-typescale-label-medium-font-size);
            color: var(--md-sys-color-on-surface-variant);
            width: 80px;
          }
          
          .md3-asset-name {
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
          }
          
          .md3-category-chip {
            display: inline-flex;
            align-items: center;
            background-color: var(--md-sys-color-surface-container-highest);
            border-radius: 12px;
            padding: 2px 8px;
            border: 1px solid var(--md-sys-color-outline);
            box-shadow: var(--md-sys-elevation-level0);
          }
          
          .md3-category-icon {
            font-size: 14px;
            margin-right: 4px;
            color: var(--md-sys-color-primary);
            font-variation-settings: 'FILL' 0, 'wght' 300;
          }
          
          .md3-category-text {
            font-family: var(--md-sys-typescale-label-small-font-family);
            font-size: var(--md-sys-typescale-label-small-font-size);
            font-weight: 400;
            color: var(--md-sys-color-on-surface);
            letter-spacing: 0.1px;
          }
          
          .md3-asset-status {
            width: 100px;
            text-align: center;
          }
          
          /* MD3 Status-Indikator Styling */
          .md3-status-indicator {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 12px;
            background-color: var(--md-sys-color-surface-container-highest);
            min-width: 60px;
            justify-content: center;
            border: 1px solid var(--md-sys-color-outline);
            box-shadow: var(--md-sys-elevation-level0);
            transition: all 0.2s ease;
          }
          
          .md3-status-active {
            background-color: var(--md-sys-color-primary-container);
            border-color: var(--md-sys-color-outline);
          }
          
          .md3-status-inactive {
            background-color: var(--md-sys-color-surface-container);
            border-color: var(--md-sys-color-outline);
          }
          
          .md3-status-icon {
            font-size: 13px;
            margin-right: 3px;
            font-variation-settings: 'FILL' 0, 'wght' 300;
          }
          
          .md3-status-active .md3-status-icon {
            color: var(--md-sys-color-primary);
          }
          
          .md3-status-inactive .md3-status-icon {
            color: var(--md-sys-color-error);
          }
          
          .md3-status-text {
            font-family: var(--md-sys-typescale-label-small-font-family);
            font-size: var(--md-sys-typescale-label-small-font-size);
            font-weight: 400;
            letter-spacing: 0.1px;
          }
          
          .md3-status-active .md3-status-text {
            color: var(--md-sys-color-on-primary-container);
          }
          
          .md3-status-inactive .md3-status-text {
            color: var(--md-sys-color-on-surface-variant);
          }
          
          .md3-asset-date {
            font-family: var(--md-sys-typescale-body-small-font-family);
            font-size: var(--md-sys-typescale-body-small-font-size);
            color: var(--md-sys-color-on-surface-variant);
            width: 110px;
            text-align: right;
          }
          
          /* Überschreibungen für MD-Table in diesem Kontext */
          .md-table th {
            font-family: var(--md-sys-typescale-label-large-font-family);
            font-size: var(--md-sys-typescale-label-large-font-size);
            font-weight: 500;
            color: var(--md-sys-color-on-surface-variant);
            text-transform: uppercase;
            letter-spacing: 0.1px;
            padding-top: 16px;
            padding-bottom: 16px;
          }
        </style>
      {% endset %}
      
      {% set title = 'Letzte Assets' %}
      {% set padding = false %}
      {% set elevation = 1 %}
      {% include 'md3/components/card.html' %}
    </div>
  </div>
</div>

<!-- Chartdaten vom Server -->
<script id="chart-data" type="application/json">
{% if chart_data is defined %}
{{ chart_data | tojson }}
{% else %}
{
    "cost_distribution": {
        "labels": [],
        "data": []
    },
    "asset_status": {
        "labels": [],
        "data": []
    },
    "assignment_data": {
        "labels": [],
        "data": []
    }
}
{% endif %}
</script>

<script id="locations-data" type="application/json">{{ locations_json|safe }}</script>

<style>
  /* MD3 Dashboard Styles */
  .md-dashboard-container {
    padding: var(--md-sys-spacing-4);
    max-width: 1600px;
    margin: 80px auto 0; /* Berücksichtigt die Höhe der Navigation */
    background-color: var(--md-sys-color-surface-1);
    min-height: calc(100vh - 80px);
  }
  
  .md-dashboard-grid {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    grid-auto-rows: minmax(300px, auto);
    gap: var(--md-sys-spacing-4);
    margin-bottom: var(--md-sys-spacing-4);
  }
  
  .md-dashboard-grid-wide {
    grid-column: 1 / -1;
  }
  
  .md-dashboard-grid-item {
    grid-column: span 2;
    min-height: 300px;
  }
  
  .md-dashboard-grid-half {
    grid-column: span 3;
  }
  
  .md-dashboard-grid-third {
    grid-column: span 2;
  }
  
  .md-stat-row {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-around;
    gap: var(--md-sys-spacing-3);
  }
  
  /* MD3 Chart Styling */
  .md-chart-container {
    padding: var(--md-sys-spacing-3);
    background-color: var(--md-sys-color-surface-container);
    border-radius: var(--md-sys-shape-corner-medium);
    height: 100%;
    position: relative; /* Stellt sicher, dass die Container keinen Z-Index-Kontext erstellen */
    z-index: 1; /* Basis Z-Index */
  }
  
  /* Stelle sicher, dass Canvas über dem Container liegt */
  canvas.chartjs-render-monitor {
    position: relative;
    z-index: 2; /* Höher als Container */
  }
  
  .md-chart-title {
    font-family: var(--md-sys-typescale-title-medium-font-family-name);
    font-weight: var(--md-sys-typescale-title-medium-font-weight);
    font-size: var(--md-sys-typescale-title-medium-font-size);
    line-height: var(--md-sys-typescale-title-medium-line-height);
    color: var(--md-sys-color-on-surface);
    margin-bottom: var(--md-sys-spacing-2);
    padding-left: var(--md-sys-spacing-2);
    position: relative;
    z-index: 3; /* Über Canvas und Container */
  }
  
  /* Responsive Anpassungen */
  @media (max-width: 1200px) {
    .md-dashboard-grid {
      grid-template-columns: repeat(4, 1fr);
    }
    .md-dashboard-grid-half {
      grid-column: span 2;
    }
    .md-dashboard-grid-third {
      grid-column: span 2;
    }
  }
  
  @media (max-width: 768px) {
    .md-dashboard-grid {
      grid-template-columns: 1fr;
    }
    .md-dashboard-grid-item,
    .md-dashboard-grid-half,
    .md-dashboard-grid-third {
      grid-column: span 1;
    }
    
    .md-stat-row {
      flex-direction: column;
    }
  }
</style>

<!-- Standortdaten für Google Maps -->
<script id="locations-data" type="application/json" style="display: none;">
  {{ locations_json|safe }}
</script>

<!-- Debug-Funktion für AJAX-Monitoring -->
<script>
  // Original-Methoden speichern
  const originalFetch = window.fetch;
  const originalOpen = XMLHttpRequest.prototype.open;
  
  // Fetch überschreiben
  window.fetch = function() {
    console.log('Debug - Fetch-Aufruf:', arguments[0]);
    return originalFetch.apply(this, arguments);
  };
  
  // XMLHttpRequest.open überschreiben
  XMLHttpRequest.prototype.open = function() {
    console.log('Debug - XHR-Aufruf:', arguments[1], arguments[0]);
    return originalOpen.apply(this, arguments);
  };
</script>

<!-- Google Maps API direkt laden (kein dynamisches Laden via JavaScript) -->
<script src="" async defer></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM geladen, initialisiere Maps wenn API bereit ist...');
    initializeGoogleMapsWhenLoaded();
  });
</script>

<!-- Chart.js Initialisierung -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Chart-Daten laden
  const chartData = JSON.parse(document.getElementById('chart-data').textContent);
  
  // Charts mit kleiner Verzögerung initialisieren, um sicherzustellen dass DOM bereit ist
  setTimeout(() => {
    initValueDevelopmentChart();
    initCostDistributionChart();
  }, 100);
  
  // Globale Funktion zum Ausblenden des Loading Indicators
  function hideLoadingIndicator() {
    console.log('hideLoadingIndicator wurde aufgerufen');
    const loadingEl = document.getElementById('value-chart-loading');
    if (loadingEl) {
      console.log('Loading Indicator gefunden, entferne ihn');
      // Direkte Manipulation
      loadingEl.style.display = 'none';
      loadingEl.style.opacity = '0';
      loadingEl.style.visibility = 'hidden';
      // Falls möglich, Element entfernen
      if (loadingEl.parentNode) {
        try {
          loadingEl.parentNode.removeChild(loadingEl);
          console.log('Element wurde entfernt');
        } catch (e) {
          console.error('Fehler beim Entfernen:', e);
        }
      }
    } else {
      console.error('Loading Indicator nicht gefunden');
    }
  }
  
  // Beim Laden der Seite alle Loading Indikatoren ausblenden nach einer Verzögerung
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(hideLoadingIndicator, 3000); // Nach 3 Sekunden auf jeden Fall ausblenden
  });
  
  // Sanfte Farbpalette für Charts (weniger grell)
  const md3Colors = {
    // Primärfarben - sanfter/pastelliger
    primary: '#A394E0',        // Gedämpftes Lila statt intensives Primär
    onPrimary: '#FFFFFF',      
    primaryContainer: 'rgba(163, 148, 224, 0.3)', // Transparentes Lila für Füllungen
    onPrimaryContainer: '#382E6B',
    
    // Sekundärfarben - sanfter
    secondary: '#9DB2CE',      // Sanftes Blau
    onSecondary: '#FFFFFF',
    secondaryContainer: 'rgba(157, 178, 206, 0.3)', // Transparentes Blau für Füllungen
    onSecondaryContainer: '#334863',
    
    // Tertiärfarben - sanfter
    tertiary: '#B5C9A1',       // Sanftes Grün
    onTertiary: '#FFFFFF',
    tertiaryContainer: 'rgba(181, 201, 161, 0.3)', // Transparentes Grün für Füllungen
    onTertiaryContainer: '#465C36',
    
    // Zusätzliche sanfte Farben für Charts
    accent1: '#D8C3A5',        // Sanftes Beige
    accent2: '#E2A9A1',        // Sanftes Koralle
    accent3: '#D1BECF',        // Sanftes Lavendel
    accent4: '#A1C6E2',        // Sanftes Himmelblau
    accent5: '#C3DDD6',        // Sanftes Mintgrün
    
    // Oberflächen und Kontrastfarben - angepasst
    surface: '#F9F7FD',
    onSurface: '#4A4A4A',      // Gedämpftes Schwarz für Text
    surfaceContainer: '#F2F0F7',
    outline: '#CFCBD2',        // Sanfter Umriss
    error: '#D6A9A6'           // Sanftes Rot statt grelles Error-Rot
  };
  
  // MD3 Typografie für Charts
  const md3Typography = {
    titleMedium: {
      family: 'var(--md-sys-typescale-title-medium-font-family-name)',
      size: 'var(--md-sys-typescale-title-medium-font-size)',
      weight: 'var(--md-sys-typescale-title-medium-font-weight)',
      lineHeight: 'var(--md-sys-typescale-title-medium-line-height)'
    },
    labelMedium: {
      family: 'var(--md-sys-typescale-label-medium-font-family-name)',
      size: 'var(--md-sys-typescale-label-medium-font-size)',
      weight: 'var(--md-sys-typescale-label-medium-font-weight)',
      lineHeight: 'var(--md-sys-typescale-label-medium-line-height)'
    },
    bodySmall: {
      family: 'var(--md-sys-typescale-body-small-font-family-name)',
      size: 'var(--md-sys-typescale-body-small-font-size)',
      weight: 'var(--md-sys-typescale-body-small-font-weight)',
      lineHeight: 'var(--md-sys-typescale-body-small-line-height)'
    }
  };
  
  // Helper-Funktion, um Charts zu initialisieren
  // Wichtig: Diese Funktion wird mit setTimeout aufgerufen, um sicherzustellen,
  // Hilfsfunktion für Chart-Initialisierung nachdem
  // das DOM vollständig geladen ist
  function initChart(canvasId, chartConfig) {
    setTimeout(function() {
      const canvas = document.getElementById(canvasId);
      if (!canvas) {
        console.error(`Canvas "${canvasId}" nicht gefunden!`);
        return;
      }
      
      // Chart mit übergebener Konfiguration initialisieren
      new Chart(canvas, chartConfig);
      console.log(`Chart für ${canvasId} erfolgreich erstellt`);
    }, 100);
  }
  
  // Wertentwicklung (Line Chart) - Fallback oder API-Daten verwenden
  const initValueDevelopmentChart = () => {
    console.log('Initialisiere Wertentwicklung Chart...');
    
    // Loading Indicator anzeigen
    const loadingIndicator = document.getElementById('value-chart-loading');
    if (loadingIndicator) {
      loadingIndicator.classList.remove('hidden');
    }
    
    // Überprüfe, ob das Canvas existiert
    const valueCanvas = document.getElementById('valueChart');
    if (!valueCanvas) {
      console.error('FEHLER: Wertentwicklung Canvas #valueChart nicht gefunden!');
      // Versuche, alle Canvas-Elemente zu finden, um zu debuggen
      const allCanvasElements = document.querySelectorAll('canvas');
      console.log(`Gefundene Canvas-Elemente: ${allCanvasElements.length}`);
      allCanvasElements.forEach((canvas, index) => {
        console.log(`Canvas ${index}: id=${canvas.id}, width=${canvas.width}, height=${canvas.height}`);
      });
      
      // Loading Indicator ausblenden bei Fehler
      if (loadingIndicator) {
        loadingIndicator.classList.add('hidden');
      }
      return;
    }
    
    console.log('Wertentwicklung Canvas gefunden:', valueCanvas);
    
    // Element bereit machen
    const container = document.getElementById('value-chart-container');
    if (container) {
      container.style.minHeight = '300px';
    }
    
    // Versuche zuerst, Daten vom Backend zu laden
    console.log('Lade Wertentwicklungs-Daten vom Backend...');
    fetch('/api/dashboard/value-development')
      .then(response => {
        console.log('API Response Status:', response.status);
        if (!response.ok) {
          throw new Error(`Netzwerkantwort war nicht ok: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        console.log('Value development data loaded:', data);
        if (!data.value_development) {
          throw new Error('API-Antwort enthält keine value_development Daten');
        }
        console.log('Calling createValueChart with data:', data.value_development);
        createValueChart(valueCanvas, data.value_development);
      })
      .catch(error => {
        console.warn('API-Fehler, verwende Fallback-Daten für Wertentwicklung:', error);
        // Fallback: Daten aus dem versteckten JSON-Element laden
        const fallbackElement = document.getElementById('value-chart-fallback-data');
        if (!fallbackElement) {
          console.error('Fallback-Element #value-chart-fallback-data nicht gefunden!');
          
          // Loading Indicator ausblenden bei Fehler
          if (loadingIndicator) {
            loadingIndicator.classList.add('hidden');
          }
          return;
        }
        
        try {
          console.log('Parse Fallback-Daten:', fallbackElement.textContent.substring(0, 50) + '...');
          const fallbackData = JSON.parse(fallbackElement.textContent);
          if (!fallbackData.value_development) {
            console.error('Fallback-Daten enthalten keine value_development Daten!');
            
            // Loading Indicator ausblenden bei Fehler
            if (loadingIndicator) {
              loadingIndicator.classList.add('hidden');
            }
            return;
          }
          createValueChart(valueCanvas, fallbackData.value_development);
        } catch (e) {
          console.error('Fehler beim Parsen der Fallback-Daten:', e);
          
          // Loading Indicator ausblenden bei Fehler
          if (loadingIndicator) {
            loadingIndicator.classList.add('hidden');
          }
        }
      });
  };
  
  // Eigentliche Chart-Erstellung für Wertentwicklung
  const createValueChart = (canvas, chartData) => {
    if (!canvas || !chartData) {
      console.error('Canvas oder chartData fehlen:', { canvas, chartData });
      return;
    }
    
    console.log('Template createValueChart aufgerufen mit Daten:', chartData);
    
    // Chart erstellen
    const chart = new Chart(canvas, {
      type: 'line',
      data: {
        labels: chartData.labels,
        datasets: [{
          label: 'Gesamtwert',
          data: chartData.data,
          borderColor: md3Colors.primary,
          borderWidth: 2,
          backgroundColor: md3Colors.primaryContainer,
          pointBackgroundColor: md3Colors.primary,
          pointBorderColor: md3Colors.onPrimary,
          pointRadius: 4,
          pointHoverRadius: 6,
          tension: 0.3,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: {
          duration: 1800,
          easing: 'easeInOutQuart',
          delay: (context) => {
            if (context.type === 'data' && context.mode === 'default') {
              return context.dataIndex * 50; // Staggered animation for each point
            }
            return 0;
          }
        },
        interaction: {
          mode: 'index',
          intersect: false
        },
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              font: {
                family: md3Typography.bodySmall.family,
                size: parseInt(md3Typography.bodySmall.size)
              },
              padding: 16,
              usePointStyle: true,
              pointStyle: 'rectRounded'
            }
          },
          tooltip: {
            titleFont: {
              family: md3Typography.labelMedium.family,
              size: parseInt(md3Typography.labelMedium.size)
            },
            bodyFont: {
              family: md3Typography.bodySmall.family,
              size: parseInt(md3Typography.bodySmall.size)
            },
            padding: 12,
            cornerRadius: 8
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              color: md3Colors.outline + '40', // 25% Transparenz
              tickLength: 0
            },
            ticks: {
              font: {
                family: md3Typography.bodySmall.family,
                size: parseInt(md3Typography.bodySmall.size)
              },
              padding: 8
            }
          },
          x: {
            grid: {
              display: false
            },
            ticks: {
              font: {
                family: md3Typography.bodySmall.family,
                size: parseInt(md3Typography.bodySmall.size)
              },
              padding: 8
            }
          }
        }
      }
    });
  }

  // Kostenverteilung (Doughnut Chart)
  const initCostDistributionChart = () => {
    const costCanvas = document.getElementById('costChart');
    console.log('Initialisiere Kostenverteilung Chart, Canvas:', costCanvas);
    if (!costCanvas) {
      console.error('Canvas #costChart nicht gefunden.');
      return;
    }

    let costData = chartData?.cost_distribution;
    if (!costData || !Array.isArray(costData.labels) || costData.labels.length === 0) {
      const fallbackEl = document.getElementById('cost-chart-fallback-data');
      if (fallbackEl) {
        try {
          const parsed = JSON.parse(fallbackEl.textContent || '{}');
          costData = parsed.cost_distribution;
        } catch (err) {
          console.error('Fehler beim Parsen der Kostenverteilung Fallback-Daten:', err);
        }
      }
    }

    if (!costData || !Array.isArray(costData.labels) || costData.labels.length === 0) {
      console.warn('Keine Daten für Kostenverteilung vorhanden, Chart wird ausgeblendet.');
      costCanvas.parentElement?.classList.add('hidden');
      return;
    }

    // Stelle sicher, dass Container sichtbar bleibt
    costCanvas.parentElement?.classList.remove('hidden');

    new Chart(costCanvas, {
      type: 'doughnut',
      data: {
        labels: costData.labels,
        datasets: [{
          data: costData.data,
          backgroundColor: costData.labels.map((_, idx) => md3Colors.getChartColor ? md3Colors.getChartColor(idx) : md3Colors.chartColors?.[idx] || md3Colors.primaryContainer),
          borderColor: '#FFFFFF',
          borderWidth: 1,
          hoverBorderWidth: 2,
          borderRadius: 6
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '65%',
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              usePointStyle: true,
              pointStyle: 'circle',
              padding: 16,
              font: {
                family: md3Typography.bodySmall.family,
                size: parseInt(md3Typography.bodySmall.size)
              }
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const value = context.parsed || 0;
                return `${context.label}: ${new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(value)}`;
              }
            }
          }
        }
      }
    });
  };
  
  // Abteilungsverteilung (Doughnut Chart)
  const deptCanvas = document.getElementById('deptChart');
  console.log('DeptChart Canvas Element:', deptCanvas);
  console.log('Department Distribution Data:', chartData.department_distribution);
  
  if (deptCanvas && chartData.department_distribution) {
    const deptData = chartData.department_distribution;
    console.log('Creating Department Chart with data:', deptData);
    
    // Zeige Canvas an
    deptCanvas.style.display = 'block';
    
    new Chart(deptCanvas, {
      type: 'doughnut',
      data: {
        labels: deptData.labels || [],
        datasets: [{
          data: deptData.data || [],
          backgroundColor: [
            md3Colors.tertiary,
            md3Colors.primary,
            md3Colors.secondary,
            md3Colors.accent1,
            md3Colors.accent2,
            md3Colors.accent3
          ],
          borderColor: [
            '#FFFFFF',
            '#FFFFFF',
            '#FFFFFF',
            '#FFFFFF',
            '#FFFFFF',
            '#FFFFFF'
          ],
          borderWidth: 1,
          borderRadius: 4 // Abgerundete Ecken für Segmente
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '70%', // MD3-Stil für Donut-Charts
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              font: {
                family: md3Typography.bodySmall.family,
                size: parseInt(md3Typography.bodySmall.size)
              },
              padding: 16,
              usePointStyle: true,
              pointStyle: 'circle'
            }
          },
          tooltip: {
            titleFont: {
              family: md3Typography.labelMedium.family,
              size: parseInt(md3Typography.labelMedium.size)
            },
            bodyFont: {
              family: md3Typography.bodySmall.family,
              size: parseInt(md3Typography.bodySmall.size)
            },
            padding: 12,
            cornerRadius: 8
          }
        }
      }
    });
  }
  
  // Auslastung nach Monaten (Bar Chart)
  if (document.getElementById('usageChart') && chartData.monthly_usage) {
    new Chart(document.getElementById('usageChart'), {
      type: 'bar',
      data: {
        labels: chartData.monthly_usage.labels,
        datasets: [{
          label: 'Auslastung',
          data: chartData.monthly_usage.data,
          backgroundColor: md3Colors.primaryContainer,
          borderColor: md3Colors.primary,
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'bottom',
          }
        },
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  }
  
  // Assets nach Kategorie und Zuordnung (Grouped Bar Chart)
  const categoryAssignmentCanvas = document.getElementById('categoryAssignmentChart');
  console.log('CategoryAssignmentChart Canvas Element:', categoryAssignmentCanvas);
  
  if (categoryAssignmentCanvas && chartData.category_assignment_combined) {
    const combinedData = chartData.category_assignment_combined;
    console.log('Category Assignment Combined Data:', combinedData);
    
    // Kombiniere Labels und Daten
    const allLabels = [...(combinedData.categories?.labels || []), ...(combinedData.assignments?.labels || [])];
    const allData = [...(combinedData.categories?.data || []), ...(combinedData.assignments?.data || [])];
    
    console.log('Combined Labels:', allLabels);
    console.log('Combined Data:', allData);
    
    if (allLabels.length > 0 && allData.length > 0) {
      // Zeige Canvas an
      categoryAssignmentCanvas.style.display = 'block';
      
      new Chart(categoryAssignmentCanvas, {
        type: 'bar',
        data: {
          labels: allLabels,
          datasets: [{
            label: 'Anzahl Assets',
            data: allData,
            backgroundColor: [
              md3Colors.primary,      // Kategorien
              md3Colors.secondary,    // Zuordnungen
              md3Colors.tertiary,
              md3Colors.accent1,
              md3Colors.accent2,
              md3Colors.accent3
            ],
            borderColor: [
              md3Colors.primary,
              md3Colors.secondary,
              md3Colors.tertiary,
              md3Colors.accent1,
              md3Colors.accent2,
              md3Colors.accent3
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top'
            },
            tooltip: {
              backgroundColor: md3Colors.surface,
              titleColor: md3Colors.onSurface,
              bodyColor: md3Colors.onSurface,
              borderColor: md3Colors.outline,
              borderWidth: 1
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1,
                color: md3Colors.onSurface
              },
              grid: {
                color: md3Colors.outline + '40'
              }
            },
            x: {
              ticks: {
                color: md3Colors.onSurface
              },
              grid: {
                display: false
              }
            }
          }
        }
      });
      
      console.log('Category Assignment Chart created successfully!');
    } else {
      console.log('No data for Category Assignment Chart');
      categoryAssignmentCanvas.style.display = 'none';
    }
  } else {
    console.log('Category Assignment Chart canvas not found or no data');
  }
  
  // Funktion zur Erstellung der Hersteller-Chart
  function createManufacturerChart(canvas, data) {
    console.log('createManufacturerChart called with:', canvas, data);
    console.log('Chart.js available:', typeof Chart);
    
    // Daten verarbeiten
    const manufacturers = data.map(item => item.manufacturer || 'Unbekannt');
    const assetCounts = data.map(item => item.count || 0);
    
    console.log('Processed data - Manufacturers:', manufacturers);
    console.log('Processed data - Counts:', assetCounts);
    
    // Nur die Top 8 Hersteller anzeigen, falls mehr vorhanden sind
    let displayManufacturers = [...manufacturers];
    let displayCounts = [...assetCounts];
    
    if (manufacturers.length > 8) {
      const sortedIndices = assetCounts.map((count, index) => ({ count, index }))
        .sort((a, b) => b.count - a.count)
        .map(item => item.index);
      
      const topManufacturers = [];
      const topCounts = [];
      let otherCount = 0;
      
      sortedIndices.forEach((index, i) => {
        if (i < 7) {
          topManufacturers.push(manufacturers[index]);
          topCounts.push(assetCounts[index]);
        } else {
          otherCount += assetCounts[index];
        }
      });
      
      if (otherCount > 0) {
        topManufacturers.push('Andere');
        topCounts.push(otherCount);
      }
      
      displayManufacturers = topManufacturers;
      displayCounts = topCounts;
    }
    
    // MD3 Farbpalette (sanft)
    const backgroundColors = [
      'rgba(163, 148, 224, 0.5)',  // Sanftes Lila (primary)
      'rgba(157, 178, 206, 0.5)',  // Sanftes Blau (secondary)
      'rgba(181, 201, 161, 0.5)',  // Sanftes Grün (tertiary)
      'rgba(216, 195, 165, 0.5)',  // Sanftes Beige (accent1)
      'rgba(226, 169, 161, 0.5)',  // Sanftes Koralle (accent2)
      'rgba(209, 190, 207, 0.5)',  // Sanftes Lavendel (accent3)
      'rgba(161, 198, 226, 0.5)',  // Sanftes Himmelblau (accent4)
      'rgba(195, 221, 214, 0.5)'   // Sanftes Mintgrün (accent5)
    ];
    
    const borderColors = backgroundColors.map(color => color.replace('0.5', '0.8'));
    
    // Chart erstellen
    return new Chart(canvas, {
      type: 'bar',
      data: {
        labels: displayManufacturers,
        datasets: [{
          label: 'Anzahl Assets',
          data: displayCounts,
          backgroundColor: backgroundColors,
          borderColor: borderColors,
          borderWidth: 1
        }]
      },
      options: {
        indexAxis: 'y',  // Horizontal bar chart
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false  // Legende ausblenden
          },
          tooltip: {
            callbacks: {
              title: function(tooltipItems) {
                return tooltipItems[0].label;
              },
              label: function(context) {
                return `Anzahl: ${context.raw}`;
              }
            }
          }
        },
        scales: {
          x: {
            beginAtZero: true,
            grid: {
              color: 'rgba(0, 0, 0, 0.05)'
            }
          },
          y: {
            grid: {
              display: false
            }
          }
        }
      }
    });
  }
  
  // Assets nach Hersteller (Horizontal Bar Chart)
  const manufacturerCanvas = document.getElementById('manufacturerChart');
  console.log('ManufacturerChart Canvas Element:', manufacturerCanvas);
  console.log('Chart Data Object:', chartData);
  
  if (manufacturerCanvas) {
    try {
      // Prüfe, ob Herstellerdaten vorhanden sind  
      const rawManufacturerData = chartData?.manufacturer_distribution || {};
      console.log('Raw Manufacturer Data:', rawManufacturerData);
      
      // Konvertiere Chart.js Format zu Array Format
      let manufacturerData = [];
      if (rawManufacturerData.labels && rawManufacturerData.data) {
        manufacturerData = rawManufacturerData.labels.map((label, index) => ({
          manufacturer: label,
          count: rawManufacturerData.data[index] || 0
        }));
      }
      console.log('Converted Manufacturer Data:', manufacturerData);
      
      // Wenn keine Daten vorhanden sind, zeige leeren Chart
      if (!manufacturerData || manufacturerData.length === 0) {
        console.log('Keine Herstellerdaten vorhanden - Chart wird nicht angezeigt');
        manufacturerCanvas.style.display = 'none';
      } else {
        // Chart mit realen Daten anzeigen
        console.log('Creating Manufacturer Chart with data:', manufacturerData);
        manufacturerCanvas.style.display = 'block';
        createManufacturerChart(manufacturerCanvas, manufacturerData);
      }
    } catch (error) {
      console.error('Fehler bei der Verarbeitung der Herstellerdaten:', error);
      // Im Fehlerfall Chart ausblenden
      const chartContainer = document.getElementById('manufacturerChart');
      if (chartContainer) {
        chartContainer.style.display = 'none';
      }
    }
  }
  
  // Funktion zum Hinzufügen von Standort-Markern
  function addLocationMarkers(map, infoWindow, bounds, locations) {
    // Prüfen ob Daten vorhanden sind
    if (!locations || !Array.isArray(locations) || locations.length === 0) {
      console.warn('Keine Standortdaten zum Anzeigen vorhanden');
      return;
    }
    
    console.log(`Füge ${locations.length} Standort-Marker zur Karte hinzu...`);
    
    // Bounds-Objekt für automatisches Zoomen
    const mapBounds = bounds || new google.maps.LatLngBounds();
    
    // Marker für jeden Standort erstellen
    locations.forEach(function(location) {
      // Position aus den Daten extrahieren
      const position = new google.maps.LatLng(
        location.latitude || location.lat, 
        location.longitude || location.lng
      );
      
      // MD3-farbiger Marker
      const marker = new google.maps.Marker({
        position: position,
        map: map,
        title: location.name || 'Standort',
        animation: google.maps.Animation.DROP
      });
      
      // Zur Bounds hinzufügen
      mapBounds.extend(position);
      
      // InfoWindow-Inhalt
      const contentString = `
        <div class="md3-map-info-window">
          <h4 class="md3-map-info-title">${location.name || 'Standort'}</h4>
          ${location.address ? `<p class="md3-map-info-address">${location.address}</p>` : ''}
          <p class="md3-map-info-count">
            <span>${location.asset_count || location.assets || 0}</span> Assets
          </p>
        </div>
      `;
      
      // Click-Event für Marker
      marker.addListener('click', function() {
        infoWindow.setContent(contentString);
        infoWindow.open(map, marker);
      });
    });
    
    // Karte auf alle Marker zoomen
    if (locations.length > 0) {
      map.fitBounds(mapBounds);
      // Minimum-Zoom setzen
      const listener = google.maps.event.addListener(map, 'idle', function() {
        if (map.getZoom() > 7) map.setZoom(7);
        google.maps.event.removeListener(listener);
      });
    }
  }
  
  // Google Maps Initialisierungsfunktion (wird von der API aufgerufen)
  function initMap() {
    console.log('Google Maps API geladen, initialisiere Karte...');
    
    // Map-Container-Element
    const mapElement = document.getElementById('location-map');
    
    // Prüfen, ob Container existiert
    if (!mapElement) {
      console.error('Map-Container nicht gefunden.');
      return;
    }
    
    // Bounds-Objekt für automatisches Zoomen
    const bounds = new google.maps.LatLngBounds();
    
    // Karte initialisieren
    try {
      // Google Map mit MD3 Styling erstellen
      const googleMap = new google.maps.Map(mapElement, {
        center: { lat: 51.1657, lng: 10.4515 },  // Deutschland Mitte
        zoom: 7, // Näher herangezoomt für Deutschland-Fokus
        // MD3-kompatibles Styling - harmonische Farben
        styles: [
          {
            "elementType": "geometry",
            "stylers": [{ "color": "#f2f0f7" }] // MD3 Surface Container
          },
          {
            "elementType": "labels.icon",
            "stylers": [{ "visibility": "off" }]
          },
          {
            "elementType": "labels.text.fill",
            "stylers": [{ "color": "#615f6c" }] // MD3 On Surface Variant
          },
          {
            "elementType": "labels.text.stroke",
            "stylers": [{ "color": "#faf9fd" }] // MD3 Surface
          },
          {
            "featureType": "poi",
            "elementType": "labels.text",
            "stylers": [{ "visibility": "off" }]
          },
          {
            "featureType": "poi.business",
            "stylers": [{ "visibility": "off" }]
          },
          {
            "featureType": "road",
            "elementType": "geometry",
            "stylers": [{ "color": "#e8e4f0" }] // Sanftes Grau
          },
          {
            "featureType": "road.highway",
            "elementType": "geometry",
            "stylers": [{ "color": "#d8c3a5" }] // Sanfte Beige-Töne
          },
          {
            "featureType": "water",
            "elementType": "geometry",
            "stylers": [{ "color": "#d1becf" }] // Sanftes Lavendel
          },
          {
            "featureType": "landscape",
            "elementType": "geometry",
            "stylers": [{ "color": "#f9f7fd" }] // MD3 Surface
          },
          {
            "featureType": "landscape.natural",
            "elementType": "geometry",
            "stylers": [{ "color": "#f2f0f7" }] // Sanft statt grün
          },
          {
            "featureType": "landscape.natural.landcover",
            "elementType": "geometry",
            "stylers": [{ "color": "#e8e4f0" }] // Sanftes Grau
          },
          {
            "featureType": "administrative.country",
            "elementType": "labels.text.fill",
            "stylers": [{ "color": "#a394e0" }] // MD3 Primary
          },
          {
            "featureType": "administrative.country",
            "elementType": "geometry.stroke",
            "stylers": [
              { "color": "#a394e0" }, // MD3 Primary für Landesgrenzen
              { "weight": 2 },
              { "visibility": "on" }
            ]
          },
          {
            "featureType": "administrative.province",
            "elementType": "geometry.stroke",
            "stylers": [
              { "color": "#c3b2cf" }, // Sanfte Bundesländer-Grenzen
              { "weight": 1 },
              { "visibility": "on" }
            ]
          },
          {
            "featureType": "administrative.locality",
            "elementType": "labels.text.fill",
            "stylers": [
              { "color": "#8b5a3c" }, // Deutsche Städte hervorgehoben
              { "weight": "bold" }
            ]
          }
        ],
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false,
        zoomControl: true,
        zoomControlOptions: {
          position: google.maps.ControlPosition.RIGHT_BOTTOM,
          style: google.maps.ZoomControlStyle.SMALL
        }
      });
      
      console.log('Google Map wurde erstellt');
      
      // InfoWindow für Marker-Popups
      const infoWindow = new google.maps.InfoWindow();
      
      // Standort-Daten von der API laden
      try {
        console.log('Lade Standortdaten von API...');
        
        // API-Aufruf für Standortdaten
        fetch('/api/dashboard/locations')
          .then(response => {
            if (!response.ok) {
              throw new Error(`API-Fehler: ${response.status} ${response.statusText}`);
            }
            return response.json();
          })
          .then(data => {
            let locations = data.locations || [];
            console.log('Standortdaten von API geladen:', locations.length, 'Standorte gefunden');
            
            // Wenn keine Daten vorhanden sind, Karte leer lassen
            if (!locations || locations.length === 0) {
              console.log('Keine Standortdaten gefunden - Karte bleibt leer');
              locations = [];
            }
            
            addLocationMarkers(googleMap, infoWindow, bounds, locations);
          })
          .catch(error => {
            console.error('Fehler beim Laden der Standortdaten:', error);
            
            // Bei Fehler Karte leer lassen
            console.log('Fehler beim Laden - Karte bleibt leer');
            addLocationMarkers(googleMap, infoWindow, bounds, []);
          });
      } catch (error) {
        console.error('Fehler bei der Kartendarstellung:', error);
      }
        
      // Funktion zum Hinzufügen von Standort-Markern
      function addLocationMarkers(map, infoWindow, bounds, locations) {
        // Prüfen ob Daten vorhanden sind
        if (!locations || !Array.isArray(locations) || locations.length === 0) {
          console.warn('Keine Standortdaten zum Anzeigen vorhanden');
          return;
        }
        
        console.log(`Füge ${locations.length} Standort-Marker zur Karte hinzu...`);
        
        // Bounds-Objekt für automatisches Zoomen
        const mapBounds = bounds || new google.maps.LatLngBounds();
        
        // Marker für jeden Standort erstellen
        locations.forEach(function(location) {
          // Position aus den Daten extrahieren
          const position = new google.maps.LatLng(
            location.latitude || location.lat, 
            location.longitude || location.lng
          );
          
          // MD3-farbiger Marker
          const marker = new google.maps.Marker({
            position: position,
            map: map,
            title: location.name || 'Standort',
            animation: google.maps.Animation.DROP
          });
          
          // Zur Bounds hinzufügen
          mapBounds.extend(position);
          
          // InfoWindow-Inhalt
          const contentString = `
            <div class="md3-map-info-window">
              <h4 class="md3-map-info-title">${location.name || 'Standort'}</h4>
              ${location.address ? `<p class="md3-map-info-address">${location.address}</p>` : ''}
              <p class="md3-map-info-count">
                <span>${location.asset_count || location.assets || 0}</span> Assets
              </p>
            </div>
          `;
          
          // Click-Event für Marker
          marker.addListener('click', function() {
            infoWindow.setContent(contentString);
            infoWindow.open(map, marker);
          });
        });
        
        // Karte auf alle Marker zoomen
        if (locations.length > 0) {
          map.fitBounds(mapBounds);
          // Minimum-Zoom setzen
          const listener = google.maps.event.addListener(map, 'idle', function() {
            if (map.getZoom() > 7) map.setZoom(7);
            google.maps.event.removeListener(listener);
          });
        }
      }
    } catch (error) {
      console.error('Fehler bei der Initialisierung der Google Maps-Karte:', error);
      mapElement.innerHTML = `<div style="padding: 20px; text-align: center; color: var(--md-sys-color-error);">
        <p>Fehler beim Laden der Karte</p>
        <p>${error.message}</p>
      </div>`;
    }
  }
  
  // Falls Google Maps API bereits geladen wurde, Karte manuell initialisieren
  if (window.google && window.google.maps && !window.mapInitialized) {
    console.log('Google Maps API bereits geladen, initialisiere Karte manuell...');
    window.mapInitialized = true;
    initMap();
  }
});

// Chart-Daten direkt anzeigen
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM geladen, prüfe Chart-Element');
    const canvas = document.getElementById('costChart');
    if (canvas) {
      console.log('Canvas gefunden:', canvas);
    } else {
      console.error('Canvas nicht gefunden!');
    }
  });
</script>

<!-- Google Maps Integration für Dashboard -->  
<script>
// Aktiviere den Loading-Indikator
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM geladen, initialisiere Map Loading-Anzeige');
  const loadingIndicator = document.getElementById('map-loading');
  if (loadingIndicator) {
    loadingIndicator.style.display = 'block';
  }
  
  // Google Maps nach kurzem Delay laden (für bessere DOM-Initialisierung)
  setTimeout(loadGoogleMapsAPI, 300);
});

// Globale Variable für die Karte
let googleMap = null;

// Google Maps API laden
function loadGoogleMapsAPI() {
  console.log('Lade Google Maps API...');
  const script = document.createElement('script');
  script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyDU0B8Yh8TdEzx3DiXOv1Zxjmcc83oIlgk&libraries=places&callback=initializeGoogleMapsWhenLoaded';
  script.async = true;
  script.defer = true;
  document.head.appendChild(script);
}

// Zähler für Google Maps API-Ladeversuche
let mapsApiCheckCount = 0;
const MAX_API_CHECK_ATTEMPTS = 20; // Maximal 10 Sekunden warten (20 * 500ms)

function initializeGoogleMapsWhenLoaded() {
  // Prüfen, ob die Google Maps API bereits geladen ist
  if (window.google && window.google.maps) {
    console.log('Google Maps API erfolgreich geladen!');
    initMap();
  } else {
    mapsApiCheckCount++;
    
    // Nur bei bestimmten Intervallen loggen, um Spam zu reduzieren
    if (mapsApiCheckCount === 1 || mapsApiCheckCount % 5 === 0) {
      console.log(`Warte auf Google Maps API... (Versuch ${mapsApiCheckCount}/${MAX_API_CHECK_ATTEMPTS})`);
    }
    
    // Nach MAX_API_CHECK_ATTEMPTS aufhören zu versuchen
    if (mapsApiCheckCount >= MAX_API_CHECK_ATTEMPTS) {
      console.error('Google Maps API konnte nicht geladen werden nach mehreren Versuchen');
      const mapElement = document.getElementById('location-map');
      if (mapElement) {
        mapElement.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--md-sys-color-error);">Fehler beim Laden der Google Maps API nach mehreren Versuchen</div>';
      }
    } else {
      setTimeout(initializeGoogleMapsWhenLoaded, 500);
    }
  }
}

// Maps initialisieren
function initMap() {
  console.log('Initialisiere Google Maps...');
  
  // Map-Container finden
  const mapElement = document.getElementById('location-map');
  if (!mapElement) {
    console.error('Map-Element #location-map nicht gefunden!');
    return;
  }
  
  try {
    // Map-Optionen
    const mapOptions = {
      center: { lat: 51.165, lng: 10.452 }, // Deutschland-Zentrum
      zoom: 7, // Näher herangezoomt für Deutschland-Fokus
      mapTypeId: google.maps.MapTypeId.ROADMAP,
      zoomControl: true,
      mapTypeControl: false, // Keine Kartentypauswahl
      scaleControl: false, // Kein Maßstab
      streetViewControl: false, // Kein Street View
      rotateControl: false, // Keine Rotationskontrolle
      fullscreenControl: false, // Kein Vollbild-Button
      panControl: false, // Keine Pan-Kontrolle
      mapTypeControlOptions: {
        mapTypeIds: [] // Keine Kartentypauswahl überhaupt zulassen
      },
      // Verstecke alle UI-Elemente
      disableDefaultUI: true,
      // Nur die benötigten Steuerelemente anzeigen
      zoomControl: true,
      // MD3-kompatibles Styling - harmonische Farben
      styles: [
        {
          "elementType": "geometry",
          "stylers": [{ "color": "#f2f0f7" }] // MD3 Surface Container
        },
        {
          "elementType": "labels.icon",
          "stylers": [{ "visibility": "off" }]
        },
        {
          "elementType": "labels.text.fill",
          "stylers": [{ "color": "#615f6c" }] // MD3 On Surface Variant
        },
        {
          "elementType": "labels.text.stroke",
          "stylers": [{ "color": "#faf9fd" }] // MD3 Surface
        },
        {
          "featureType": "poi",
          "elementType": "labels.text",
          "stylers": [{ "visibility": "off" }]
        },
        {
          "featureType": "poi.business",
          "stylers": [{ "visibility": "off" }]
        },
        {
          "featureType": "road",
          "elementType": "geometry",
          "stylers": [{ "color": "#e8e4f0" }] // Sanftes Grau
        },
        {
          "featureType": "road.highway",
          "elementType": "geometry",
          "stylers": [{ "color": "#d8c3a5" }] // Sanfte Beige-Töne
        },
        {
          "featureType": "water",
          "elementType": "geometry",
          "stylers": [{ "color": "#d1becf" }] // Sanftes Lavendel
        },
        {
          "featureType": "landscape",
          "elementType": "geometry",
          "stylers": [{ "color": "#f9f7fd" }] // MD3 Surface
        },
        {
          "featureType": "landscape.natural",
          "elementType": "geometry",
          "stylers": [{ "color": "#f2f0f7" }] // Sanft statt grün
        },
        {
          "featureType": "landscape.natural.landcover",
          "elementType": "geometry",
          "stylers": [{ "color": "#e8e4f0" }] // Sanftes Grau
        },
        {
          "featureType": "administrative.country",
          "elementType": "labels.text.fill",
          "stylers": [{ "color": "#a394e0" }] // MD3 Primary
        },
        {
          "featureType": "administrative.country",
          "elementType": "geometry.stroke",
          "stylers": [
            { "color": "#a394e0" }, // MD3 Primary für Landesgrenzen
            { "weight": 2 },
            { "visibility": "on" }
          ]
        },
        {
          "featureType": "administrative.province",
          "elementType": "geometry.stroke",
          "stylers": [
            { "color": "#c3b2cf" }, // Sanfte Bundesländer-Grenzen
            { "weight": 1 },
            { "visibility": "on" }
          ]
        },
        {
          "featureType": "administrative.locality",
          "elementType": "labels.text.fill",
          "stylers": [
            { "color": "#8b5a3c" }, // Deutsche Städte hervorgehoben
            { "weight": "bold" }
          ]
        },
        {
          "featureType": "transit",
          "elementType": "labels",
          "stylers": [{ "visibility": "off" }]
        },
        {
          "featureType": "administrative",
          "elementType": "labels",
          "stylers": [{ "visibility": "simplified" }]
        }
      ]
    };
    
    // Überprüfe, ob ein benutzerdefiniertes Overlay mit dem Text "active" existiert
    // und entferne es nach der Karteninitialisierung
    setTimeout(() => {
      const mapContainer = document.getElementById('location-map');
      if (mapContainer) {
        // Suche nach allen span- und div-Elementen innerhalb der Karte
        const elements = mapContainer.querySelectorAll('span, div');
        elements.forEach(element => {
          // Wenn der Text "active" enthält, Element ausblenden
          if (element.textContent && element.textContent.toLowerCase().includes('active')) {
            console.log('Active-Element gefunden und wird versteckt:', element);
            element.style.display = 'none';
          }
        });
      }
    }, 1000);
    
    // Map erstellen
    googleMap = new google.maps.Map(mapElement, mapOptions);
    console.log('Google Map erstellt');
    
    // Nach erfolgreicher Initialisierung
    if (googleMap) {
      // Karte sichtbar machen
      mapElement.style.visibility = 'visible';
      mapElement.style.opacity = '1';
      
      // Loading-Icon ausblenden
      const loadingIndicator = document.getElementById('map-loading');
      if (loadingIndicator) {
        loadingIndicator.style.display = 'none';
      }
      
      // Standort-Marker hinzufügen
      addLocationMarkers();
      
      // Resize-Handler
      window.addEventListener('resize', function() {
        const center = googleMap.getCenter();
        google.maps.event.trigger(googleMap, 'resize');
        googleMap.setCenter(center);
      });
    }
  } catch (error) {
    console.error('Fehler bei der Initialisierung der Google Maps-Karte:', error);
    mapElement.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--md-sys-color-error);">' +
      '<p>Fehler beim Laden der Karte</p>' +
      '<p>' + error.message + '</p></div>';
  }
}

// Standort-Marker hinzufügen
function addLocationMarkers() {
  if (!googleMap || !window.google || !window.google.maps) {
    console.error('Google Maps nicht initialisiert für Marker!');
    return;
  }
  
  // InfoWindow für Marker-Popups
  const infoWindow = new google.maps.InfoWindow();
  
  try {
    // Versuche, Daten aus dem DOM zu laden
    const locationsElement = document.getElementById('locations-data');
    let locations = [];
    
    if (locationsElement && locationsElement.textContent.trim()) {
      locations = JSON.parse(locationsElement.textContent);
      console.log('Standortdaten geladen:', locations.length, 'Standorte gefunden');
      
      // Boundings für automatisches Zoomen
      const bounds = new google.maps.LatLngBounds();
      
      // Marker für jeden Standort hinzufügen
      locations.forEach(location => {
        if (location.latitude && location.longitude) {
          // Position erstellen
          const position = new google.maps.LatLng(location.latitude, location.longitude);
          
          // Berechne Marker-Größe basierend auf Asset-Anzahl (min 4, max 8)
          const assetCount = location.asset_count || 1;
          const scale = Math.max(4, Math.min(8, 4 + Math.log10(assetCount) * 2));
          
          // Erstelle elegantes SVG-Icon für MD3-Design
          const svgIcon = {
            url: `data:image/svg+xml;utf-8,${encodeURIComponent(`
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="8" fill="#6750A4" stroke="white" stroke-width="1.5" opacity="0.9" />
              </svg>
            `)}`,
            scaledSize: new google.maps.Size(scale * 2.5, scale * 2.5),
            anchor: new google.maps.Point(scale * 1.25, scale * 1.25),
          };
          
          // Erweiterte Marker-Optionen
          const markerOptions = {
            position: position,
            map: googleMap,
            title: location.name || 'Standort',
            icon: svgIcon,
            animation: google.maps.Animation.DROP,
            optimized: true,  // Performance-Verbesserung
          };
          
          // Marker erstellen
          const marker = new google.maps.Marker(markerOptions);
          
          // InfoWindow-Inhalt mit Standortinfos
          const infoWindowContent = `
            <div class="md3-map-info-window">
              <h4 class="md3-map-info-title">${location.name || 'Standort'}</h4>
              ${location.address ? `<p class="md3-map-info-address">${location.address}</p>` : ''}
              ${location.asset_count ? 
                `<p class="md3-map-info-count"><span>${location.asset_count}</span> Assets</p>` : 
                ''}
            </div>
          `;
          
          // Click-Event für Marker hinzufügen
          marker.addListener('click', () => {
            infoWindow.setContent(infoWindowContent);
            infoWindow.open(googleMap, marker); // Korrekte Referenz zur googleMap-Variable
          });
          
          // Bounds erweitern
          bounds.extend(position);
        }
      });
      
      // Karte auf alle Marker zoomen, wenn vorhanden
      if (locations.length > 0) {
        googleMap.fitBounds(bounds);
        // Minimalen Zoom begrenzen, um nicht zu weit zu zoomen bei einzelnen Markern
        const zoomListener = google.maps.event.addListener(googleMap, 'idle', () => {
          if (googleMap.getZoom() > 16) googleMap.setZoom(16);
          google.maps.event.removeListener(zoomListener);
        });
      }
    } else {
      console.log('Keine Standortdaten gefunden');
    }
  } catch (error) {
    console.error('Fehler beim Laden der Standortdaten:', error);
  }
  
  // Karte bei Größenänderung aktualisieren
  window.addEventListener('resize', () => {
    const center = googleMap.getCenter();
    google.maps.event.trigger(googleMap, 'resize');
    googleMap.setCenter(center);
  });
}
// Ende der Google Maps Initialisierungslogik
  
  // Lieferungsstatistiken initialisieren
  function initDeliveryChart() {
    try {
      // Tracking-Daten laden
      const trackingDataElement = document.getElementById('tracking-data');
      if (!trackingDataElement) {
        console.error('Tracking-Daten-Element nicht gefunden');
        return;
      }
      
      const trackingData = JSON.parse(trackingDataElement.textContent);
      if (!trackingData || !trackingData.counts) {
        console.error('Ungültige Tracking-Daten', trackingData);
        return;
      }
      
      // Werte in Statistiken anzeigen
      document.getElementById('deliveries-in-transit').textContent = trackingData.counts.in_transit || 0;
      document.getElementById('deliveries-delivered').textContent = trackingData.counts.delivered || 0;
      document.getElementById('deliveries-pending').textContent = trackingData.counts.pending || 0;
      
      // Chart initialisieren
      const canvas = document.getElementById('deliveryChart');
      if (!canvas) {
        console.error('Canvas für Lieferungs-Chart nicht gefunden');
        return;
      }
      
      // MD3 Farben für die Chart definieren
      const md3Colors = {
        inTransit: getComputedStyle(document.documentElement).getPropertyValue('--md-sys-color-tertiary').trim(),
        delivered: getComputedStyle(document.documentElement).getPropertyValue('--md-sys-color-primary').trim(),
        pending: getComputedStyle(document.documentElement).getPropertyValue('--md-sys-color-error').trim()
      };
      
      // Daten für die Chart vorbereiten
      const chartData = {
        labels: ['In Transport', 'Geliefert', 'Ausstehend'],
        datasets: [{
          data: [
            trackingData.counts.in_transit || 0,
            trackingData.counts.delivered || 0,
            trackingData.counts.pending || 0
          ],
          backgroundColor: [
            md3Colors.inTransit || '#03DAC6',
            md3Colors.delivered || '#6750A4',
            md3Colors.pending || '#B3261E'
          ],
          borderWidth: 0,
          hoverOffset: 0
        }]
      };
      
      // Chart-Konfiguration
      const chartConfig = {
        type: 'doughnut',
        data: chartData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '70%',
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                font: {
                  family: getComputedStyle(document.documentElement).getPropertyValue('--md-sys-typescale-body-medium-font-family').trim(),
                  size: parseInt(getComputedStyle(document.documentElement).getPropertyValue('--md-sys-typescale-body-medium-font-size')),
                  weight: getComputedStyle(document.documentElement).getPropertyValue('--md-sys-typescale-body-medium-font-weight').trim()
                },
                color: getComputedStyle(document.documentElement).getPropertyValue('--md-sys-color-on-surface').trim()
              }
            },
            tooltip: {  // Tooltips deaktiviert - kein Hover-Effekt
            }
          },
          animation: {
            duration: 1000,
            easing: 'easeOutQuart'
          }
        }
      };
      
      // Chart erstellen
      new Chart(canvas, chartConfig);
      
      // Nachdem die Chart erstellt wurde, Loading Indicator ausblenden
      console.log('Chart erstellt, verstecke Loading Indicator...');
      
      // Kurze Verzögerung hinzufügen, um sicherzustellen, dass die Chart vollständig gerendert ist
      setTimeout(() => {
        const loadingOverlay = document.getElementById('chart-loading-overlay');
        if (loadingOverlay) {
          loadingOverlay.style.display = 'none';
          console.log('Loading Indicator erfolgreich ausgeblendet');
        } else {
          console.error('Loading Overlay nicht gefunden');
        }
      }, 300); // 300ms Verzögerung für sicheres Rendern
      
    } catch (error) {
      console.error('Fehler beim Initialisieren der Lieferungs-Chart:', error);
    }
  }
  
  // Chart nach DOM-Laden initialisieren
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(initDeliveryChart, 500); // Verzögerung, um sicherzustellen, dass Chart.js geladen ist
  });
</script>

<!-- Material Web Components für MD3 Loading Indicator -->
<script type="module" src="https://cdn.jsdelivr.net/npm/@material/web@latest/progress/circular-progress.js"></script>

{% endblock %}


