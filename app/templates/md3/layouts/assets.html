{% extends "base.html" %}

{% block title %}Assets{% endblock %}

{% block head %}
{{ super() }}
<style>
/* MD3 Asset Modal System - Clean Version */
:root {
  --md-sys-color-primary: #6750a4;
  --md-sys-color-on-primary: #ffffff;
  --md-sys-color-primary-container: #eaddff;
  --md-sys-color-on-primary-container: #21005d;
  --md-sys-color-surface: #ffffff;
  --md-sys-color-on-surface: #1c1b1f;
  --md-sys-color-surface-variant: #f3f0f4;
  --md-sys-color-on-surface-variant: #49454f;
  --md-sys-color-outline: #79747e;
  --md-sys-color-outline-variant: #e0e0e0;
  --md-sys-elevation-level5: 0 8px 12px rgba(0,0,0,0.15);
}

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
@keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

.md3-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 24px;
}

.md3-assets-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 32px;
}

.md3-assets-title {
  font-size: 32px;
  font-weight: 500;
  color: var(--md-sys-color-on-surface);
  margin: 0;
}

.md3-action-buttons {
  display: flex;
  gap: 12px;
}

.md3-action-btn {
  padding: 12px 24px;
  border-radius: 20px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  border: none;
  transition: all 0.2s ease;
}

.md3-action-btn .material-symbols-outlined {
  font-size: 18px;
}

.md3-primary-btn {
  background: var(--md-sys-color-primary);
  color: var(--md-sys-color-on-primary);
}

.md3-primary-btn:hover {
  background: var(--md-sys-color-primary);
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.md3-secondary-btn {
  background: var(--md-sys-color-surface-variant);
  color: var(--md-sys-color-on-surface-variant);
  border: 1px solid var(--md-sys-color-outline);
}

.md3-secondary-btn:hover {
  background: var(--md-sys-color-surface-variant);
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.md3-delete-btn {
  transition: all 0.2s ease;
}

.md3-delete-btn:hover {
  background: var(--md-sys-color-error-container);
  border-radius: 50%;
}

.md3-delete-btn:hover .material-symbols-outlined {
  color: var(--md-sys-color-on-error-container) !important;
}

.md3-checkbox {
  accent-color: var(--md-sys-color-primary);
}

.md3-asset-table {
  width: 100%;
  border-collapse: collapse;
  background: var(--md-sys-color-surface);
  border-radius: 12px;
  overflow: hidden;
  box-shadow: var(--md-sys-elevation-level5);
}

.md3-asset-table th {
  background: var(--md-sys-color-surface-variant);
  color: var(--md-sys-color-on-surface-variant);
  padding: 16px;
  text-align: left;
  font-weight: 500;
  border-bottom: 1px solid var(--md-sys-color-outline-variant);
}

.md3-asset-table td {
  padding: 16px;
  border-bottom: 1px solid var(--md-sys-color-outline-variant);
  vertical-align: middle;
}

.md3-asset-table tr:hover {
  background: var(--md-sys-color-surface-variant);
}

.md3-action-icon {
  background: transparent;
  border: none;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--md-sys-color-on-surface-variant);
  transition: all 0.2s ease;
}

.md3-action-icon:hover {
  background: var(--md-sys-color-surface-variant);
  color: var(--md-sys-color-primary);
}

.md3-status-badge {
  padding: 4px 12px;
  border-radius: 16px;
  font-size: 12px;
  font-weight: 500;
}

.status-active {
  background: var(--md-sys-color-primary-container);
  color: var(--md-sys-color-on-primary-container);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  console.log('🎉 MD3 Asset Modal System geladen!');
  
  // Einzel-Asset-Modal öffnen
  window.openSingleAssetModal = function(assetData) {
    console.log('🔍 Öffne Asset-Details-Modal für:', assetData);
    
    // Korrekte API-Route verwenden: POST /api/assets/details mit asset_ids Array
    fetch('/api/assets/details', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
      },
      body: JSON.stringify({
        asset_ids: [assetData.assetId]
      })
    })
      .then(response => response.json())
      .then(data => {
        if (!data.success || !data.assets || data.assets.length === 0) {
          throw new Error('Asset-Daten konnten nicht geladen werden');
        }
        
        const asset = data.assets[0]; // Erstes (und einziges) Asset aus der Antwort
        console.log('📊 Asset-Daten erhalten:', asset);
        
        const modal = document.createElement('div');
        modal.id = 'single-asset-modal';
        modal.style.cssText = `
          position: fixed; top: 0; left: 0; width: 100%; height: 100%;
          background: rgba(0, 0, 0, 0.5); display: flex; justify-content: center;
          align-items: center; z-index: 10000; animation: fadeIn 0.3s ease-out;
        `;
        
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
          background: var(--md-sys-color-surface, #ffffff); border-radius: 28px;
          max-width: 95vw; max-height: 95vh; width: 1000px;
          box-shadow: var(--md-sys-elevation-level5, 0 8px 12px rgba(0,0,0,0.15));
          overflow: hidden; animation: slideUp 0.3s ease-out;
        `;
        
        modalContent.innerHTML = `
          <div style="background: var(--md-sys-color-surface, #ffffff); padding: 16px 24px;
                      border-bottom: 1px solid var(--md-sys-color-outline-variant, #e0e0e0);
                      display: flex; justify-content: flex-end; align-items: center;">
            <button onclick="closeSingleAssetModal()" class="material-symbols-outlined"
                    style="background: transparent; border: none; border-radius: 50%; width: 40px; height: 40px;
                           cursor: pointer; font-size: 20px; color: var(--md-sys-color-on-surface-variant, #49454f);">close</button>
          </div>
          <div style="padding: 24px;">
            <h2 style="margin: 0 0 16px 0; color: var(--md-sys-color-on-surface); font-size: 24px; font-weight: 500;">${asset.name}</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
              <div style="padding: 16px; background: #ffffff; border: 1px solid #e0e0e0; border-radius: 16px;">
                <h4 style="margin: 0 0 8px 0; color: #6750a4; font-size: 14px; font-weight: 500;">Status</h4>
                <div style="color: #1c1b1f; font-size: 16px;">${asset.status === 'active' ? 'Aktiv' : 'Inaktiv'}</div>
              </div>
              <div style="padding: 16px; background: #ffffff; border: 1px solid #e0e0e0; border-radius: 16px;">
                <h4 style="margin: 0 0 8px 0; color: #6750a4; font-size: 14px; font-weight: 500;">Kategorie</h4>
                <div style="color: #1c1b1f; font-size: 16px;">${asset.category ? asset.category.name : 'Keine Kategorie'}</div>
              </div>
              <div style="padding: 16px; background: #ffffff; border: 1px solid #e0e0e0; border-radius: 16px;">
                <h4 style="margin: 0 0 8px 0; color: #6750a4; font-size: 14px; font-weight: 500;">Standort</h4>
                <div style="color: #1c1b1f; font-size: 16px;">${asset.location_obj ? asset.location_obj.name : 'Kein Standort'}</div>
              </div>
              <div style="padding: 16px; background: #ffffff; border: 1px solid #e0e0e0; border-radius: 16px;">
                <h4 style="margin: 0 0 8px 0; color: #6750a4; font-size: 14px; font-weight: 500;">Wert</h4>
                <div style="color: #1c1b1f; font-size: 16px;">${asset.value ? parseFloat(asset.value).toFixed(2) + ' €' : '0.00 €'}</div>
              </div>
            </div>
            <div style="margin-top: 24px; display: flex; gap: 12px; justify-content: flex-end; flex-wrap: wrap;">
              <button onclick="closeSingleAssetModal(); loadAssetForEdit(${asset.id})" class="md3-action-btn md3-primary-btn">
                <span class="material-symbols-outlined" style="font-size: 18px;">edit</span>Bearbeiten
              </button>
              <button onclick="window.location.href='/md3/assets/${asset.id}/documents'" style="
                background: #ffd8e4; color: #31111d; border: none; padding: 8px 16px; border-radius: 20px;
                font-size: 14px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                <span class="material-symbols-outlined" style="font-size: 18px;">description</span>Dokumente
              </button>
              ${asset.status === 'active' ? `
                <button onclick="closeSingleAssetModal(); openLoanModal(${asset.id})" style="
                  background: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); border: none; 
                  padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 500; cursor: pointer; 
                  display: flex; align-items: center; gap: 8px;">
                  <span class="material-symbols-outlined" style="font-size: 18px;">local_shipping</span>Ausleihen
                </button>
              ` : asset.status === 'on_loan' ? `
                <button onclick="returnAsset(${asset.id})" style="
                  background: var(--md-sys-color-secondary); color: var(--md-sys-color-on-secondary); border: none; 
                  padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 500; cursor: pointer; 
                  display: flex; align-items: center; gap: 8px;">
                  <span class="material-symbols-outlined" style="font-size: 18px;">undo</span>Zurückgeben
                </button>
              ` : ''}
            </div>
          </div>
        `;
        
        modal.appendChild(modalContent);
        modal.addEventListener('click', (e) => { if (e.target === modal) closeSingleAssetModal(); });
        document.body.appendChild(modal);
        document.body.style.overflow = 'hidden';
      })
      .catch(error => {
        console.error('❌ Fehler beim Laden der Asset-Details:', error);
        alert('Asset-Details konnten nicht geladen werden.');
      });
  };
  
  window.closeSingleAssetModal = function() {
    const modal = document.getElementById('single-asset-modal');
    if (modal) {
      modal.style.animation = 'fadeOut 0.2s ease-in';
      setTimeout(() => { modal.remove(); document.body.style.overflow = ''; }, 200);
    }
  };
  
  // Gruppen-Modal öffnen
  window.openGroupDetailsDialog = function(groupIds, groupName) {
    console.log('🔍 Öffne Gruppen-Modal für:', groupName, 'IDs:', groupIds);
    
    const existingModal = document.getElementById('group-modal');
    if (existingModal) existingModal.remove();
    
    const assetIds = typeof groupIds === 'string' ? groupIds.split(',') : groupIds;
    
    const modal = document.createElement('div');
    modal.id = 'group-modal';
    modal.style.cssText = `
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5); display: flex; justify-content: center;
      align-items: center; z-index: 10000; animation: fadeIn 0.3s ease-out;
    `;
    
    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
      background: var(--md-sys-color-surface, #ffffff); border-radius: 28px;
      max-width: 95vw; max-height: 95vh; width: 1000px;
      box-shadow: var(--md-sys-elevation-level5, 0 8px 12px rgba(0,0,0,0.15));
      overflow: hidden; animation: slideUp 0.3s ease-out;
    `;
    
    const testAssets = assetIds.map((id, index) => ({
      id: id,
      name: `Asset ${index + 1}`,
      category: { name: 'Test Kategorie' },
      status: 'active',
      location: { name: 'Test Standort' },
      value: (Math.random() * 1000).toFixed(2)
    }));
    
    modalContent.innerHTML = `
      <div style="padding: 24px 24px 16px 24px; border-bottom: 1px solid var(--md-sys-color-outline-variant, #e0e0e0);
                  display: flex; justify-content: space-between; align-items: center;">
        <div>
          <h2 style="margin: 0 0 4px 0; font-size: 24px; font-weight: 500; color: var(--md-sys-color-on-surface, #1c1b1f);">${groupName}</h2>
          <p style="margin: 0; font-size: 14px; color: var(--md-sys-color-on-surface-variant, #49454f);">${assetIds.length} Assets in dieser Gruppe</p>
        </div>
        <button onclick="closeGroupModal()" style="background: transparent; border: none; border-radius: 50%; width: 40px; height: 40px;
                cursor: pointer; display: flex; align-items: center; justify-content: center;
                color: var(--md-sys-color-on-surface-variant, #49454f);">
          <span class="material-symbols-outlined" style="font-size: 20px;">close</span>
        </button>
      </div>
      <div style="padding: 24px; max-height: 60vh; overflow-y: auto;">
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;">
          ${testAssets.map(asset => `
            <div style="background: #ffffff; border: 1px solid #e0e0e0; border-radius: 16px; padding: 16px;
                        transition: all 0.2s ease; cursor: pointer;"
                 onclick="openSingleAssetModal({assetId: '${asset.id}', assetName: '${asset.name}'})"
                 onmouseover="this.style.boxShadow='0 4px 16px rgba(0,0,0,0.1)'; this.style.transform='translateY(-2px)'"
                 onmouseout="this.style.boxShadow='none'; this.style.transform='translateY(0)'">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                <h3 style="margin: 0; font-size: 16px; font-weight: 500; color: #1c1b1f;">${asset.name}</h3>
                <span style="background: #eaddff; color: #21005d; padding: 4px 8px; border-radius: 8px;
                             font-size: 12px; font-weight: 500;">Aktiv</span>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 14px; color: #49454f;">
                <div><div style="font-weight: 500; margin-bottom: 2px;">Kategorie</div><div>${asset.category.name}</div></div>
                <div><div style="font-weight: 500; margin-bottom: 2px;">Standort</div><div>${asset.location_obj.name}</div></div>
                <div><div style="font-weight: 500; margin-bottom: 2px;">Wert</div><div style="font-weight: 500; color: #6750a4;">${asset.value} €</div></div>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    `;
    
    modal.appendChild(modalContent);
    modal.addEventListener('click', (e) => { if (e.target === modal) closeGroupModal(); });
    document.body.appendChild(modal);
    document.body.style.overflow = 'hidden';
  };
  
  window.closeGroupModal = function() {
    const modal = document.getElementById('group-modal');
    if (modal) {
      modal.style.animation = 'fadeOut 0.2s ease-in';
      setTimeout(() => { modal.remove(); document.body.style.overflow = ''; }, 200);
    }
  };
  
  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
      closeSingleAssetModal();
      closeGroupModal();
    }
  });

  // Navigation Button Event Handlers
  document.querySelectorAll('.md3-nav-btn').forEach(button => {
    button.addEventListener('click', function() {
      const href = this.getAttribute('data-href');
      if (href) {
        window.location.href = href;
      }
    });
  });

  // Master Checkbox - Select/Deselect All
  const masterCheckbox = document.getElementById('select-all');
  const assetCheckboxes = document.querySelectorAll('input[name="selected_assets"]');
  
  if (masterCheckbox) {
    masterCheckbox.addEventListener('change', function() {
      const isChecked = this.checked;
      assetCheckboxes.forEach(checkbox => {
        if (checkbox) {
          checkbox.checked = isChecked;
        }
      });
    });
  }

  // Update Master Checkbox when individual checkboxes change
  if (assetCheckboxes.length > 0) {
    assetCheckboxes.forEach(checkbox => {
      if (checkbox) {
        checkbox.addEventListener('change', function() {
          const checkedCount = document.querySelectorAll('input[name="selected_assets"]:checked').length;
          const totalCount = assetCheckboxes.length;
          
          if (masterCheckbox) {
            if (checkedCount === 0) {
              masterCheckbox.checked = false;
              masterCheckbox.indeterminate = false;
            } else if (checkedCount === totalCount) {
              masterCheckbox.checked = true;
              masterCheckbox.indeterminate = false;
            } else {
              masterCheckbox.checked = false;
              masterCheckbox.indeterminate = true;
            }
          }
        });
      }
    });
  }

  // Neues Asset Modal öffnen
  window.openNewAssetModal = function() {
    console.log('🆕 Öffne Neues Asset Modal');
    
    // Aktualisiere Dropdown-Daten über AJAX
    fetch('/api/dropdown-data')
      .then(response => response.json())
      .then(dropdownData => {
        createAssetModal(dropdownData);
      })
      .catch(error => {
        console.error('Fehler beim Laden der Dropdown-Daten:', error);
        // Fallback mit leeren Daten
        createAssetModal({categories: [], manufacturers: [], suppliers: [], assignments: [], locations: []});
      });
  };
  
  function createAssetModal(dropdownData) {
    console.log('📊 Dropdown-Daten geladen:', dropdownData);
    
    const modal = document.createElement('div');
    modal.id = 'new-asset-modal';
    modal.style.cssText = `
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5); display: flex; justify-content: center;
      align-items: center; z-index: 10000; animation: fadeIn 0.3s ease-out;
      overflow-y: auto; padding: 20px 0;
    `;
    
    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
      background: var(--md-sys-color-surface, #ffffff); border-radius: 28px;
      max-width: 95vw; width: 1200px; max-height: 90vh;
      box-shadow: var(--md-sys-elevation-level5, 0 8px 12px rgba(0,0,0,0.15));
      overflow: hidden; animation: slideUp 0.3s ease-out;
      margin: auto;
    `;
    
    modalContent.innerHTML = `
      <!-- Modal Header -->
      <div style="background: var(--md-sys-color-surface, #ffffff); padding: 24px;
                  border-bottom: 1px solid var(--md-sys-color-outline-variant, #e0e0e0);
                  display: flex; justify-content: space-between; align-items: center;">
        <h2 style="margin: 0; color: var(--md-sys-color-on-surface); font-size: 24px; font-weight: 500;">Neues Asset</h2>
        <button onclick="closeNewAssetModal()" class="material-symbols-outlined"
                style="background: transparent; border: none; border-radius: 50%; width: 40px; height: 40px;
                       cursor: pointer; font-size: 20px; color: var(--md-sys-color-on-surface-variant, #49454f);">close</button>
      </div>
      
      <!-- Modal Content -->
      <div style="padding: 24px; overflow-y: auto; max-height: calc(90vh - 120px);">
        <form id="new-asset-form" method="POST" action="{{ url_for('main.add_asset') }}" enctype="multipart/form-data">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
            <!-- Linke Spalte: Asset Details -->
            <div>
              <h3 style="margin: 0 0 16px 0; color: var(--md-sys-color-primary); font-size: 18px; font-weight: 500;">Asset Details</h3>
              
              <!-- Bild Upload -->
              <div class="md3-field" style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; color: var(--md-sys-color-on-surface); font-size: 14px; font-weight: 500;">Bild</label>
                <div style="border: 2px dashed var(--md-sys-color-outline); border-radius: 12px; padding: 24px; text-align: center; background: var(--md-sys-color-surface-variant);">
                  <input type="file" name="image" accept="image/*" onchange="updateImagePreview(this)" style="display: none;" id="asset-image-input">
                  <button type="button" onclick="document.getElementById('asset-image-input').click()" style="background: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); border: none; padding: 12px 24px; border-radius: 20px; cursor: pointer;">
                    <span class="material-symbols-outlined" style="margin-right: 8px;">upload</span>Bild auswählen
                  </button>
                  <div id="image-preview-container" style="margin-top: 16px; display: none;">
                    <img id="image-preview" style="max-width: 200px; max-height: 200px; border-radius: 8px;">
                  </div>
                </div>
              </div>
              
              <!-- Name -->
              <div class="md3-field" style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; color: var(--md-sys-color-on-surface); font-size: 14px; font-weight: 500;">Name *</label>
                <input type="text" name="name" required style="width: 100%; padding: 16px; border: 1px solid var(--md-sys-color-outline); border-radius: 8px; font-size: 16px;">
              </div>
              
              <!-- Artikelnummer -->
              <div class="md3-field" style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; color: var(--md-sys-color-on-surface); font-size: 14px; font-weight: 500;">Artikelnummer</label>
                <input type="text" name="article_number" style="width: 100%; padding: 16px; border: 1px solid var(--md-sys-color-outline); border-radius: 8px; font-size: 16px;">
              </div>
              
              <!-- Beschreibung -->
              <div class="md3-field" style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; color: var(--md-sys-color-on-surface); font-size: 14px; font-weight: 500;">Beschreibung</label>
                <textarea name="description" rows="3" style="width: 100%; padding: 16px; border: 1px solid var(--md-sys-color-outline); border-radius: 8px; font-size: 16px; resize: vertical;"></textarea>
              </div>
              
              <!-- Wert -->
              <div class="md3-field" style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; color: var(--md-sys-color-on-surface); font-size: 14px; font-weight: 500;">Wert (€)</label>
                <input type="number" name="value" step="0.01" min="0" style="width: 100%; padding: 16px; border: 1px solid var(--md-sys-color-outline); border-radius: 8px; font-size: 16px;">
              </div>
            </div>
            
            <!-- Rechte Spalte: Zuordnungen -->
            <div>
              <h3 style="margin: 0 0 16px 0; color: var(--md-sys-color-primary); font-size: 18px; font-weight: 500;">Zuordnungen</h3>
              
              <!-- Kategorie -->
              <div class="md3-field" style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; color: var(--md-sys-color-on-surface); font-size: 14px; font-weight: 500;">Kategorie</label>
                <select name="category" style="width: 100%; padding: 16px; border: 1px solid var(--md-sys-color-outline); border-radius: 8px; font-size: 16px;">
                  <option value="">Kategorie auswählen...</option>
                  ${dropdownData.categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('')}
                </select>
              </div>
              
              <!-- Standort -->
              <div class="md3-field" style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; color: var(--md-sys-color-on-surface); font-size: 14px; font-weight: 500;">Standort</label>
                <select name="location_id" style="width: 100%; padding: 16px; border: 1px solid var(--md-sys-color-outline); border-radius: 8px; font-size: 16px;">
                  <option value="">Standort auswählen...</option>
                  ${dropdownData.locations.map(loc => `<option value="${loc.id}">${loc.name}</option>`).join('')}
                </select>
              </div>
              
              <!-- Hersteller -->
              <div class="md3-field" style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; color: var(--md-sys-color-on-surface); font-size: 14px; font-weight: 500;">Hersteller</label>
                <select name="manufacturers" style="width: 100%; padding: 16px; border: 1px solid var(--md-sys-color-outline); border-radius: 8px; font-size: 16px;">
                  <option value="">Hersteller auswählen...</option>
                  ${dropdownData.manufacturers.map(mfg => `<option value="${mfg.id}">${mfg.name}</option>`).join('')}
                </select>
              </div>
              
              <!-- Lieferant -->
              <div class="md3-field" style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; color: var(--md-sys-color-on-surface); font-size: 14px; font-weight: 500;">Lieferant</label>
                <select name="suppliers" style="width: 100%; padding: 16px; border: 1px solid var(--md-sys-color-outline); border-radius: 8px; font-size: 16px;">
                  <option value="">Lieferant auswählen...</option>
                  ${dropdownData.suppliers.map(sup => `<option value="${sup.id}">${sup.name}</option>`).join('')}
                </select>
              </div>
              
              <!-- Zuordnung -->
              <div class="md3-field" style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; color: var(--md-sys-color-on-surface); font-size: 14px; font-weight: 500;">Zuordnung</label>
                <select name="assignments" style="width: 100%; padding: 16px; border: 1px solid var(--md-sys-color-outline); border-radius: 8px; font-size: 16px;">
                  <option value="">Zuordnung auswählen...</option>
                  ${dropdownData.assignments.map(assgn => `<option value="${assgn.id}">${assgn.name}</option>`).join('')}
                </select>
              </div>
              
              <!-- Status -->
              <div class="md3-field" style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; color: var(--md-sys-color-on-surface); font-size: 14px; font-weight: 500;">Status</label>
                <select name="status" style="width: 100%; padding: 16px; border: 1px solid var(--md-sys-color-outline); border-radius: 8px; font-size: 16px;">
                  <option value="active" selected>Aktiv</option>
                  <option value="inactive">Inaktiv</option>
                  <option value="on_loan">Ausgeliehen</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- Modal Footer -->
          <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--md-sys-color-outline-variant); display: flex; gap: 12px; justify-content: flex-end;">
            <button type="button" onclick="closeNewAssetModal()" class="md3-action-btn md3-secondary-btn">
              <span class="material-symbols-outlined" style="margin-right: 8px;">close</span>Abbrechen
            </button>
            <button type="submit" class="md3-action-btn md3-primary-btn">
              <span class="material-symbols-outlined" style="margin-right: 8px;">save</span>Asset erstellen
            </button>
          </div>
        </form>
      </div>
    `;
    
    modal.appendChild(modalContent);
    modal.addEventListener('click', (e) => { if (e.target === modal) closeNewAssetModal(); });
    document.body.appendChild(modal);
    document.body.style.overflow = 'hidden';
  };
  
  window.closeNewAssetModal = function() {
    const modal = document.getElementById('new-asset-modal');
    if (modal) {
      modal.style.animation = 'fadeOut 0.3s ease-out';
      setTimeout(() => {
        document.body.removeChild(modal);
        document.body.style.overflow = '';
      }, 300);
    }
  };
  
  window.updateImagePreview = function(input) {
    const preview = document.getElementById('image-preview');
    const container = document.getElementById('image-preview-container');
    
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = function(e) {
        preview.src = e.target.result;
        container.style.display = 'block';
      };
      reader.readAsDataURL(input.files[0]);
    } else {
      container.style.display = 'none';
    }
  };

  // Delete Asset Functionality - with null checks
  document.querySelectorAll('.md3-delete-btn').forEach(button => {
    if (button) {
      button.addEventListener('click', function() {
        const assetId = this.getAttribute('data-asset-id');
        const assetName = this.getAttribute('data-asset-name');
      
      if (confirm(`Sind Sie sicher, dass Sie das Asset "${assetName}" löschen möchten?\n\nDiese Aktion kann nicht rückgängig gemacht werden.`)) {
        // Send DELETE request to backend
        fetch(`/assets/${assetId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value || document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Remove the row from the table
            this.closest('tr').remove();
            
            // Show success message
            alert(`Asset "${assetName}" wurde erfolgreich gelöscht.`);
            
            // Reload to update counts
            window.location.reload();
          } else {
            throw new Error(data.error || 'Fehler beim Löschen');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert(`Fehler beim Löschen des Assets "${assetName}". Bitte versuchen Sie es erneut.`);
        });
      }
      });
    }
  });

  // Asset bearbeiten Modal öffnen
  window.openEditAssetModal = function(assetId) {
    console.log('✏️ Öffne Asset bearbeiten Modal für ID:', assetId);
    
    // Lade Asset-Daten vom Server
    fetch(`/api/assets/details`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value || ''
      },
      body: JSON.stringify({ asset_ids: [assetId] })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success && data.assets && data.assets.length > 0) {
        const asset = data.assets[0];
        showEditAssetModal(asset);
      } else {
        console.error('Asset nicht gefunden:', data);
        alert('Asset konnte nicht geladen werden.');
      }
    })
    .catch(error => {
      console.error('Fehler beim Laden des Assets:', error);
      alert('Fehler beim Laden des Assets.');
    });
  };
  
  function showEditAssetModal(asset) {
    const modal = document.createElement('div');
    modal.id = 'edit-asset-modal';
    modal.style.cssText = `
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5); display: flex; justify-content: center;
      align-items: flex-start; z-index: 10000; animation: fadeIn 0.3s ease-out;
      overflow-y: auto; padding: 20px 0;
    `;
    
    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
      background: var(--md-sys-color-surface);
      border-radius: 28px;
      box-shadow: var(--md-sys-elevation-level5);
      width: 95vw;
      max-width: 900px;
      max-height: 90vh;
      overflow-y: auto;
      animation: slideUp 0.3s ease-out;
      margin: 20px auto;
    `;
    
    modalContent.innerHTML = `
      <div style="padding: 32px;">
        <!-- Modal Header -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
          <h2 style="
            font-family: var(--md-sys-typescale-headline-small-font-family-name);
            font-size: var(--md-sys-typescale-headline-small-font-size);
            font-weight: var(--md-sys-typescale-headline-small-font-weight);
            color: var(--md-sys-color-on-surface);
            margin: 0;
          ">Asset bearbeiten</h2>
          <button onclick="closeEditAssetModal()" style="
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 20px;
            color: var(--md-sys-color-on-surface-variant);
          ">
            <span class="material-symbols-outlined" style="font-size: 24px;">close</span>
          </button>
        </div>
        
        <!-- Asset bearbeiten Form -->
        <form id="edit-asset-form" method="POST" enctype="multipart/form-data">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="asset_id" id="edit-asset-id">
          
          <!-- Zwei-Spalten Layout -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
            
            <!-- Linke Spalte: Asset Details -->
            <div>
              <h3 style="
                font-family: var(--md-sys-typescale-title-medium-font-family-name);
                font-size: var(--md-sys-typescale-title-medium-font-size);
                font-weight: var(--md-sys-typescale-title-medium-font-weight);
                color: var(--md-sys-color-on-surface);
                margin: 0 0 16px 0;
              ">Asset Details</h3>
              
              <!-- Asset Name -->
              <div style="margin-bottom: 16px;">
                <label style="
                  display: block;
                  font-family: var(--md-sys-typescale-body-small-font-family-name);
                  font-size: var(--md-sys-typescale-body-small-font-size);
                  font-weight: var(--md-sys-typescale-body-small-font-weight);
                  color: var(--md-sys-color-on-surface-variant);
                  margin-bottom: 8px;
                ">Name *</label>
                <input type="text" name="name" value="${asset.name || ''}" required style="
                  width: 100%;
                  padding: 16px;
                  border: 1px solid var(--md-sys-color-outline);
                  border-radius: 8px;
                  background: var(--md-sys-color-surface);
                  color: var(--md-sys-color-on-surface);
                  font-family: var(--md-sys-typescale-body-large-font-family-name);
                  font-size: var(--md-sys-typescale-body-large-font-size);
                  box-sizing: border-box;
                ">
              </div>
              
              <!-- Artikelnummer -->
              <div style="margin-bottom: 16px;">
                <label style="
                  display: block;
                  font-family: var(--md-sys-typescale-body-small-font-family-name);
                  font-size: var(--md-sys-typescale-body-small-font-size);
                  font-weight: var(--md-sys-typescale-body-small-font-weight);
                  color: var(--md-sys-color-on-surface-variant);
                  margin-bottom: 8px;
                ">Artikelnummer</label>
                <input type="text" name="article_number" value="${asset.article_number || ''}" style="
                  width: 100%;
                  padding: 16px;
                  border: 1px solid var(--md-sys-color-outline);
                  border-radius: 8px;
                  background: var(--md-sys-color-surface);
                  color: var(--md-sys-color-on-surface);
                  font-family: var(--md-sys-typescale-body-large-font-family-name);
                  font-size: var(--md-sys-typescale-body-large-font-size);
                  box-sizing: border-box;
                ">
              </div>
              
              <!-- EAN -->
              <div style="margin-bottom: 16px;">
                <label style="
                  display: block;
                  font-family: var(--md-sys-typescale-body-small-font-family-name);
                  font-size: var(--md-sys-typescale-body-small-font-size);
                  font-weight: var(--md-sys-typescale-body-small-font-weight);
                  color: var(--md-sys-color-on-surface-variant);
                  margin-bottom: 8px;
                ">EAN</label>
                <input type="text" name="ean" value="${asset.ean || ''}" style="
                  width: 100%;
                  padding: 16px;
                  border: 1px solid var(--md-sys-color-outline);
                  border-radius: 8px;
                  background: var(--md-sys-color-surface);
                  color: var(--md-sys-color-on-surface);
                  font-family: var(--md-sys-typescale-body-large-font-family-name);
                  font-size: var(--md-sys-typescale-body-large-font-size);
                  box-sizing: border-box;
                ">
              </div>
              
              <!-- Wert -->
              <div style="margin-bottom: 16px;">
                <label style="
                  display: block;
                  font-family: var(--md-sys-typescale-body-small-font-family-name);
                  font-size: var(--md-sys-typescale-body-small-font-size);
                  font-weight: var(--md-sys-typescale-body-small-font-weight);
                  color: var(--md-sys-color-on-surface-variant);
                  margin-bottom: 8px;
                ">Wert (€)</label>
                <input type="number" name="value" value="${asset.value || ''}" step="0.01" style="
                  width: 100%;
                  padding: 16px;
                  border: 1px solid var(--md-sys-color-outline);
                  border-radius: 8px;
                  background: var(--md-sys-color-surface);
                  color: var(--md-sys-color-on-surface);
                  font-family: var(--md-sys-typescale-body-large-font-family-name);
                  font-size: var(--md-sys-typescale-body-large-font-size);
                  box-sizing: border-box;
                ">
              </div>
              
              <!-- Seriennummer -->
              <div style="margin-bottom: 16px;">
                <label style="
                  display: block;
                  font-family: var(--md-sys-typescale-body-small-font-family-name);
                  font-size: var(--md-sys-typescale-body-small-font-size);
                  font-weight: var(--md-sys-typescale-body-small-font-weight);
                  color: var(--md-sys-color-on-surface-variant);
                  margin-bottom: 8px;
                ">Seriennummer</label>
                <input type="text" name="serial_number" value="${asset.serial_number || ''}" style="
                  width: 100%;
                  padding: 16px;
                  border: 1px solid var(--md-sys-color-outline);
                  border-radius: 8px;
                  background: var(--md-sys-color-surface);
                  color: var(--md-sys-color-on-surface);
                  font-family: var(--md-sys-typescale-body-large-font-family-name);
                  font-size: var(--md-sys-typescale-body-large-font-size);
                  box-sizing: border-box;
                ">
              </div>
              
              <!-- Kaufdatum -->
              <div style="margin-bottom: 16px;">
                <label style="
                  display: block;
                  font-family: var(--md-sys-typescale-body-small-font-family-name);
                  font-size: var(--md-sys-typescale-body-small-font-size);
                  font-weight: var(--md-sys-typescale-body-small-font-weight);
                  color: var(--md-sys-color-on-surface-variant);
                  margin-bottom: 8px;
                ">Kaufdatum</label>
                <input type="date" name="purchase_date" value="${asset.purchase_date || ''}" style="
                  width: 100%;
                  padding: 16px;
                  border: 1px solid var(--md-sys-color-outline);
                  border-radius: 8px;
                  background: var(--md-sys-color-surface);
                  color: var(--md-sys-color-on-surface);
                  font-family: var(--md-sys-typescale-body-large-font-family-name);
                  font-size: var(--md-sys-typescale-body-large-font-size);
                  box-sizing: border-box;
                ">
              </div>
              
              <!-- Beschreibung -->
              <div style="margin-bottom: 16px;">
                <label style="
                  display: block;
                  font-family: var(--md-sys-typescale-body-small-font-family-name);
                  font-size: var(--md-sys-typescale-body-small-font-size);
                  font-weight: var(--md-sys-typescale-body-small-font-weight);
                  color: var(--md-sys-color-on-surface-variant);
                  margin-bottom: 8px;
                ">Beschreibung</label>
                <textarea name="description" rows="3" style="
                  width: 100%;
                  padding: 16px;
                  border: 1px solid var(--md-sys-color-outline);
                  border-radius: 8px;
                  background: var(--md-sys-color-surface);
                  color: var(--md-sys-color-on-surface);
                  font-family: var(--md-sys-typescale-body-large-font-family-name);
                  font-size: var(--md-sys-typescale-body-large-font-size);
                  box-sizing: border-box;
                  resize: vertical;
                ">${asset.description || ''}</textarea>
              </div>
            </div>
            
            <!-- Rechte Spalte: Zuordnungen & Bild -->
            <div>
              <h3 style="
                font-family: var(--md-sys-typescale-title-medium-font-family-name);
                font-size: var(--md-sys-typescale-title-medium-font-size);
                font-weight: var(--md-sys-typescale-title-medium-font-weight);
                color: var(--md-sys-color-on-surface);
                margin: 0 0 16px 0;
              ">Zuordnungen</h3>
              
              <!-- Kategorie -->
              <div style="margin-bottom: 16px;">
                <label style="
                  display: block;
                  font-family: var(--md-sys-typescale-body-small-font-family-name);
                  font-size: var(--md-sys-typescale-body-small-font-size);
                  font-weight: var(--md-sys-typescale-body-small-font-weight);
                  color: var(--md-sys-color-on-surface-variant);
                  margin-bottom: 8px;
                ">Kategorie</label>
                <select name="category_id" id="edit-category-id" style="
                  width: 100%;
                  padding: 16px;
                  border: 1px solid var(--md-sys-color-outline);
                  border-radius: 8px;
                  background: var(--md-sys-color-surface);
                  color: var(--md-sys-color-on-surface);
                  font-family: var(--md-sys-typescale-body-large-font-family-name);
                  font-size: var(--md-sys-typescale-body-large-font-size);
                  box-sizing: border-box;
                ">
                  <option value="">Kategorie auswählen...</option>
                </select>
              </div>
              
              <!-- Standort -->
              <div style="margin-bottom: 16px;">
                <label style="
                  display: block;
                  font-family: var(--md-sys-typescale-body-small-font-family-name);
                  font-size: var(--md-sys-typescale-body-small-font-size);
                  font-weight: var(--md-sys-typescale-body-small-font-weight);
                  color: var(--md-sys-color-on-surface-variant);
                  margin-bottom: 8px;
                ">Standort</label>
                <select name="location_id" id="edit-location-id" style="
                  width: 100%;
                  padding: 16px;
                  border: 1px solid var(--md-sys-color-outline);
                  border-radius: 8px;
                  background: var(--md-sys-color-surface);
                  color: var(--md-sys-color-on-surface);
                  font-family: var(--md-sys-typescale-body-large-font-family-name);
                  font-size: var(--md-sys-typescale-body-large-font-size);
                  box-sizing: border-box;
                ">
                  <option value="">Standort auswählen...</option>
                </select>
              </div>
              
              <!-- Status -->
              <div style="margin-bottom: 16px;">
                <label style="
                  display: block;
                  font-family: var(--md-sys-typescale-body-small-font-family-name);
                  font-size: var(--md-sys-typescale-body-small-font-size);
                  font-weight: var(--md-sys-typescale-body-small-font-weight);
                  color: var(--md-sys-color-on-surface-variant);
                  margin-bottom: 8px;
                ">Status</label>
                <select name="status" id="edit-status" style="
                  width: 100%;
                  padding: 16px;
                  border: 1px solid var(--md-sys-color-outline);
                  border-radius: 8px;
                  background: var(--md-sys-color-surface);
                  color: var(--md-sys-color-on-surface);
                  font-family: var(--md-sys-typescale-body-large-font-family-name);
                  font-size: var(--md-sys-typescale-body-large-font-size);
                  box-sizing: border-box;
                ">
                  <option value="Aktiv">Aktiv</option>
                  <option value="Inaktiv">Inaktiv</option>
                  <option value="Wartung">Wartung</option>
                  <option value="Ausgemustert">Ausgemustert</option>
                </select>
              </div>
              
              <!-- Hersteller -->
              <div style="margin-bottom: 16px;">
                <label style="
                  display: block;
                  font-family: var(--md-sys-typescale-body-small-font-family-name);
                  font-size: var(--md-sys-typescale-body-small-font-size);
                  font-weight: var(--md-sys-typescale-body-small-font-weight);
                  color: var(--md-sys-color-on-surface-variant);
                  margin-bottom: 8px;
                ">Hersteller</label>
                <select name="manufacturer_ids[]" id="edit-manufacturers" multiple style="
                  width: 100%;
                  min-height: 80px;
                  padding: 16px;
                  border: 1px solid var(--md-sys-color-outline);
                  border-radius: 8px;
                  background: var(--md-sys-color-surface);
                  color: var(--md-sys-color-on-surface);
                  font-family: var(--md-sys-typescale-body-large-font-family-name);
                  font-size: var(--md-sys-typescale-body-large-font-size);
                  box-sizing: border-box;
                ">
                </select>
                <div style="
                  font-size: 12px;
                  color: var(--md-sys-color-on-surface-variant);
                  margin-top: 4px;
                ">Mehrfachauswahl mit Strg/Cmd + Klick</div>
              </div>
              
              <!-- Lieferant -->
              <div style="margin-bottom: 16px;">
                <label style="
                  display: block;
                  font-family: var(--md-sys-typescale-body-small-font-family-name);
                  font-size: var(--md-sys-typescale-body-small-font-size);
                  font-weight: var(--md-sys-typescale-body-small-font-weight);
                  color: var(--md-sys-color-on-surface-variant);
                  margin-bottom: 8px;
                ">Lieferant</label>
                <select name="supplier_ids[]" id="edit-suppliers" multiple style="
                  width: 100%;
                  min-height: 80px;
                  padding: 16px;
                  border: 1px solid var(--md-sys-color-outline);
                  border-radius: 8px;
                  background: var(--md-sys-color-surface);
                  color: var(--md-sys-color-on-surface);
                  font-family: var(--md-sys-typescale-body-large-font-family-name);
                  font-size: var(--md-sys-typescale-body-large-font-size);
                  box-sizing: border-box;
                ">
                </select>
                <div style="
                  font-size: 12px;
                  color: var(--md-sys-color-on-surface-variant);
                  margin-top: 4px;
                ">Mehrfachauswahl mit Strg/Cmd + Klick</div>
              </div>
              
              <!-- Zuordnungen -->
              <div style="margin-bottom: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                  <label style="
                    font-family: var(--md-sys-typescale-body-small-font-family-name);
                    font-size: var(--md-sys-typescale-body-small-font-size);
                    font-weight: var(--md-sys-typescale-body-small-font-weight);
                    color: var(--md-sys-color-on-surface-variant);
                    margin: 0;
                  ">Zuordnungen</label>
                  <button type="button" onclick="openNewAssignmentModal()" style="
                    background: var(--md-sys-color-primary);
                    color: var(--md-sys-color-on-primary);
                    border: none;
                    border-radius: 50%;
                    width: 24px;
                    height: 24px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    font-size: 16px;
                    font-weight: 500;
                  " title="Neue Zuordnung hinzufügen">+</button>
                </div>
                <select name="assignment_ids[]" id="edit-assignments" multiple style="
                  width: 100%;
                  min-height: 80px;
                  padding: 16px;
                  border: 1px solid var(--md-sys-color-outline);
                  border-radius: 8px;
                  background: var(--md-sys-color-surface);
                  color: var(--md-sys-color-on-surface);
                  font-family: var(--md-sys-typescale-body-large-font-family-name);
                  font-size: var(--md-sys-typescale-body-large-font-size);
                  box-sizing: border-box;
                ">
                </select>
                <div style="
                  font-size: 12px;
                  color: var(--md-sys-color-on-surface-variant);
                  margin-top: 4px;
                ">Mehrfachauswahl mit Strg/Cmd + Klick</div>
              </div>
              
              <!-- Asset Bild -->
              <div style="margin-bottom: 16px;">
                <label style="
                  display: block;
                  font-family: var(--md-sys-typescale-body-small-font-family-name);
                  font-size: var(--md-sys-typescale-body-small-font-size);
                  font-weight: var(--md-sys-typescale-body-small-font-weight);
                  color: var(--md-sys-color-on-surface-variant);
                  margin-bottom: 8px;
                ">Asset Bild</label>
                
                <!-- Aktuelles Bild anzeigen -->
                ${asset.image_url ? `
                  <div style="margin-bottom: 12px;">
                    <img src="${asset.image_url}" alt="${asset.name}" style="
                      width: 100%;
                      max-width: 200px;
                      height: auto;
                      border-radius: 8px;
                      border: 1px solid var(--md-sys-color-outline-variant);
                      object-fit: cover;
                    ">
                  </div>
                ` : ''}
                
                <!-- Bild Upload -->
                <div style="
                  border: 2px dashed var(--md-sys-color-outline);
                  border-radius: 8px;
                  padding: 24px;
                  text-align: center;
                  background: var(--md-sys-color-surface-variant);
                  cursor: pointer;
                  transition: all 0.2s ease;
                " onclick="document.getElementById('edit-image-upload').click()">
                  <span class="material-symbols-outlined" style="
                    font-size: 48px;
                    color: var(--md-sys-color-on-surface-variant);
                    margin-bottom: 8px;
                    display: block;
                  ">cloud_upload</span>
                  <p style="
                    font-family: var(--md-sys-typescale-body-medium-font-family-name);
                    font-size: var(--md-sys-typescale-body-medium-font-size);
                    color: var(--md-sys-color-on-surface-variant);
                    margin: 0;
                  ">Neues Bild hochladen</p>
                  <input type="file" id="edit-image-upload" name="image" accept="image/*" style="display: none;" onchange="updateEditImagePreview(this)">
                </div>
                
                <!-- Bild Vorschau -->
                <div id="edit-image-preview-container" style="display: none; margin-top: 12px;">
                  <img id="edit-image-preview" style="
                    width: 100%;
                    max-width: 200px;
                    height: auto;
                    border-radius: 8px;
                    border: 1px solid var(--md-sys-color-outline-variant);
                    object-fit: cover;
                  ">
                </div>
              </div>
            </div>
          </div>
          
          <!-- Modal Actions -->
          <div style="
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding-top: 24px;
            border-top: 1px solid var(--md-sys-color-outline-variant);
          ">
            <button type="button" onclick="closeEditAssetModal()" style="
              padding: 12px 24px;
              border: 1px solid var(--md-sys-color-outline);
              border-radius: 20px;
              background: var(--md-sys-color-surface);
              color: var(--md-sys-color-on-surface);
              font-family: var(--md-sys-typescale-label-large-font-family-name);
              font-size: var(--md-sys-typescale-label-large-font-size);
              font-weight: var(--md-sys-typescale-label-large-font-weight);
              cursor: pointer;
              transition: all 0.2s ease;
              display: flex;
              align-items: center;
              gap: 8px;
            ">
              <span class="material-symbols-outlined" style="font-size: 18px;">close</span>
              Abbrechen
            </button>
            <button type="button" onclick="submitEditAssetForm()" style="
              padding: 12px 24px;
              border: none;
              border-radius: 20px;
              background: var(--md-sys-color-primary);
              color: var(--md-sys-color-on-primary);
              font-family: var(--md-sys-typescale-label-large-font-family-name);
              font-size: var(--md-sys-typescale-label-large-font-size);
              font-weight: var(--md-sys-typescale-label-large-font-weight);
              cursor: pointer;
              transition: all 0.2s ease;
              display: flex;
              align-items: center;
              gap: 8px;
            ">
              <span class="material-symbols-outlined" style="font-size: 18px;">save</span>
              Asset aktualisieren
            </button>
          </div>
        </form>
      </div>
    `;
    
    modal.appendChild(modalContent);
    document.body.appendChild(modal);
    
    // Click outside to close
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        closeEditAssetModal();
      }
    });
    
    // ESC key to close
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeEditAssetModal();
      }
    });
  }
  
  window.closeEditAssetModal = function() {
    const modal = document.getElementById('edit-asset-modal');
    if (modal) {
      modal.style.animation = 'fadeOut 0.3s ease-out';
      setTimeout(() => {
        modal.remove();
      }, 300);
    }
  };
  
  window.updateEditImagePreview = function(input) {
    const preview = document.getElementById('edit-image-preview');
    const container = document.getElementById('edit-image-preview-container');
    
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = function(e) {
        preview.src = e.target.result;
        container.style.display = 'block';
      };
      reader.readAsDataURL(input.files[0]);
    } else {
      container.style.display = 'none';
    }
  };
  
  // Load asset data for editing
  window.loadAssetForEdit = function(assetId) {
    fetch(`/api/assets/${assetId}`)
      .then(response => response.json())
      .then(data => {
        if (data) {
          showEditAssetModal(data.asset);
          populateEditForm(data);
        }
      })
      .catch(error => {
        console.error('Fehler beim Laden des Assets:', error);
        alert('Fehler beim Laden des Assets.');
      });
  };
  
  // Populate edit form with asset data
  function populateEditForm(data) {
    const asset = data.asset;
    const form = document.getElementById('edit-asset-form');
    
    // Set asset ID
    document.getElementById('edit-asset-id').value = asset.id;
    
    // Populate basic fields
    form.querySelector('input[name="name"]').value = asset.name || '';
    form.querySelector('input[name="article_number"]').value = asset.article_number || '';
    form.querySelector('input[name="ean"]').value = asset.ean || '';
    form.querySelector('input[name="value"]').value = asset.value || '';
    form.querySelector('input[name="serial_number"]').value = asset.serial_number || '';
    form.querySelector('input[name="purchase_date"]').value = asset.purchase_date || '';
    form.querySelector('textarea[name="description"]').value = asset.description || '';
    
    // Populate categories dropdown
    const categorySelect = document.getElementById('edit-category-id');
    categorySelect.innerHTML = '<option value="">Kategorie auswählen...</option>';
    data.categories.forEach(category => {
      const option = document.createElement('option');
      option.value = category.id;
      option.textContent = category.name;
      if (category.id === asset.category_id) {
        option.selected = true;
      }
      categorySelect.appendChild(option);
    });
    
    // Populate locations dropdown
    const locationSelect = document.getElementById('edit-location-id');
    locationSelect.innerHTML = '<option value="">Standort auswählen...</option>';
    data.locations.forEach(location => {
      const option = document.createElement('option');
      option.value = location.id;
      option.textContent = location.name;
      if (location.id === asset.location_id) {
        option.selected = true;
      }
      locationSelect.appendChild(option);
    });
    
    // Set status - map English to German
    const statusMapping = {
      'active': 'Aktiv',
      'inactive': 'Inaktiv',
      'on_loan': 'Ausgeliehen',
      'defect': 'Defekt',
      'maintenance': 'Wartung',
      'retired': 'Ausgemustert'
    };
    const mappedStatus = statusMapping[asset.status] || asset.status || 'Aktiv';
    document.getElementById('edit-status').value = mappedStatus;
    
    // Populate manufacturers dropdown
    const manufacturerSelect = document.getElementById('edit-manufacturers');
    manufacturerSelect.innerHTML = '';
    data.manufacturers.forEach(manufacturer => {
      const option = document.createElement('option');
      option.value = manufacturer.id;
      option.textContent = manufacturer.name;
      if (asset.manufacturer_ids && asset.manufacturer_ids.includes(manufacturer.id)) {
        option.selected = true;
      }
      manufacturerSelect.appendChild(option);
    });
    
    // Populate suppliers dropdown
    const supplierSelect = document.getElementById('edit-suppliers');
    supplierSelect.innerHTML = '';
    data.suppliers.forEach(supplier => {
      const option = document.createElement('option');
      option.value = supplier.id;
      option.textContent = supplier.name;
      if (asset.supplier_ids && asset.supplier_ids.includes(supplier.id)) {
        option.selected = true;
      }
      supplierSelect.appendChild(option);
    });
    
    // Populate assignments dropdown
    const assignmentSelect = document.getElementById('edit-assignments');
    assignmentSelect.innerHTML = '';
    data.assignments.forEach(assignment => {
      const option = document.createElement('option');
      option.value = assignment.id;
      option.textContent = assignment.name;
      if (asset.assignment_ids && asset.assignment_ids.includes(assignment.id)) {
        option.selected = true;
      }
      assignmentSelect.appendChild(option);
    });
  }
  
  // Submit edit form via AJAX
  window.submitEditAssetForm = function() {
    const form = document.getElementById('edit-asset-form');
    const formData = new FormData(form);
    const assetId = document.getElementById('edit-asset-id').value;
    
    if (!assetId) {
      alert('Asset ID fehlt!');
      return;
    }
    
    fetch(`/api/assets/${assetId}/update`, {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        closeEditAssetModal();
        showNotification(data.message, 'success');
        // Dynamisch nur die Asset-Liste aktualisieren
        refreshAssetList();
      } else {
        showNotification(data.message || 'Fehler beim Speichern', 'error');
      }
    })
    .catch(error => {
      console.error('Fehler beim Speichern:', error);
      showNotification('Fehler beim Speichern des Assets', 'error');
    });
  };
  
  // Show notification function
  function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `md3-notification md3-notification-${type}`;
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: ${type === 'success' ? 'var(--md-sys-color-primary-container)' : 
                   type === 'error' ? 'var(--md-sys-color-error-container)' : 
                   'var(--md-sys-color-surface-container)'};
      color: ${type === 'success' ? 'var(--md-sys-color-on-primary-container)' : 
               type === 'error' ? 'var(--md-sys-color-on-error-container)' : 
               'var(--md-sys-color-on-surface)'};
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: var(--md-sys-elevation-3);
      z-index: 10000;
      font-family: var(--md-sys-typescale-body-medium-font-family);
      font-size: var(--md-sys-typescale-body-medium-font-size);
      font-weight: 500;
      max-width: 400px;
      animation: slideInRight 0.3s ease-out;
    `;
    
    notification.textContent = message;
    document.body.appendChild(notification);
    
    // Auto remove after 4 seconds
    setTimeout(() => {
      notification.style.animation = 'slideOutRight 0.3s ease-in';
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 300);
    }, 4000);
  }
  
  // Add CSS animations for notifications
  if (!document.querySelector('#notification-styles')) {
    const style = document.createElement('style');
    style.id = 'notification-styles';
    style.textContent = `
      @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOutRight {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    `;
    document.head.appendChild(style);
  }
  
  // Refresh asset list dynamically without page reload
  function refreshAssetList() {
    console.log('Aktualisiere Asset-Liste...');
    
    // Get current filter and pagination state
    const currentPage = new URLSearchParams(window.location.search).get('page') || '1';
    const currentCategory = document.querySelector('#category-filter')?.value || '';
    const currentStatus = document.querySelector('#status-filter')?.value || '';
    const currentSearch = document.querySelector('#search-input')?.value || '';
    
    // Build API URL with current filters
    const params = new URLSearchParams();
    if (currentPage !== '1') params.append('page', currentPage);
    if (currentCategory) params.append('category', currentCategory);
    if (currentStatus) params.append('status', currentStatus);
    if (currentSearch) params.append('search', currentSearch);
    
    const apiUrl = `/api/assets?${params.toString()}`;
    
    fetch(apiUrl, {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success && data.assets) {
        updateAssetTable(data.assets, data.pagination);
        console.log('Asset-Liste erfolgreich aktualisiert');
      } else {
        console.error('Fehler beim Laden der Assets:', data.message);
        // Fallback to page reload if API fails
        location.reload();
      }
    })
    .catch(error => {
      console.error('Fehler beim Laden der Asset-Liste:', error);
      // Fallback to page reload if API fails
      location.reload();
    });
  }
  
  // Update asset table with new data
  function updateAssetTable(assets, pagination) {
    const tableBody = document.querySelector('#assets-table tbody');
    if (!tableBody) {
      console.error('Asset-Tabelle nicht gefunden');
      return;
    }
    
    // Clear current table content
    tableBody.innerHTML = '';
    
    // Add new rows
    assets.forEach(asset => {
      const row = createAssetTableRow(asset);
      tableBody.appendChild(row);
    });
    
    // Update pagination if provided
    if (pagination) {
      updatePagination(pagination);
    }
    
    // Update asset count display
    const countElement = document.querySelector('.asset-count');
    if (countElement && pagination) {
      countElement.textContent = `${pagination.total} Assets`;
    }
  }
  
  // Create a single asset table row
  function createAssetTableRow(asset) {
    const row = document.createElement('tr');
    
    // Format status with proper styling
    const statusLower = asset.status?.toLowerCase() || '';
    const statusClass = statusLower === 'active' ? 'status-active' : 'status-inactive';
    const statusIcon = statusLower === 'active' ? 'check_circle' : 'cancel';
    const statusText = statusLower === 'active' ? 'Aktiv' : 
                       statusLower === 'inactive' ? 'Inaktiv' :
                       statusLower === 'on_loan' ? 'Ausgeliehen' :
                       statusLower === 'maintenance' ? 'Wartung' :
                       statusLower === 'retired' ? 'Ausgemustert' : 'Inaktiv';
    
    // Format category
    const categoryText = asset.category ? asset.category.replace('<Category ', '').replace('>', '') : '-';
    
    // Format dates
    const createdDate = asset.created_at ? new Date(asset.created_at).toLocaleDateString('de-DE') : '-';
    const updatedDate = asset.updated_at ? new Date(asset.updated_at).toLocaleDateString('de-DE') : '-';
    
    row.innerHTML = `
      <td>
        <input type="checkbox" class="asset-checkbox" value="${asset.id}">
      </td>
      <td>
        <span class="material-symbols-outlined" style="font-size: 18px; color: var(--md-sys-color-primary);">
          ${getCategoryIcon(asset.category)}
        </span>
      </td>
      <td><strong>${asset.asset_id || '-'}</strong></td>
      <td>${asset.name || '-'}</td>
      <td>${asset.artikelnummer || '-'}</td>
      <td>${categoryText}</td>
      <td>${asset.ean || '-'}</td>
      <td>${asset.start || '-'}</td>
      <td>${asset.hersteller || '-'}</td>
      <td>${asset.serialnumber || '-'}</td>
      <td>${asset.lieferant || '-'}</td>
      <td>${createdDate}</td>
      <td>${updatedDate}</td>
      <td>${asset.aktionen || '-'}</td>
      <td>
        <div class="status-indicator ${statusClass}">
          <span class="material-symbols-outlined">${statusIcon}</span>
          <span>${statusText}</span>
        </div>
      </td>
      <td>
        <div class="action-buttons">
          <button type="button" class="md-button md-button-icon" onclick="editAsset(${asset.id})" title="Bearbeiten">
            <span class="material-symbols-outlined">edit</span>
          </button>
          <button type="button" class="md-button md-button-icon md-button-danger" onclick="deleteAsset(${asset.id})" title="Löschen">
            <span class="material-symbols-outlined">delete</span>
          </button>
        </div>
      </td>
    `;
    
    return row;
  }
  
  // Get appropriate icon for category
  function getCategoryIcon(category) {
    if (!category) return 'category';
    
    const categoryLower = category.toLowerCase();
    if (categoryLower.includes('lizenz')) return 'key';
    if (categoryLower.includes('server')) return 'dns';
    if (categoryLower.includes('hardware')) return 'memory';
    if (categoryLower.includes('software')) return 'apps';
    if (categoryLower.includes('netzwerk')) return 'router';
    return 'category';
  }
  
  // Update pagination controls
  function updatePagination(pagination) {
    const paginationContainer = document.querySelector('.pagination-container');
    if (!paginationContainer || !pagination) return;
    
    // This would need to be implemented based on your pagination structure
    console.log('Pagination update:', pagination);
  }
  
  // Open new assignment modal
  window.openNewAssignmentModal = function() {
    const modal = document.createElement('div');
    modal.id = 'new-assignment-modal';
    modal.style.cssText = `
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5); display: flex; justify-content: center;
      align-items: center; z-index: 10001; animation: fadeIn 0.3s ease-out;
    `;
    
    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
      background: var(--md-sys-color-surface);
      border-radius: 28px;
      box-shadow: var(--md-sys-elevation-level5);
      width: 90vw;
      max-width: 500px;
      animation: slideUp 0.3s ease-out;
      overflow: hidden;
    `;
    
    modalContent.innerHTML = `
      <div style="padding: 32px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
          <h2 style="
            font-family: var(--md-sys-typescale-headline-small-font-family-name);
            font-size: var(--md-sys-typescale-headline-small-font-size);
            font-weight: var(--md-sys-typescale-headline-small-font-weight);
            color: var(--md-sys-color-on-surface);
            margin: 0;
          ">Neue Zuordnung erstellen</h2>
          <button onclick="closeNewAssignmentModal()" style="
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 20px;
            color: var(--md-sys-color-on-surface-variant);
          ">
            <span class="material-symbols-outlined" style="font-size: 24px;">close</span>
          </button>
        </div>
        
        <form id="new-assignment-form">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          
          <!-- Name -->
          <div style="margin-bottom: 16px;">
            <label style="
              display: block;
              font-family: var(--md-sys-typescale-body-small-font-family-name);
              font-size: var(--md-sys-typescale-body-small-font-size);
              font-weight: var(--md-sys-typescale-body-small-font-weight);
              color: var(--md-sys-color-on-surface-variant);
              margin-bottom: 8px;
            ">Name *</label>
            <input type="text" name="name" required style="
              width: 100%;
              padding: 16px;
              border: 1px solid var(--md-sys-color-outline);
              border-radius: 8px;
              background: var(--md-sys-color-surface);
              color: var(--md-sys-color-on-surface);
              font-family: var(--md-sys-typescale-body-large-font-family-name);
              font-size: var(--md-sys-typescale-body-large-font-size);
              box-sizing: border-box;
            " placeholder="z.B. IT-Ausstattung, Büroeinrichtung, etc.">
          </div>
          
          <!-- Beschreibung -->
          <div style="margin-bottom: 24px;">
            <label style="
              display: block;
              font-family: var(--md-sys-typescale-body-small-font-family-name);
              font-size: var(--md-sys-typescale-body-small-font-size);
              font-weight: var(--md-sys-typescale-body-small-font-weight);
              color: var(--md-sys-color-on-surface-variant);
              margin-bottom: 8px;
            ">Beschreibung</label>
            <textarea name="description" rows="3" style="
              width: 100%;
              padding: 16px;
              border: 1px solid var(--md-sys-color-outline);
              border-radius: 8px;
              background: var(--md-sys-color-surface);
              color: var(--md-sys-color-on-surface);
              font-family: var(--md-sys-typescale-body-large-font-family-name);
              font-size: var(--md-sys-typescale-body-large-font-size);
              box-sizing: border-box;
              resize: vertical;
            " placeholder="Optionale Beschreibung der Zuordnung"></textarea>
          </div>
          
          <!-- Modal Actions -->
          <div style="
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding-top: 24px;
            border-top: 1px solid var(--md-sys-color-outline-variant);
          ">
            <button type="button" onclick="closeNewAssignmentModal()" style="
              padding: 12px 24px;
              border: 1px solid var(--md-sys-color-outline);
              border-radius: 20px;
              background: var(--md-sys-color-surface);
              color: var(--md-sys-color-on-surface);
              font-family: var(--md-sys-typescale-label-large-font-family-name);
              font-size: var(--md-sys-typescale-label-large-font-size);
              font-weight: var(--md-sys-typescale-label-large-font-weight);
              cursor: pointer;
              transition: all 0.2s ease;
            ">Abbrechen</button>
            <button type="button" onclick="submitNewAssignmentForm()" style="
              padding: 12px 24px;
              border: none;
              border-radius: 20px;
              background: var(--md-sys-color-primary);
              color: var(--md-sys-color-on-primary);
              font-family: var(--md-sys-typescale-label-large-font-family-name);
              font-size: var(--md-sys-typescale-label-large-font-size);
              font-weight: var(--md-sys-typescale-label-large-font-weight);
              cursor: pointer;
              transition: all 0.2s ease;
              display: flex;
              align-items: center;
              gap: 8px;
            ">
              <span class="material-symbols-outlined" style="font-size: 18px;">add</span>
              Erstellen
            </button>
          </div>
        </form>
      </div>
    `;
    
    modal.appendChild(modalContent);
    document.body.appendChild(modal);
    
    // Focus on name input
    setTimeout(() => {
      const nameInput = modal.querySelector('input[name="name"]');
      if (nameInput) nameInput.focus();
    }, 100);
    
    // Click outside to close
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        closeNewAssignmentModal();
      }
    });
    
    // ESC key to close
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeNewAssignmentModal();
      }
    });
  };
  
  // Close new assignment modal
  window.closeNewAssignmentModal = function() {
    const modal = document.getElementById('new-assignment-modal');
    if (modal) {
      modal.style.animation = 'fadeOut 0.3s ease-out';
      setTimeout(() => {
        modal.remove();
      }, 300);
    }
  };
  
  // Submit new assignment form
  window.submitNewAssignmentForm = function() {
    const form = document.getElementById('new-assignment-form');
    const formData = new FormData(form);
    
    fetch('/api/assignments/create', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        closeNewAssignmentModal();
        showNotification(data.message, 'success');
        // Refresh assignments dropdown and auto-select new assignment
        refreshAssignmentsDropdown(data.assignment.id);
      } else {
        showNotification(data.message || 'Fehler beim Erstellen', 'error');
      }
    })
    .catch(error => {
      console.error('Fehler beim Erstellen:', error);
      showNotification('Fehler beim Erstellen der Zuordnung', 'error');
    });
  };
  
  // Refresh assignments dropdown after creating new assignment
  function refreshAssignmentsDropdown(newAssignmentId = null) {
    fetch('/api/assignments')
      .then(response => response.json())
      .then(data => {
        const assignmentSelect = document.getElementById('edit-assignments');
        if (assignmentSelect && data.assignments) {
          const selectedValues = Array.from(assignmentSelect.selectedOptions).map(option => option.value);
          
          // Add new assignment ID to selected values if provided
          if (newAssignmentId && !selectedValues.includes(newAssignmentId.toString())) {
            selectedValues.push(newAssignmentId.toString());
          }
          
          assignmentSelect.innerHTML = '';
          data.assignments.forEach(assignment => {
            const option = document.createElement('option');
            option.value = assignment.id;
            option.textContent = assignment.name;
            if (selectedValues.includes(assignment.id.toString())) {
              option.selected = true;
            }
            assignmentSelect.appendChild(option);
          });
        }
      })
      .catch(error => {
        console.error('Fehler beim Laden der Zuordnungen:', error);
      });
  }
});
</script>
{% endblock %}

{% block content %}
{% include 'md3-nav.html' %}

<div class="md3-container" style="margin-top: 80px;">
  <div class="md3-assets-header">
    <h1 class="md3-assets-title">
      Assets
      {% if request.args.get('status', 'active') == 'all' %}
      <span style="font-size: 14px; font-weight: 400; color: var(--md-sys-color-on-surface-variant); margin-left: 8px;">(inkl. inaktive)</span>
      {% endif %}
    </h1>
    <div class="md3-action-buttons">
      <button onclick="openNewAssetModal()" class="md3-action-btn md3-primary-btn">
        <span class="material-symbols-outlined">add</span>
        Neues Asset
      </button>
      <button data-href="{{ url_for('import_assets.import_assets_upload', md3=1) }}" class="md3-action-btn md3-secondary-btn md3-nav-btn">
        <span class="material-symbols-outlined">upload_file</span>
        CSV Import
      </button>
      <button data-href="{{ url_for('md3_assets', group_duplicates='true' if not group_duplicates else 'false') }}" class="md3-action-btn md3-secondary-btn md3-nav-btn">
        <span class="material-symbols-outlined">{{ 'group_work' if not group_duplicates else 'splitscreen' }}</span>
        {{ 'Duplikate gruppieren' if not group_duplicates else 'Alle Assets anzeigen' }}
      </button>
      <button 
        data-href="{{ url_for('md3_assets', status='all' if request.args.get('status', 'active') != 'all' else 'active') }}" 
        class="md3-action-btn md3-secondary-btn md3-nav-btn"
        style="{% if request.args.get('status', 'active') == 'all' %}background: var(--md-sys-color-tertiary-container); color: var(--md-sys-color-on-tertiary-container);{% endif %}"
      >
        <span class="material-symbols-outlined">{{ 'visibility' if request.args.get('status', 'active') == 'all' else 'visibility_off' }}</span>
        {{ 'Nur aktive Assets' if request.args.get('status', 'active') == 'all' else 'Alle Assets (inkl. inaktive)' }}
      </button>
    </div>
  </div>

  {% if assets %}
  <div class="md3-asset-table-container" style="overflow-x: auto; margin-bottom: 24px; width: 100%; padding: 0; max-width: 100vw;">
    <table class="md3-asset-table" style="width: 100%; border-collapse: collapse; table-layout: fixed;">
      <colgroup>
        <col style="width: 30px;">   <!-- Checkbox -->
        <col style="width: 40px;">   <!-- Bild -->
        <col style="width: 120px;">  <!-- Name -->
        <col style="width: 70px;">   <!-- Artikelnummer -->
        <col style="width: 60px;">   <!-- Kategorie -->
        <col style="width: 60px;">   <!-- EAN -->
        <col style="width: 50px;">   <!-- Wert -->
        <col style="width: 50px;">   <!-- Status -->
        <col style="width: 60px;">   <!-- Standort -->
        <col style="width: 60px;">   <!-- Hersteller -->
        <col style="width: 60px;">   <!-- Lieferant -->
        <col style="width: 60px;">   <!-- Zuordnung -->
        <col style="width: 100px;">  <!-- Aktionen -->
      </colgroup>
      <thead>
        <tr>
          <!-- Checkbox -->
          <th style="width: 30px; text-align: center; padding: 8px; vertical-align: middle;">
            <input type="checkbox" id="select-all" class="md3-checkbox">
          </th>
          <!-- Bild -->
          <th style="width: 40px; text-align: center; padding: 8px; vertical-align: middle; font-size: 12px; font-weight: 500; color: var(--md-sys-color-on-surface-variant);">
            Bild
          </th>
          <!-- Name -->
          <th style="width: 120px; text-align: center; padding: 8px; vertical-align: middle; font-size: 12px; font-weight: 500; color: var(--md-sys-color-on-surface-variant);">
            Name
          </th>
          <!-- Artikelnummer -->
          <th style="width: 70px; text-align: center; padding: 8px; vertical-align: middle; font-size: 12px; font-weight: 500; color: var(--md-sys-color-on-surface-variant);">
            Artikelnummer
          </th>
          <!-- Kategorie -->
          <th style="width: 60px; text-align: center; padding: 8px; vertical-align: middle; font-size: 12px; font-weight: 500; color: var(--md-sys-color-on-surface-variant);">
            Kategorie
          </th>
          <!-- EAN -->
          <th style="width: 60px; text-align: center; padding: 8px; vertical-align: middle; font-size: 12px; font-weight: 500; color: var(--md-sys-color-on-surface-variant);">
            EAN
          </th>
          <!-- Wert -->
          <th style="width: 50px; text-align: center; padding: 8px; vertical-align: middle; font-size: 12px; font-weight: 500; color: var(--md-sys-color-on-surface-variant);">
            Wert
          </th>
          <!-- Status -->
          <th style="width: 50px; text-align: center; padding: 8px; vertical-align: middle; font-size: 12px; font-weight: 500; color: var(--md-sys-color-on-surface-variant);">
            Status
          </th>
          <!-- Standort -->
          <th style="width: 60px; text-align: center; padding: 8px; vertical-align: middle; font-size: 12px; font-weight: 500; color: var(--md-sys-color-on-surface-variant);">
            Standort
          </th>
          <!-- Hersteller -->
          <th style="width: 60px; text-align: center; padding: 8px; vertical-align: middle; font-size: 12px; font-weight: 500; color: var(--md-sys-color-on-surface-variant);">
            Hersteller
          </th>
          <!-- Lieferant -->
          <th style="width: 60px; text-align: center; padding: 8px; vertical-align: middle; font-size: 12px; font-weight: 500; color: var(--md-sys-color-on-surface-variant);">
            Lieferant
          </th>
          <!-- Zuordnung -->
          <th style="width: 60px; text-align: center; padding: 8px; vertical-align: middle; font-size: 12px; font-weight: 500; color: var(--md-sys-color-on-surface-variant);">
            Zuordnung
          </th>
          <!-- Aktionen -->
          <th style="width: 100px; text-align: center; padding: 8px; vertical-align: middle; font-size: 12px; font-weight: 500; color: var(--md-sys-color-on-surface-variant);">
            Aktionen
          </th>
        </tr>
      </thead>
      <tbody>
        {% for asset in assets %}
        <tr class="{% if asset.is_group %}md3-grouped-asset{% endif %}" style="height: 48px; border-bottom: 1px solid var(--md-sys-color-outline-variant);">
          <!-- Checkbox -->
          <td style="width: 30px; text-align: center; padding: 8px; vertical-align: middle;">
            {% if asset.is_group %}
            <input type="checkbox" 
              name="selected_assets"
              class="asset-checkbox group-checkbox md3-checkbox" 
              value="{{ asset.group_ids|join(',') }}" 
              data-is-group="true"
              title="Diese Gruppe mit {{ asset.group_count }} Assets auswählen">
            {% else %}
            <input type="checkbox" 
              name="selected_assets"
              class="asset-checkbox md3-checkbox" 
              value="{{ asset.id }}">
            {% endif %}
          </td>
          <!-- Bild -->
          <td style="width: 40px; text-align: center; padding: 8px; vertical-align: middle;">
            {% if asset.image_url %}
            <img src="{{ asset.image_url }}" alt="{{ asset.name }}" style="width: 24px; height: 24px; object-fit: cover; border-radius: 2px;">
            {% else %}
            <span class="material-symbols-outlined" style="color: var(--md-sys-color-outline); font-size: 16px;">image_not_supported</span>
            {% endif %}
          </td>
          <!-- Name -->
          <td style="width: 120px; padding: 8px; text-align: left; vertical-align: middle; font-size: 14px; line-height: 20px;">
            {% if asset.is_group %}
            <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-weight: 500; color: var(--md-sys-color-on-surface);" title="{{ asset.name }} ({{ asset.group_count }} Assets)">
              {{ asset.name[:15] }}{{ '...' if asset.name|length > 15 else '' }}
              <span style="font-size: 11px; color: var(--md-sys-color-on-surface-variant); margin-left: 4px;">({{ asset.group_count }})</span>
            </div>
            {% else %}
            <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--md-sys-color-on-surface);" title="{{ asset.name }}">
              {{ asset.name[:15] }}{{ '...' if asset.name|length > 15 else '' }}
            </div>
            {% endif %}
          </td>
          <!-- Artikelnummer -->
          <td style="width: 70px; text-align: center; padding: 8px; vertical-align: middle; font-size: 12px; color: var(--md-sys-color-on-surface-variant);">
            {% if asset.is_group %}
            <span style="color: var(--md-sys-color-outline);">—</span>
            {% else %}
            {{ (asset.article_number or '—')[:8] }}{{ '...' if asset.article_number and asset.article_number|length > 8 else '' }}
            {% endif %}
          </td>
          <!-- Kategorie -->
          <td style="width: 60px; text-align: center; padding: 8px; vertical-align: middle; font-size: 12px; color: var(--md-sys-color-on-surface-variant);">
            {% if asset.is_group %}
            <span style="color: var(--md-sys-color-primary);">Mix</span>
            {% else %}
            {{ (asset.category.name if asset.category else '—')[:6] }}{{ '...' if asset.category and asset.category.name|length > 6 else '' }}
            {% endif %}
          </td>
          <!-- EAN -->
          <td style="width: 60px; text-align: center; padding: 8px; vertical-align: middle; font-size: 12px; color: var(--md-sys-color-on-surface-variant);">
            {% if asset.is_group %}
            <span style="color: var(--md-sys-color-outline);">—</span>
            {% else %}
            {{ (asset.ean or '—')[:8] }}{{ '...' if asset.ean and asset.ean|length > 8 else '' }}
            {% endif %}
          </td>
          <!-- Wert -->
          <td style="width: 50px; text-align: center; padding: 8px; vertical-align: middle; font-size: 12px; color: var(--md-sys-color-on-surface-variant);">
            {% if asset.is_group %}
            <span style="color: var(--md-sys-color-outline);">—</span>
            {% else %}
            {% if asset.value %}
            {{ "%.0f" | format(asset.value) }}€
            {% else %}
            —
            {% endif %}
            {% endif %}
          </td>
          <!-- Status -->
          <td style="width: 50px; text-align: center; padding: 8px; vertical-align: middle;">
            {% if asset.is_group %}
            <span class="md3-status-badge" style="background: var(--md-sys-color-secondary-container); color: var(--md-sys-color-on-secondary-container); font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 500;">
              Grp
            </span>
            {% else %}
            {% if asset.status == 'active' %}
            <span class="md3-status-badge" style="background: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container); font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 500;">Akt</span>
            {% elif asset.status == 'on_loan' %}
            <span class="md3-status-badge" style="background: var(--md-sys-color-tertiary-container); color: var(--md-sys-color-on-tertiary-container); font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 500;">Aus</span>
            {% else %}
            <span class="md3-status-badge" style="background: var(--md-sys-color-error-container); color: var(--md-sys-color-on-error-container); font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 500;">Ina</span>
            {% endif %}
            {% endif %}
          </td>
          <!-- Standort -->
          <td style="width: 60px; text-align: center; padding: 8px; vertical-align: middle; font-size: 12px; color: var(--md-sys-color-on-surface-variant);">
            {% if asset.is_group %}
            <span style="color: var(--md-sys-color-primary);">Versch</span>
            {% else %}
            {{ (asset.location_obj.name if asset.location_obj else '—')[:6] }}{{ '...' if asset.location_obj and asset.location_obj.name|length > 6 else '' }}
            {% endif %}
          </td>
          <!-- Hersteller -->
          <td style="width: 60px; text-align: center; padding: 8px; vertical-align: middle; font-size: 12px; color: var(--md-sys-color-on-surface-variant);">
            {% if asset.is_group %}
            <span style="color: var(--md-sys-color-primary);">Versch</span>
            {% else %}
            {% if asset.manufacturers %}{{ (asset.manufacturers[0].name)[:6] }}{{ '...' if asset.manufacturers[0].name|length > 6 else '' }}{% else %}—{% endif %}
            {% endif %}
          </td>
          <!-- Lieferant -->
          <td style="width: 60px; text-align: center; padding: 8px; vertical-align: middle; font-size: 12px; color: var(--md-sys-color-on-surface-variant);">
            {% if asset.is_group %}
            <span style="color: var(--md-sys-color-primary);">Versch</span>
            {% else %}
            {% if asset.suppliers %}{{ (asset.suppliers[0].name)[:6] }}{{ '...' if asset.suppliers[0].name|length > 6 else '' }}{% else %}—{% endif %}
            {% endif %}
          </td>
          <!-- Zuordnung -->
          <td style="width: 60px; text-align: center; padding: 8px; vertical-align: middle; font-size: 12px; color: var(--md-sys-color-on-surface-variant);">
            {% if asset.is_group %}
            <span style="color: var(--md-sys-color-primary);">Versch</span>
            {% else %}
            {% if asset.assignments %}{{ (asset.assignments[0].name)[:6] }}{{ '...' if asset.assignments[0].name|length > 6 else '' }}{% else %}—{% endif %}
            {% endif %}
          </td>
          <!-- Aktionen -->
          <td class="md3-action-menu" style="width: 100px; padding: 8px; vertical-align: middle; display: flex; justify-content: center; align-items: center; gap: 2px;">
            {% if asset.is_group %}
            <button class="md3-action-icon" 
                    onclick="openGroupDetailsDialog('{{ asset.group_ids|join(',') }}', '{{ asset.name }}')"
                    title="Gruppe anzeigen">
              <span class="material-symbols-outlined" style="font-size: 16px;">visibility</span>
            </button>
            {% else %}
            <button class="md3-action-icon" 
                    onclick="openSingleAssetModal({assetId: '{{ asset.id }}', assetName: '{{ asset.name }}'})"
                    title="Asset-Details anzeigen">
              <span class="material-symbols-outlined" style="font-size: 16px;">visibility</span>
            </button>
            {% endif %}
            <button class="md3-action-icon" 
                    onclick="loadAssetForEdit('{{ asset.id }}')"
                    title="Asset bearbeiten">
              <span class="material-symbols-outlined" style="font-size: 16px;">edit</span>
            </button>
            <button class="md3-action-icon" 
                    onclick="window.location.href='/costs/{{ asset.id }}'"
                    title="Kostenverwaltung">
              <span class="material-symbols-outlined" style="font-size: 16px; color: var(--md-sys-color-tertiary);">account_balance_wallet</span>
            </button>
            {% if asset.status == 'active' %}
            <button class="md3-action-icon" 
                    onclick="openLoanModal({{ asset.id }})"
                    title="Asset ausleihen">
              <span class="material-symbols-outlined" style="font-size: 16px; color: var(--md-sys-color-primary);">local_shipping</span>
            </button>
            {% elif asset.status == 'on_loan' %}
            <button class="md3-action-icon" 
                    onclick="returnAsset({{ asset.id }})"
                    title="Asset zurückgeben">
              <span class="material-symbols-outlined" style="font-size: 16px; color: var(--md-sys-color-secondary);">undo</span>
            </button>
            {% endif %}
            <button class="md3-action-icon md3-delete-btn" data-asset-id="{{ asset.id }}" data-asset-name="{{ asset.name }}" title="Löschen">
              <span class="material-symbols-outlined" style="font-size: 16px; color: var(--md-sys-color-error);">delete</span>
            </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div style="text-align: center; padding: 40px; color: var(--md-sys-color-on-surface-variant);">
    <div style="font-size: 48px; margin-bottom: 16px;">📦</div>
    <p>Keine Assets gefunden</p>
  </div>
  {% endif %}
</div>

<!-- Ausleih-Modal -->
<div id="loan-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
  <div style="background: var(--md-sys-color-surface); border-radius: 28px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: var(--md-sys-elevation-3);">
    <!-- Header -->
    <div style="padding: 24px; border-bottom: 1px solid var(--md-sys-color-outline-variant);">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2 style="margin: 0; color: var(--md-sys-color-on-surface); font-size: 24px; font-weight: 500;">Asset ausleihen</h2>
        <button onclick="closeLoanModal()" style="background: transparent; border: none; cursor: pointer; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
          <span class="material-symbols-outlined" style="color: var(--md-sys-color-on-surface-variant);">close</span>
        </button>
      </div>
    </div>

    <!-- Asset Info -->
    <div id="loan-asset-info" style="padding: 16px 24px; background: var(--md-sys-color-surface-container); border-bottom: 1px solid var(--md-sys-color-outline-variant);">
      <!-- Wird dynamisch befüllt -->
    </div>

    <!-- Form -->
    <form id="loan-form" style="padding: 24px;">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" id="loan-asset-id" name="asset_id">

      <!-- Ausleiher Name -->
      <div style="margin-bottom: 24px;">
        <label style="display: block; font-size: 14px; font-weight: 500; color: var(--md-sys-color-on-surface); margin-bottom: 8px;">
          <span class="material-symbols-outlined" style="font-size: 18px; vertical-align: middle; margin-right: 4px;">person</span>
          Name des Ausleihenden *
        </label>
        <input type="text" name="borrower_name" required style="width: 100%; padding: 16px; border: 1px solid var(--md-sys-color-outline); border-radius: 12px; background: var(--md-sys-color-surface); color: var(--md-sys-color-on-surface); font-size: 16px;">
      </div>

      <!-- Datums-Felder -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
        <div>
          <label style="display: block; font-size: 14px; font-weight: 500; color: var(--md-sys-color-on-surface); margin-bottom: 8px;">
            <span class="material-symbols-outlined" style="font-size: 18px; vertical-align: middle; margin-right: 4px;">event</span>
            Startdatum *
          </label>
          <input type="date" name="start_date" required style="width: 100%; padding: 16px; border: 1px solid var(--md-sys-color-outline); border-radius: 12px; background: var(--md-sys-color-surface); color: var(--md-sys-color-on-surface); font-size: 16px;">
        </div>
        <div>
          <label style="display: block; font-size: 14px; font-weight: 500; color: var(--md-sys-color-on-surface); margin-bottom: 8px;">
            <span class="material-symbols-outlined" style="font-size: 18px; vertical-align: middle; margin-right: 4px;">event_available</span>
            Rückgabedatum *
          </label>
          <input type="date" name="expected_return_date" required style="width: 100%; padding: 16px; border: 1px solid var(--md-sys-color-outline); border-radius: 12px; background: var(--md-sys-color-surface); color: var(--md-sys-color-on-surface); font-size: 16px;">
        </div>
      </div>

      <!-- Notizen -->
      <div style="margin-bottom: 24px;">
        <label style="display: block; font-size: 14px; font-weight: 500; color: var(--md-sys-color-on-surface); margin-bottom: 8px;">
          <span class="material-symbols-outlined" style="font-size: 18px; vertical-align: middle; margin-right: 4px;">notes</span>
          Notizen (optional)
        </label>
        <textarea name="notes" rows="3" style="width: 100%; padding: 16px; border: 1px solid var(--md-sys-color-outline); border-radius: 12px; background: var(--md-sys-color-surface); color: var(--md-sys-color-on-surface); font-size: 16px; resize: vertical;"></textarea>
      </div>

      <!-- Unterschrift Mitarbeiter -->
      <div style="margin-bottom: 24px;">
        <label style="display: block; font-size: 14px; font-weight: 500; color: var(--md-sys-color-on-surface); margin-bottom: 8px;">
          <span class="material-symbols-outlined" style="font-size: 18px; vertical-align: middle; margin-right: 4px;">draw</span>
          Unterschrift Mitarbeiter *
        </label>
        <div style="border: 1px solid var(--md-sys-color-outline); border-radius: 12px; padding: 12px; background: var(--md-sys-color-surface-container);">
          <canvas id="signature-pad-employee" width="500" height="150" style="border: 1px solid var(--md-sys-color-outline-variant); background: white; border-radius: 8px; width: 100%; touch-action: none;"></canvas>
          <button type="button" onclick="clearSignature('employee')" style="margin-top: 8px; padding: 8px 16px; background: var(--md-sys-color-surface); border: 1px solid var(--md-sys-color-outline); border-radius: 8px; color: var(--md-sys-color-on-surface); cursor: pointer; font-size: 14px;">
            <span class="material-symbols-outlined" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">refresh</span>
            Zurücksetzen
          </button>
        </div>
        <input type="hidden" name="signature" id="signature-data-employee">
      </div>

      <!-- Unterschrift Arbeitgeber -->
      <div style="margin-bottom: 24px;">
        <label style="display: block; font-size: 14px; font-weight: 500; color: var(--md-sys-color-on-surface); margin-bottom: 8px;">
          <span class="material-symbols-outlined" style="font-size: 18px; vertical-align: middle; margin-right: 4px;">badge</span>
          Unterschrift Arbeitgeber *
        </label>
        <div style="border: 1px solid var(--md-sys-color-outline); border-radius: 12px; padding: 12px; background: var(--md-sys-color-surface-container);">
          <canvas id="signature-pad-employer" width="500" height="150" style="border: 1px solid var(--md-sys-color-outline-variant); background: white; border-radius: 8px; width: 100%; touch-action: none;"></canvas>
          <button type="button" onclick="clearSignature('employer')" style="margin-top: 8px; padding: 8px 16px; background: var(--md-sys-color-surface); border: 1px solid var(--md-sys-color-outline); border-radius: 8px; color: var(--md-sys-color-on-surface); cursor: pointer; font-size: 14px;">
            <span class="material-symbols-outlined" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">refresh</span>
            Zurücksetzen
          </button>
        </div>
        <input type="hidden" name="signature_employer" id="signature-data-employer">
      </div>

      <!-- Buttons -->
      <div style="display: flex; gap: 12px; justify-content: flex-end;">
        <button type="button" onclick="closeLoanModal()" style="padding: 12px 24px; background: var(--md-sys-color-surface); border: 1px solid var(--md-sys-color-outline); border-radius: 20px; color: var(--md-sys-color-on-surface); cursor: pointer; font-size: 16px; font-weight: 500;">
          Abbrechen
        </button>
        <button type="submit" style="padding: 12px 24px; background: var(--md-sys-color-primary); border: none; border-radius: 20px; color: var(--md-sys-color-on-primary); cursor: pointer; font-size: 16px; font-weight: 500;">
          <span class="material-symbols-outlined" style="font-size: 18px; vertical-align: middle; margin-right: 4px;">check_circle</span>
          Asset ausleihen
        </button>
      </div>
    </form>
  </div>
</div>

<script src="{{ url_for('static', filename='js/signature_pad.min.js') }}"></script>
<script>
// Signature Pads initialisieren
let signaturePadEmployee, signaturePadEmployer;

document.addEventListener('DOMContentLoaded', function() {
  const canvasEmployee = document.getElementById('signature-pad-employee');
  const canvasEmployer = document.getElementById('signature-pad-employer');
  
  if (canvasEmployee && typeof SignaturePad !== 'undefined') {
    signaturePadEmployee = new SignaturePad(canvasEmployee);
  }
  if (canvasEmployer && typeof SignaturePad !== 'undefined') {
    signaturePadEmployer = new SignaturePad(canvasEmployer);
  }
});

window.openLoanModal = function(assetId) {
  const modal = document.getElementById('loan-modal');
  document.getElementById('loan-asset-id').value = assetId;
  
  // Asset-Info laden
  fetch(`/api/assets/${assetId}`)
    .then(response => response.json())
    .then(data => {
      const asset = data.asset;
      const infoContainer = document.getElementById('loan-asset-info');
      infoContainer.innerHTML = `
        <div style="display: flex; align-items: center; gap: 16px;">
          ${asset.image_url ? `<img src="${asset.image_url}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;">` : ''}
          <div>
            <div style="font-size: 18px; font-weight: 500; color: var(--md-sys-color-on-surface);">${asset.name}</div>
            <div style="font-size: 14px; color: var(--md-sys-color-on-surface-variant); margin-top: 4px;">
              ${asset.article_number ? `Art.-Nr.: ${asset.article_number}` : ''}
              ${asset.serial_number ? ` | SN: ${asset.serial_number}` : ''}
            </div>
          </div>
        </div>
      `;
    });
  
  // Heute als Start-Datum setzen
  const today = new Date().toISOString().split('T')[0];
  document.querySelector('#loan-form input[name="start_date"]').value = today;
  
  modal.style.display = 'flex';
};

window.closeLoanModal = function() {
  const modal = document.getElementById('loan-modal');
  modal.style.display = 'none';
  document.getElementById('loan-form').reset();
  if (signaturePadEmployee) signaturePadEmployee.clear();
  if (signaturePadEmployer) signaturePadEmployer.clear();
};

window.clearSignature = function(type) {
  if (type === 'employee' && signaturePadEmployee) {
    signaturePadEmployee.clear();
  } else if (type === 'employer' && signaturePadEmployer) {
    signaturePadEmployer.clear();
  }
};

// Form Submit
document.getElementById('loan-form').addEventListener('submit', function(e) {
  e.preventDefault();
  
  // Unterschriften speichern
  if (signaturePadEmployee && !signaturePadEmployee.isEmpty()) {
    document.getElementById('signature-data-employee').value = signaturePadEmployee.toDataURL();
  }
  if (signaturePadEmployer && !signaturePadEmployer.isEmpty()) {
    document.getElementById('signature-data-employer').value = signaturePadEmployer.toDataURL();
  }
  
  // Validierung
  if (signaturePadEmployee.isEmpty() || signaturePadEmployer.isEmpty()) {
    alert('Bitte beide Unterschriften ausfüllen!');
    return;
  }
  
  const formData = new FormData(this);
  const assetId = document.getElementById('loan-asset-id').value;
  
  fetch(`/loan_asset/${assetId}`, {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('Asset erfolgreich ausgeliehen!');
      closeLoanModal();
      window.location.reload();
    } else {
      alert('Fehler beim Ausleihen: ' + (data.message || 'Unbekannter Fehler'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Fehler beim Ausleihen: ' + error.message);
  });
});

// Rückgabe-Funktion
window.returnAsset = function(assetId) {
  if (confirm('Möchten Sie dieses Asset wirklich zurückgeben?')) {
    fetch(`/return_asset/${assetId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: `csrf_token={{ csrf_token() }}`
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('Asset erfolgreich zurückgegeben!');
        window.location.reload();
      } else {
        alert('Fehler beim Zurückgeben: ' + (data.message || 'Unbekannter Fehler'));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Fehler beim Zurückgeben: ' + (error.message || 'Unbekannter Fehler'));
    });
  }
};
</script>
{% endblock %}
