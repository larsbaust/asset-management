{% extends 'base.html' %}
{% block styles %}
  {{ super() }}
  <style>
    .md3-page { padding: 24px; padding-top: 80px; }
    .md3-container { max-width: 1200px; margin: 0 auto; }
    .header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px; }
    .title { font: var(--md-sys-typescale-headline-small-font); color: var(--md-sys-color-on-surface); }

    .card { background: var(--md-sys-color-surface); border-radius: 16px; box-shadow: var(--md-sys-elevation-2); padding: 16px; }
    .toolbar { display:flex; align-items:center; gap:12px; margin-bottom: 12px; }

    .search-input { height: 40px; border-radius: 12px; border:1px solid var(--md-sys-color-outline-variant); padding: 0 10px; background: var(--md-sys-color-surface); color: var(--md-sys-color-on-surface); width: 280px; }
    .checkbox-line { display:flex; align-items:center; gap:10px; color: var(--md-sys-color-on-surface-variant); }

    .md3-button { border: none; border-radius: 999px; padding: 10px 16px; cursor:pointer; display:inline-flex; align-items:center; gap:6px; text-decoration:none; white-space: nowrap; }
    .md3-button .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 20; font-size: 20px; }
    .md3-button-filled { background: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); }
    .md3-button-tonal { background: var(--md-sys-color-secondary-container); color: var(--md-sys-color-on-secondary-container); }
    .md3-button-text { background: transparent; color: var(--md-sys-color-primary); }

    table { width:100%; border-collapse: collapse; }
    thead th { text-align:left; color: var(--md-sys-color-on-surface-variant); padding: 10px; border-bottom: 1px solid var(--md-sys-color-outline-variant); }
    tbody td { padding: 10px; border-bottom: 1px solid var(--md-sys-color-outline-variant); vertical-align: middle; }

    @media (max-width: 960px) { .search-input { width: 100%; } }
  </style>
{% endblock %}

{% block content %}
  {% include 'md3-nav.html' %}
  <div class="md3-page">
    <div class="md3-container">
      <div class="header">
        <div class="title">Assets zuordnen – {{ supplier.name }}</div>
        <div class="actions">
          <a class="md3-button md3-button-text" href="{{ url_for('suppliers.supplier_detail', supplier_id=supplier.id, md3=1) }}">
            <span class="material-symbols-outlined">arrow_back</span>
            Zurück zum Lieferanten
          </a>
        </div>
      </div>

      <div class="card">
        <form method="post" action="{{ url_for('suppliers.supplier_assign_assets', supplier_id=supplier.id) }}">
          <input type="hidden" name="md3" value="1">

          <div class="toolbar">
            <input type="text" id="assetSearchInput" class="search-input" placeholder="Nach Assets suchen…">
            <label class="checkbox-line">
              <input type="checkbox" id="selectAllCheckbox"> Alle Assets auswählen/abwählen
            </label>
          </div>

          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Auswahl</th>
                  <th>Artikelnr.</th>
                  <th>Name</th>
                  <th>Kategorie</th>
                  <th>Preis</th>
                  <th>Hersteller</th>
                </tr>
              </thead>
              <tbody>
                {% for asset in assets %}
                <tr class="asset-row">
                  <td>
                    <input type="checkbox" name="asset_ids" value="{{ asset.id }}" {% if asset.id in assigned_asset_ids %}checked{% endif %}>
                  </td>
                  <td>{{ asset.article_number or '-' }}</td>
                  <td>{{ asset.name }}</td>
                  <td>{{ asset.category.name if asset.category else '-' }}</td>
                  <td>{% if asset.value %}{{ "%.2f"|format(asset.value) }} €{% else %}-{% endif %}</td>
                  <td>{% if asset.manufacturers %}{{ asset.manufacturers[0].name if asset.manufacturers else '-' }}{% else %}-{% endif %}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div class="actions" style="margin-top:12px;">
            <button type="submit" class="md3-button md3-button-filled">
              <span class="material-symbols-outlined">save</span>
              Änderungen speichern
            </button>
            <a class="md3-button md3-button-text" href="{{ url_for('suppliers.supplier_detail', supplier_id=supplier.id, md3=1) }}">
              <span class="material-symbols-outlined">close</span>
              Abbrechen
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const searchInput = document.getElementById('assetSearchInput');
      const selectAllCheckbox = document.getElementById('selectAllCheckbox');

      // Filter rows by search
      function filterRows() {
        const term = (searchInput.value || '').toLowerCase();
        const rows = document.querySelectorAll('.asset-row');
        rows.forEach(row => {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(term) ? '' : 'none';
        });
      }
      if (searchInput) searchInput.addEventListener('input', filterRows);

      // Select all visible rows
      if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function () {
          const visibleRows = document.querySelectorAll('.asset-row:not([style*="display: none"])');
          visibleRows.forEach(row => {
            const cb = row.querySelector('input[name="asset_ids"]');
            if (cb) cb.checked = selectAllCheckbox.checked;
          });
        });
      }
    });
  </script>
{% endblock %}
