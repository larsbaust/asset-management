{% extends 'base.html' %}

{% block content %}
{% include 'md3-nav.html' %}
<div class="md3-page">
  <style>
    /* Wizard-spezifische Styles - KEINE Navigation-CSS Overrides */
    .wizard-container { max-width: 1280px; margin: 24px auto; padding: 0 16px; }
    .wizard-steps { display:flex; align-items:center; gap:12px; padding:12px 16px; border-radius:16px; }
    .wizard-step { display:flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background: var(--md-sys-color-surface); box-shadow: var(--md-sys-elevation-1); }
    .wizard-step .num { width:20px; height:20px; display:inline-flex; align-items:center; justify-content:center; border-radius:50%; background: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); font-size:12px; }
    .wizard-step.active { background: color-mix(in srgb, var(--md-sys-color-primary) 12%, var(--md-sys-color-surface)); }
    .wizard-card { padding: 16px; border-radius: 16px; }
    .table-wrap { overflow:auto; border-radius: 12px; }
    .md3-table thead th { position: sticky; top: 0; background: var(--md-sys-color-surface); z-index: 1; }
    @media (max-width: 900px) { .filter-line { gap: 6px; } }
  </style>
  <div class="wizard-container">
  <div class="md3-header" style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
    <div>
      <div class="md3-title">Bestellassistent ‚Äì Schritt 2/4</div>
      <div class="md3-subtitle">Artikel ausw√§hlen</div>
    </div>
  </div>

  <form method="post">
    {{ form.hidden_tag() }}

    <div class="md3-card wizard-steps" aria-label="Fortschritt" style="margin-bottom:12px;">
      <div class="wizard-step"><span class="num">1</span><span>Auswahl</span></div>
      <div class="wizard-step active"><span class="num">2</span><span>Artikel</span></div>
      <div class="wizard-step"><span class="num">3</span><span>Details</span></div>
      <div class="wizard-step"><span class="num">4</span><span>Abschluss</span></div>
    </div>

    <!-- Bestellvorlage laden -->
    <div class="md3-card wizard-card" style="margin-bottom:12px;display:flex;gap:12px;flex-wrap:wrap;align-items:center;">
      <span class="material-symbols-outlined" style="color:var(--md-sys-color-primary);">bookmark</span>
      <label for="template-select" style="font-weight:500;">Bestellvorlage laden:</label>
      <select id="template-select" style="height:40px;border-radius:12px;border:1px solid var(--md-sys-color-outline-variant);padding:0 12px;background:var(--md-sys-color-surface);color:var(--md-sys-color-on-surface);min-width:200px;">
        <option value="">-- Vorlage w√§hlen -- ({{ templates|length }} gefunden)</option>
        {% if templates %}
          {% for template in templates %}
            <option value="{{ template.id }}">{{ template.name }} ({{ template.items|length }} Artikel)</option>
          {% endfor %}
        {% else %}
          <option value="" disabled>Keine Vorlagen vorhanden</option>
        {% endif %}
      </select>
      <button type="button" onclick="loadTemplate()" class="md3-button md3-button-tonal">
        <span class="material-symbols-outlined" style="margin-right:4px;">download</span>
        Laden
      </button>
      <button type="button" onclick="openSaveTemplateModal()" class="md3-button md3-button-outlined">
        <span class="material-symbols-outlined" style="margin-right:4px;">save</span>
        Als Vorlage speichern
      </button>
    </div>

    <!-- OCI Integration: shop.api.de Katalog -->
    <div class="md3-card wizard-card" style="margin-bottom:12px;display:flex;gap:12px;flex-wrap:wrap;align-items:center;background:linear-gradient(135deg, var(--md-sys-color-primary-container) 0%, var(--md-sys-color-tertiary-container) 100%);">
      <span class="material-symbols-outlined" style="color:var(--md-sys-color-primary);font-size:32px;">shopping_cart</span>
      <div style="flex:1;">
        <div style="font-weight:600;margin-bottom:4px;color:var(--md-sys-color-on-primary-container);">
          üõí Artikel aus shop.api.de Katalog
        </div>
        <div style="font-size:13px;color:var(--md-sys-color-on-surface-variant);">
          Durchsuchen Sie den Online-Katalog von shop.api.de und √ºbernehmen Sie Artikel direkt in Ihre Bestellung.
        </div>
      </div>
      <a href="{{ url_for('oci.outbound') }}" class="md3-button md3-button-filled" style="background:var(--md-sys-color-primary);color:var(--md-sys-color-on-primary);text-decoration:none;display:inline-flex;align-items:center;height:40px;padding:0 20px;">
        <span class="material-symbols-outlined" style="margin-right:8px;">open_in_new</span>
        Katalog √∂ffnen
      </a>
    </div>

    <!-- Filter (optional simple version) -->
    <div class="md3-card wizard-card filter-line" style="margin-bottom:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
      {{ form.filter_name(placeholder='Artikelname', style='height:40px;border-radius:12px;border:1px solid var(--md-sys-color-outline-variant);padding:0 10px;background:var(--md-sys-color-surface);color:var(--md-sys-color-on-surface);') }}
      {{ form.filter_category(style='height:40px;border-radius:12px;border:1px solid var(--md-sys-color-outline-variant);padding:0 10px;background:var(--md-sys-color-surface);color:var(--md-sys-color-on-surface);') }}
      {{ form.filter_manufacturer(style='height:40px;border-radius:12px;border:1px solid var(--md-sys-color-outline-variant);padding:0 10px;background:var(--md-sys-color-surface);color:var(--md-sys-color-on-surface);') }}
      {{ form.filter_supplier(style='height:40px;border-radius:12px;border:1px solid var(--md-sys-color-outline-variant);padding:0 10px;background:var(--md-sys-color-surface);color:var(--md-sys-color-on-surface);') }}
      <button type="submit" name="filter" value="1" class="md3-button md3-button-tonal">
        <span class="material-symbols-outlined" style="font-size:18px;margin-right:4px;">filter_alt</span>
        Filtern
      </button>
      <a href="{{ url_for('md3_order.wizard_step2') }}" class="md3-button md3-button-outlined" style="height:40px;display:inline-flex;align-items:center;text-decoration:none;">
        <span class="material-symbols-outlined" style="font-size:18px;margin-right:4px;">filter_alt_off</span>
        Filter zur√ºcksetzen
      </a>
    </div>

    <!-- Assets Tabelle -->
    <div class="md3-card wizard-card">
      <div class="table-wrap">
      <table class="md3-table" style="width:100%;border-collapse:separate;border-spacing:0 8px;min-width:1100px;">
        <thead>
          <tr>
            <th style="text-align:left;padding:8px 12px;">Auswahl</th>
            <th style="text-align:center;padding:8px 12px;width:70px;">Bild</th>
            <th style="text-align:left;padding:8px 12px;">Artikel</th>
            <th style="text-align:right;padding:8px 12px;">Wert (‚Ç¨)</th>
            <th style="text-align:left;padding:8px 12px;">Menge</th>
            <th style="text-align:left;padding:8px 12px;">Seriennummer</th>
            <th style="text-align:left;padding:8px 12px;">Hersteller</th>
            <th style="text-align:left;padding:8px 12px;">Lieferant</th>
            <th style="text-align:center;padding:8px 12px;width:120px;">üí∞ Preis</th>
          </tr>
        </thead>
        <tbody>
        {% for i in range(form.assets|length) %}
          {% set sub = form.assets[i] %}
          {% set asset = (assets|selectattr('id', 'equalto', (sub.asset_id.data or 0)|int)|list|first) %}
          <tr class="md3-row" style="background:var(--md-sys-color-surface);box-shadow:var(--md-sys-elevation-1);border-radius:12px;">
            <td style="padding:8px 12px;vertical-align:middle;">
              {{ sub.asset_id }}
              {{ sub.select() }}
            </td>
            <td style="padding:8px;text-align:center;vertical-align:middle;">
              {% if asset and asset.image_url %}
                <img src="{{ asset.image_url }}" alt="{{ asset.name }}" style="width:50px;height:50px;object-fit:cover;border-radius:8px;border:1px solid var(--md-sys-color-outline-variant);">
              {% else %}
                <div style="width:50px;height:50px;border-radius:8px;background:var(--md-sys-color-surface-variant);display:flex;align-items:center;justify-content:center;border:1px solid var(--md-sys-color-outline-variant);">
                  <span class="material-symbols-outlined" style="font-size:24px;color:var(--md-sys-color-on-surface-variant);opacity:0.5;">image</span>
                </div>
              {% endif %}
            </td>
            <td style="padding:8px 12px;">
              {% if asset %}
                <div><strong>{{ asset.name }}</strong></div>
                <div class="md3-subtitle">{{ asset.article_number or '-' }}</div>
              {% else %}
                <div><strong>Artikel #{{ sub.asset_id.data }}</strong></div>
              {% endif %}
            </td>
            <td style="padding:8px 12px;text-align:right;">
              {% if asset and asset.value %}
                <strong style="color:var(--md-sys-color-primary);">{{ "%.2f"|format(asset.value) }} ‚Ç¨</strong>
              {% else %}
                <span style="color:var(--md-sys-color-outline);">-</span>
              {% endif %}
            </td>
            <td style="padding:8px 12px;min-width:120px;">{{ sub.quantity(min=1, style='width:100px;height:40px;border-radius:12px;border:1px solid var(--md-sys-color-outline-variant);padding:0 10px;background:var(--md-sys-color-surface);color:var(--md-sys-color-on-surface);') }}</td>
            <td style="padding:8px 12px;min-width:220px;">{{ sub.serial_number(placeholder='optional', style='width:100%;height:40px;border-radius:12px;border:1px solid var(--md-sys-color-outline-variant);padding:0 10px;background:var(--md-sys-color-surface);color:var(--md-sys-color-on-surface);') }}</td>
            <td style="padding:8px 12px;min-width:150px;">
              {% if asset and asset.manufacturers %}
                <div style="font-size:13px;color:var(--md-sys-color-on-surface);">
                  {% for manufacturer in asset.manufacturers %}
                    <span style="display:inline-block;padding:2px 8px;background:var(--md-sys-color-secondary-container);color:var(--md-sys-color-on-secondary-container);border-radius:8px;font-size:11px;margin:2px;">{{ manufacturer.name }}</span>
                  {% endfor %}
                </div>
              {% else %}
                <span style="color:var(--md-sys-color-outline);font-size:13px;">-</span>
              {% endif %}
            </td>
            <td style="padding:8px 12px;min-width:150px;">
              {% if asset and asset.suppliers %}
                <div style="font-size:13px;color:var(--md-sys-color-on-surface);">
                  {% for supplier in asset.suppliers %}
                    <span style="display:inline-block;padding:2px 8px;background:var(--md-sys-color-tertiary-container);color:var(--md-sys-color-on-tertiary-container);border-radius:8px;font-size:11px;margin:2px;">{{ supplier.name }}</span>
                  {% endfor %}
                </div>
              {% else %}
                <span style="color:var(--md-sys-color-outline);font-size:13px;">-</span>
              {% endif %}
            </td>
            <td style="padding:8px 12px;text-align:center;vertical-align:middle;">
              {% if asset and (asset.ean or asset.gtin) %}
                <button type="button" class="md3-button md3-button-tonal" onclick="showPriceComparison({{ asset.id }})" style="padding:8px 12px;font-size:13px;">
                  <span class="material-symbols-outlined" style="font-size:18px;margin-right:4px;">search</span>
                  Vergleichen
                </button>
              {% else %}
                <span style="color:var(--md-sys-color-outline);font-size:12px;" title="Keine EAN/GTIN hinterlegt">-</span>
              {% endif %}
            </td>
          </tr>
        {% else %}
          <tr><td colspan="9" style="padding:12px;">Keine Artikel gefunden.</td></tr>
        {% endfor %}
        </tbody>
      </table>
      </div>
      
      <!-- Budget & Gesamtsumme -->
      {% if budget %}
      <div style="margin-top:16px;padding:16px;background:var(--md-sys-color-tertiary-container);border-radius:12px;">
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;align-items:center;">
          <div>
            <div style="font-size:12px;color:var(--md-sys-color-on-tertiary-container);opacity:0.7;margin-bottom:4px;">Budget</div>
            <div style="font-size:18px;font-weight:500;color:var(--md-sys-color-on-tertiary-container);">{{ "%.2f"|format(budget)|replace(".", ",") }} ‚Ç¨</div>
          </div>
          <div>
            <div style="font-size:12px;color:var(--md-sys-color-on-tertiary-container);opacity:0.7;margin-bottom:4px;">Gesamtsumme</div>
            <div id="total-value-small" style="font-size:18px;font-weight:500;color:var(--md-sys-color-on-tertiary-container);">0,00 ‚Ç¨</div>
          </div>
          <div id="remaining-budget-container">
            <div style="font-size:12px;opacity:0.7;margin-bottom:4px;" id="remaining-label">Restbudget</div>
            <div id="remaining-value" style="font-size:20px;font-weight:600;">{{ "%.2f"|format(budget)|replace(".", ",") }} ‚Ç¨</div>
          </div>
        </div>
      </div>
      {% else %}
      <div style="margin-top:16px;padding:16px;background:var(--md-sys-color-primary-container);border-radius:12px;display:flex;justify-content:space-between;align-items:center;">
        <div>
          <div style="font-size:14px;color:var(--md-sys-color-on-primary-container);opacity:0.8;">Gesamtsumme (ausgew√§hlte Artikel)</div>
          <div id="total-value" style="font-size:24px;font-weight:600;color:var(--md-sys-color-on-primary-container);">0,00 ‚Ç¨</div>
        </div>
        <span class="material-symbols-outlined" style="font-size:32px;color:var(--md-sys-color-on-primary-container);opacity:0.6;">euro</span>
      </div>
      {% endif %}
    </div>

    <div class="md3-toolbar" style="margin-top:16px;display:flex;gap:8px;justify-content:flex-end;">
      <a href="{{ url_for('md3_order.wizard_step1') }}" class="md3-button md3-button-text">Zur√ºck</a>
      {{ form.submit(class='md3-button md3-button-filled') }}
    </div>
  </form>
  </div>
</div>

<!-- Price Comparison Modal -->
<div id="priceModal" class="price-modal">
  <div class="price-modal-content">
    <div class="price-modal-header">
      <div style="display:flex;align-items:center;gap:12px;">
        <span class="material-symbols-outlined" style="font-size:32px;color:var(--md-sys-color-primary);">shopping_cart_checkout</span>
        <div>
          <h3 class="price-modal-title" id="priceModalTitle">Preisvergleich</h3>
          <div class="price-modal-subtitle" id="priceModalSubtitle">Wird geladen...</div>
        </div>
      </div>
      <button type="button" class="price-modal-close" onclick="closePriceModal()">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>
    <div class="price-modal-body" id="priceModalBody">
      <div style="text-align:center;padding:40px;">
        <span class="material-symbols-outlined" style="font-size:48px;color:var(--md-sys-color-outline);animation:spin 1s linear infinite;">progress_activity</span>
        <p>Preise werden verglichen...</p>
      </div>
    </div>
  </div>
</div>

<style>
  .price-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 10000;
    align-items: center;
    justify-content: center;
  }
  
  .price-modal.active {
    display: flex;
  }
  
  .price-modal-content {
    background: white;
    border-radius: 24px;
    max-width: 700px;
    width: 90%;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 12px 48px rgba(0, 0, 0, 0.3);
    animation: modalSlideIn 0.3s ease;
  }
  
  @keyframes modalSlideIn {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  .price-modal-header {
    padding: 24px;
    border-bottom: 1px solid var(--md-sys-color-outline-variant);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .price-modal-title {
    margin: 0;
    font: var(--md-sys-typescale-headline-small-font);
    color: var(--md-sys-color-on-surface);
  }
  
  .price-modal-subtitle {
    font: var(--md-sys-typescale-body-medium-font);
    color: var(--md-sys-color-on-surface-variant);
    margin-top: 4px;
  }
  
  .price-modal-close {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: none;
    background: var(--md-sys-color-surface-container);
    color: var(--md-sys-color-on-surface);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s ease;
  }
  
  .price-modal-close:hover {
    background: var(--md-sys-color-surface-container-high);
  }
  
  .price-modal-body {
    padding: 24px;
    overflow-y: auto;
  }
  
  .price-card {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px;
    border-radius: 16px;
    border: 2px solid var(--md-sys-color-outline-variant);
    margin-bottom: 12px;
    transition: all 0.2s ease;
  }
  
  .price-card:hover {
    border-color: var(--md-sys-color-primary);
    box-shadow: 0 4px 12px rgba(103, 80, 164, 0.2);
  }
  
  .price-card.best {
    border-color: var(--md-sys-color-tertiary);
    background: color-mix(in srgb, var(--md-sys-color-tertiary) 8%, var(--md-sys-color-surface));
  }
  
  .price-rank {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--md-sys-color-primary);
    color: var(--md-sys-color-on-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 14px;
  }
  
  .price-card.best .price-rank {
    background: var(--md-sys-color-tertiary);
    color: var(--md-sys-color-on-tertiary);
  }
  
  .price-info {
    flex: 1;
  }
  
  .price-shop {
    font-weight: 600;
    color: var(--md-sys-color-on-surface);
    margin-bottom: 4px;
  }
  
  .price-details {
    font-size: 13px;
    color: var(--md-sys-color-on-surface-variant);
  }
  
  .price-amount {
    font-size: 24px;
    font-weight: 600;
    color: var(--md-sys-color-primary);
  }
  
  .price-card.best .price-amount {
    color: var(--md-sys-color-tertiary);
  }
  
  .price-savings {
    font-size: 13px;
    color: var(--md-sys-color-error);
    margin-top: 4px;
  }
  
  .price-savings.positive {
    color: var(--md-sys-color-tertiary);
  }
  
  .price-action {
    padding: 10px 20px;
    border-radius: 999px;
    background: var(--md-sys-color-primary);
    color: var(--md-sys-color-on-primary);
    border: none;
    cursor: pointer;
    font-weight: 600;
    transition: opacity 0.2s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
  
  .price-action:hover {
    opacity: 0.9;
  }
</style>

<script>
// Supplier ID direkt vom Backend (robuster als Session-Zugriff)
const SUPPLIER_ID = {{ supplier_id if supplier_id else 'null' }};

// Asset-Werte f√ºr Gesamtsummen-Berechnung
const ASSET_VALUES = {
  {% for asset in assets %}
  {{ asset.id }}: {{ asset.value if asset.value else 0 }},
  {% endfor %}
};

// Budget (falls gesetzt)
const BUDGET = {{ budget if budget else 'null' }};

// Gesamtsumme berechnen und anzeigen
function updateTotalValue() {
  let total = 0;
  
  // Alle Zeilen durchgehen
  document.querySelectorAll('tr.md3-row').forEach(row => {
    const checkbox = row.querySelector('input[type="checkbox"]');
    const assetIdInput = row.querySelector('input[name$="-asset_id"]');
    const quantityInput = row.querySelector('input[type="number"]');
    
    if (checkbox && checkbox.checked && assetIdInput && quantityInput) {
      const assetId = parseInt(assetIdInput.value);
      const quantity = parseInt(quantityInput.value) || 1;
      const value = ASSET_VALUES[assetId] || 0;
      
      total += value * quantity;
    }
  });
  
  // Formatierung: 1234.56 ‚Üí "1.234,56 ‚Ç¨"
  const formatted = total.toLocaleString('de-DE', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  }) + ' ‚Ç¨';
  
  // Wenn Budget gesetzt, zeige Budget-Ansicht
  if (BUDGET !== null) {
    const totalEl = document.getElementById('total-value-small');
    if (totalEl) totalEl.textContent = formatted;
    
    // Restbudget berechnen
    const remaining = BUDGET - total;
    const remainingEl = document.getElementById('remaining-value');
    const remainingLabel = document.getElementById('remaining-label');
    const container = document.getElementById('remaining-budget-container');
    
    const remainingFormatted = Math.abs(remaining).toLocaleString('de-DE', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    }) + ' ‚Ç¨';
    
    if (remaining >= 0) {
      // Budget eingehalten - gr√ºn
      remainingEl.textContent = remainingFormatted;
      remainingEl.style.color = 'var(--md-sys-color-tertiary)';
      remainingLabel.textContent = 'Restbudget';
      remainingLabel.style.color = 'var(--md-sys-color-on-tertiary-container)';
    } else {
      // Budget √ºberschritten - rot
      remainingEl.textContent = remainingFormatted;
      remainingEl.style.color = 'var(--md-sys-color-error)';
      remainingLabel.textContent = 'Budget √ºberschritten um';
      remainingLabel.style.color = 'var(--md-sys-color-error)';
    }
  } else {
    // Kein Budget - normale Anzeige
    const totalEl = document.getElementById('total-value');
    if (totalEl) totalEl.textContent = formatted;
  }
}

// Event-Listener f√ºr Checkboxen und Mengen-√Ñnderungen
document.addEventListener('DOMContentLoaded', function() {
  // Initial berechnen
  updateTotalValue();
  
  // Bei Checkbox-√Ñnderung
  document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
    cb.addEventListener('change', updateTotalValue);
  });
  
  // Bei Mengen-√Ñnderung
  document.querySelectorAll('input[type="number"]').forEach(input => {
    input.addEventListener('input', updateTotalValue);
    input.addEventListener('change', updateTotalValue);
  });
});

// Vorlage laden und Artikel automatisch ausw√§hlen
function loadTemplate() {
  const templateId = document.getElementById('template-select').value;
  if (!templateId) {
    alert('Bitte zuerst eine Vorlage ausw√§hlen.');
    return;
  }
  
  fetch(`/md3/order/api/order-template/${templateId}`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Alle Checkboxen erstmal deaktivieren
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
          if (cb.name && cb.name.includes('select')) cb.checked = false;
        });
        
        // Template-Items durchgehen und entsprechende Assets ausw√§hlen
        data.items.forEach(item => {
          const assetId = item.asset_id;
          const quantity = item.quantity;
          
          // Finde die Zeile mit diesem Asset
          document.querySelectorAll('input[name$="-asset_id"]').forEach(input => {
            if (input.value == assetId) {
              // Finde Parent-Zeile
              const row = input.closest('tr');
              if (row) {
                // Checkbox aktivieren
                const checkbox = row.querySelector('input[type="checkbox"]');
                if (checkbox) checkbox.checked = true;
                
                // Menge setzen
                const quantityInput = row.querySelector('input[type="number"]');
                if (quantityInput) quantityInput.value = quantity;
              }
            }
          });
        });
        
        // Gesamtsumme neu berechnen
        updateTotalValue();
        
        alert(`Vorlage "${data.name}" wurde geladen. ${data.items.length} Artikel ausgew√§hlt.`);
      } else {
        alert('Fehler beim Laden der Vorlage: ' + (data.message || 'Unbekannter Fehler'));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Fehler beim Laden der Vorlage.');
    });
}

// Modal zum Speichern einer Vorlage
function openSaveTemplateModal() {
  // Pr√ºfe, ob Artikel ausgew√§hlt sind
  const selectedItems = [];
  document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
    if (cb.checked && cb.name && cb.name.includes('select')) {
      const row = cb.closest('tr');
      const assetIdInput = row.querySelector('input[name$="-asset_id"]');
      const quantityInput = row.querySelector('input[type="number"]');
      
      if (assetIdInput && quantityInput) {
        selectedItems.push({
          asset_id: assetIdInput.value,
          quantity: quantityInput.value
        });
      }
    }
  });
  
  if (selectedItems.length === 0) {
    alert('Bitte zuerst Artikel ausw√§hlen, bevor Sie eine Vorlage speichern.');
    return;
  }
  
  const templateName = prompt(`Vorlage speichern\n\n${selectedItems.length} Artikel ausgew√§hlt.\nBitte einen Namen f√ºr die Vorlage eingeben:`);
  
  if (!templateName || !templateName.trim()) {
    return; // Abgebrochen
  }
  
  // Template speichern via API
  fetch('/md3/order/api/order-template/save', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value || ''
    },
    body: JSON.stringify({
      name: templateName.trim(),
      supplier_id: SUPPLIER_ID,
      items: selectedItems
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert(`Vorlage "${templateName}" wurde erfolgreich gespeichert.`);
      // Dropdown aktualisieren
      const select = document.getElementById('template-select');
      const option = document.createElement('option');
      option.value = data.template_id;
      option.textContent = templateName.trim();
      select.appendChild(option);
      select.value = data.template_id;
    } else {
      alert('Fehler beim Speichern: ' + (data.message || 'Unbekannter Fehler'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Fehler beim Speichern der Vorlage.');
  });
}

// Price Comparison Modal (Hybrid: B2B + WWW)
function showPriceComparison(assetId) {
  const modal = document.getElementById('priceModal');
  modal.classList.add('active');
  
  // Fetch price comparison
  fetch(`/api/price-comparison/${assetId}`)
    .then(res => res.json())
    .then(data => {
      document.getElementById('priceModalTitle').textContent = `Preisvergleich: ${data.asset_name}`;
      document.getElementById('priceModalSubtitle').textContent = data.ean ? `EAN: ${data.ean}` : (data.gtin ? `GTIN: ${data.gtin}` : 'Produktname');
      
      let html = '';
      
      // Summary Header
      if (data.savings > 0 || data.has_b2b || data.has_www) {
        html += `<div style="margin-bottom:16px;padding:12px;background:var(--md-sys-color-tertiary-container);border-radius:12px;">
          <div style="font-weight:600;margin-bottom:4px;">üí∞ Ihr aktueller Preis: ${data.our_price.toFixed(2)} ‚Ç¨</div>
          <div style="font-size:13px;color:var(--md-sys-color-on-surface-variant);">Beste Alternative: ${data.best_price.toFixed(2)} ‚Ç¨ 
          ${data.savings > 0 ? `<span style="color:var(--md-sys-color-tertiary);font-weight:600;">(${data.savings.toFixed(2)} ‚Ç¨ g√ºnstiger)</span>` : ''}</div>
        </div>`;
      }
      
      // B2B Lieferanten Section
      if (data.has_b2b && data.b2b_prices.length > 0) {
        html += `<div style="margin-bottom:20px;">
          <h4 style="display:flex;align-items:center;gap:8px;margin-bottom:12px;color:var(--md-sys-color-primary);">
            <span class="material-symbols-outlined">business</span>
            Ihre B2B-Lieferanten (Vertragspreise)
          </h4>`;
        
        data.b2b_prices.forEach((alt, index) => {
          const isBest = index === 0;
          const diff = alt.price - data.our_price;
          html += `
            <div class="price-card ${isBest ? 'best' : ''}" style="margin-bottom:8px;">
              <div class="price-rank">${isBest ? 'üèÜ' : index + 1}</div>
              <div class="price-info">
                <div class="price-shop">üè¢ ${alt.shop}</div>
                <div class="price-details">${alt.shipping || 'Auf Rechnung'}${alt.delivery_time ? ' ‚Ä¢ ' + alt.delivery_time : ''}</div>
                ${alt.article_number ? `<div style="font-size:11px;color:var(--md-sys-color-outline);">Art.-Nr.: ${alt.article_number}</div>` : ''}
              </div>
              <div style="text-align:right;">
                <div class="price-amount">${alt.price.toFixed(2)} ‚Ç¨</div>
                <div class="price-savings ${diff < 0 ? 'positive' : ''}">${diff > 0 ? '+' : ''}${diff.toFixed(2)} ‚Ç¨</div>
                ${alt.last_updated ? `<div style="font-size:11px;color:var(--md-sys-color-outline);">Stand: ${alt.last_updated}</div>` : ''}
              </div>
              ${alt.url && alt.url !== '#' ? `<a href="${alt.url}" target="_blank" class="price-action">
                <span class="material-symbols-outlined">open_in_new</span>
                Zum Lieferanten
              </a>` : '<span style="color:var(--md-sys-color-outline);font-size:13px;">Kein Link</span>'}
            </div>
          `;
        });
        
        html += `</div>`;
      }
      
      // WWW Section
      if (data.has_www && data.www_prices.length > 0) {
        html += `<div style="margin-bottom:20px;">
          <h4 style="display:flex;align-items:center;gap:8px;margin-bottom:12px;color:var(--md-sys-color-secondary);">
            <span class="material-symbols-outlined">public</span>
            Beste Angebote im WWW
          </h4>`;
        
        data.www_prices.forEach((alt, index) => {
          const isBest = index === 0 && (!data.has_b2b || alt.price < data.b2b_prices[0].price);
          const diff = alt.price - data.our_price;
          html += `
            <div class="price-card ${isBest ? 'best' : ''}" style="margin-bottom:8px;">
              <div class="price-rank">${isBest ? 'üèÜ' : index + 1}</div>
              <div class="price-info">
                <div class="price-shop">üåê ${alt.shop}</div>
                <div class="price-details">${alt.shipping || 'zzgl. Versand'}</div>
                ${alt.source ? `<div style="font-size:11px;color:var(--md-sys-color-outline);">Quelle: ${alt.source}</div>` : ''}
              </div>
              <div style="text-align:right;">
                <div class="price-amount">${alt.price.toFixed(2)} ‚Ç¨</div>
                <div class="price-savings ${diff < 0 ? 'positive' : ''}">${diff > 0 ? '+' : ''}${diff.toFixed(2)} ‚Ç¨</div>
              </div>
              <a href="${alt.url}" target="_blank" class="price-action">
                <span class="material-symbols-outlined">open_in_new</span>
                Zum Shop
              </a>
            </div>
          `;
        });
        
        html += `</div>`;
        
        // Hinweis
        html += `<div style="padding:12px;background:var(--md-sys-color-surface-variant);border-radius:12px;font-size:13px;color:var(--md-sys-color-on-surface-variant);">
          <span class="material-symbols-outlined" style="font-size:16px;vertical-align:middle;margin-right:4px;">info</span>
          <strong>Hinweis:</strong> WWW-Preise sind ohne Firmenrabatt und ggf. zzgl. MwSt. Pr√ºfen Sie Zahlungs- und Lieferbedingungen.
        </div>`;
      }
      
      // No results
      if (!data.has_b2b && !data.has_www) {
        html = `<div style="text-align:center;padding:40px;">
          <span class="material-symbols-outlined" style="font-size:64px;color:var(--md-sys-color-outline);opacity:0.5;">search_off</span>
          <p style="margin-top:16px;color:var(--md-sys-color-on-surface-variant);">Keine Preise gefunden.</p>
          <p style="font-size:13px;color:var(--md-sys-color-outline);margin-top:8px;">Tipp: Pflegen Sie B2B-Lieferantenpreise oder hinterlegen Sie eine EAN/GTIN.</p>
        </div>`;
      }
      
      document.getElementById('priceModalBody').innerHTML = html;
    })
    .catch(error => {
      console.error('Error:', error);
      document.getElementById('priceModalBody').innerHTML = `
        <div style="text-align:center;padding:40px;">
          <span class="material-symbols-outlined" style="font-size:64px;color:var(--md-sys-color-error);">error</span>
          <p style="margin-top:16px;color:var(--md-sys-color-error);">Fehler beim Laden der Preise.</p>
        </div>
      `;
    });
}

function closePriceModal() {
  document.getElementById('priceModal').classList.remove('active');
}

// Close modal on outside click
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('priceModal');
  if (modal) {
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        closePriceModal();
      }
    });
  }
});
</script>

{% endblock %}
