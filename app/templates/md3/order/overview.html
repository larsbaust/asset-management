{% extends 'md3/base.html' %}
{% block styles %}
  {{ super() }}
  <style>
    .md3-page { padding: 24px; }
    .md3-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
    .md3-title { font: var(--md-sys-typescale-headline-small-font); color: var(--md-sys-color-on-surface); }
    .md3-filters { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .md3-card { background: var(--md-sys-color-surface); border-radius: 16px; box-shadow: var(--md-sys-elevation-level2); padding: 12px 16px; }
    .md3-chip { border-radius: 8px; padding: 6px 10px; background: var(--md-sys-color-surface-variant); color: var(--md-sys-color-on-surface-variant); }
    .md3-table { width:100%; border-collapse:separate; border-spacing:0 8px; }
    .md3-row { background: var(--md-sys-color-surface); box-shadow: var(--md-sys-elevation-level1); border-radius: 12px; }
    .md3-row td { padding: 12px 16px; }
    .status-dot { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:6px; vertical-align:middle; }
    .status-delivered { background:#1e8e3e; }
    .status-intransit { background:#0b57d0; }
    .status-problem { background:#b3261e; }
    .status-unknown { background:#6f797a; }
    .md3-actions { display:flex; gap:8px; }
    .md3-button { border: none; border-radius: 20px; padding: 8px 14px; cursor:pointer; }
    .md3-button-filled { background: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); }
    .md3-button-tonal { background: var(--md-sys-color-secondary-container); color: var(--md-sys-color-on-secondary-container); }
    .md3-button-text { background: transparent; color: var(--md-sys-color-primary); }
    .md3-subtitle { color: var(--md-sys-color-on-surface-variant); }
    .md3-toolbar { display:flex; gap:8px; }
    select, input[type="text"] { height:40px; border-radius:12px; border:1px solid var(--md-sys-color-outline-variant); padding:0 10px; background: var(--md-sys-color-surface); color: var(--md-sys-color-on-surface); }
  </style>
{% endblock %}

{% block content %}
<!-- MD3 Navigation Bar -->
{% include 'md3-nav.html' %}
<div class="md3-page">
  <div class="md3-header">
    <div>
      <div class="md3-title">Bestellübersicht (MD3)</div>
      {% if show_archived %}
        <div class="md3-subtitle">Archivierte Bestellungen (nur Lesen)</div>
      {% endif %}
    </div>
    <div class="md3-toolbar">
      <a class="md3-button md3-button-tonal" href="{{ url_for('md3_order.wizard_start') }}">Neue Bestellung</a>
      <a class="md3-button md3-button-text" href="{{ url_for('md3_order.import_csv') }}">CSV Import</a>
    </div>
  </div>

  <form method="get" class="md3-card md3-filters">
    <select name="status">
      <option value="">Status (alle)</option>
      <option value="offen" {% if selected_status == 'offen' %}selected{% endif %}>offen</option>
      <option value="bestellt" {% if selected_status == 'bestellt' %}selected{% endif %}>bestellt</option>
      <option value="erledigt" {% if selected_status == 'erledigt' %}selected{% endif %}>erledigt</option>
    </select>
    <select name="supplier_id">
      <option value="">Lieferant (alle)</option>
      {% for supplier in suppliers %}
        <option value="{{ supplier.id }}" {% if selected_supplier_id == supplier.id %}selected{% endif %}>{{ supplier.name }}</option>
      {% endfor %}
    </select>
    <select name="location">
      <option value="">Standort (alle)</option>
      {% for loc in locations %}
        <option value="{{ loc }}" {% if selected_location == loc %}selected{% endif %}>{{ loc }}</option>
      {% endfor %}
    </select>
    <input type="text" name="tracking_number" placeholder="Trackingnummer (enthält)" value="{{ selected_tracking_number or '' }}">
    <button type="submit" class="md3-button md3-button-filled">Filtern</button>
    <div style="flex:1"></div>
    <a class="md3-button {% if not show_archived %}md3-button-filled{% else %}md3-button-text{% endif %}" href="{{ url_for('md3_order.overview', status=selected_status, supplier_id=selected_supplier_id, archived=0) }}">Aktive</a>
    <a class="md3-button {% if show_archived %}md3-button-filled{% else %}md3-button-text{% endif %}" href="{{ url_for('md3_order.overview', status=selected_status, supplier_id=selected_supplier_id, archived=1) }}">Archiv</a>
  </form>

  <table class="md3-table">
    <thead style="display:none"></thead>
    <tbody>
    {% for order in orders %}
      <tr class="md3-row">
        <td style="width:64px;">#{{ order.id }}</td>
        <td style="min-width:220px;">
          <div><strong>{{ order.supplier.name if order.supplier else '—' }}</strong></div>
          <div class="md3-subtitle">{{ order.order_date.strftime('%d.%m.%Y %H:%M') if order.order_date else '' }}</div>
        </td>
        <td style="min-width:160px;">
          {% if order.location_obj %}
            {{ order.location_obj.name }}
          {% else %}
            {{ order.location or '—' }}
          {% endif %}
        </td>
        <td style="min-width:220px;">
          {% if order.tracking_number %}
            {% set tn = order.tracking_number.strip() %}
            {% if tn.startswith('1Z') %}
              <a href="https://www.ups.com/track?loc=de_DE&tracknum={{ tn }}" target="_blank">{{ tn }}</a>
            {% elif tn|length == 12 and tn.isdigit() %}
              <a href="https://www.dhl.de/de/privatkunden/dhl-sendungsverfolgung.html?piececode={{ tn }}" target="_blank">{{ tn }}</a>
            {% elif tn|length in [14, 15] and tn.isdigit() %}
              <a href="https://www.dpd.com/de/de/empfangen/sendungsverfolgung-und-live-tracking/?parcelNumber={{ tn }}" target="_blank">{{ tn }}</a>
            {% else %}
              {{ tn }}
            {% endif %}
          {% else %}—{% endif %}
        </td>
        <td style="min-width:150px;">
          <span class="status-dot {{ order_status_classes[order.id] }}"></span>
          <span class="md3-chip">{{ order.status }}</span>
        </td>
        <td style="width:90px; text-align:center;">{{ order.items|length }}</td>
        <td style="min-width:220px;">
          <div class="md3-actions">
            <a class="md3-button md3-button-text" href="{{ url_for('order.order_detail', order_id=order.id) }}">Details</a>
            <a class="md3-button md3-button-tonal" href="{{ url_for('order.order_export_dialog', order_id=order.id) }}">Export</a>
            {% if not show_archived %}
            <form method="post" action="{{ url_for('order.archive_order', order_id=order.id) }}">
              <button class="md3-button md3-button-text" type="submit">Archivieren</button>
            </form>
            {% else %}
            <form method="post" action="{{ url_for('order.restore_order', order_id=order.id) }}">
              <button class="md3-button md3-button-text" type="submit">Wiederherstellen</button>
            </form>
            {% endif %}
          </div>
        </td>
      </tr>
    {% else %}
      <tr class="md3-row"><td style="padding:16px">Keine Bestellungen vorhanden.</td></tr>
    {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
