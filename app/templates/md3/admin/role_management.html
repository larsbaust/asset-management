{% extends 'base.html' %}

{% block head %}
<style>
  .md3-page {
    padding: 24px;
    padding-top: 90px;
    min-height: 100vh;
    background: var(--md-sys-color-surface-container-lowest);
  }
  
  .md3-container {
    max-width: 1400px;
    margin: 0 auto;
  }
  
  .page-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 32px;
    gap: 16px;
    flex-wrap: wrap;
  }
  
  .page-title {
    font: var(--md-sys-typescale-headline-large-font);
    color: var(--md-sys-color-on-surface);
    margin: 0;
  }
  
  .roles-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
    gap: 24px;
  }
  
  .role-card {
    background: var(--md-sys-color-surface);
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    border: 1px solid var(--md-sys-color-outline-variant);
    transition: all 0.3s ease;
  }
  
  .role-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    transform: translateY(-2px);
  }
  
  .role-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 16px;
    gap: 12px;
  }
  
  .role-info {
    flex: 1;
  }
  
  .role-name {
    font: var(--md-sys-typescale-title-large-font);
    color: var(--md-sys-color-on-surface);
    margin: 0 0 4px 0;
  }
  
  .role-description {
    font: var(--md-sys-typescale-body-medium-font);
    color: var(--md-sys-color-on-surface-variant);
    margin: 0;
  }
  
  .role-actions {
    display: flex;
    gap: 8px;
  }
  
  .permissions-section {
    margin-top: 20px;
  }
  
  .permissions-header {
    font: var(--md-sys-typescale-label-large-font);
    color: var(--md-sys-color-primary);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .permissions-count {
    background: var(--md-sys-color-primary-container);
    color: var(--md-sys-color-on-primary-container);
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
  }
  
  .permissions-grid {
    display: grid;
    gap: 12px;
  }
  
  .permission-category {
    background: var(--md-sys-color-surface-container-highest);
    border-radius: 12px;
    padding: 12px;
  }
  
  .category-title {
    font: var(--md-sys-typescale-label-medium-font);
    color: var(--md-sys-color-on-surface-variant);
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  .category-title .material-symbols-outlined {
    font-size: 18px;
  }
  
  .permission-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }
  
  .permission-chip {
    background: var(--md-sys-color-secondary-container);
    color: var(--md-sys-color-on-secondary-container);
    padding: 4px 12px;
    border-radius: 8px;
    font: var(--md-sys-typescale-label-small-font);
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }
  
  .md3-button {
    border: none;
    border-radius: 20px;
    padding: 10px 24px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    text-decoration: none;
    font: var(--md-sys-typescale-label-large-font);
    transition: all 0.2s ease;
  }
  
  .md3-button .material-symbols-outlined {
    font-size: 20px;
    font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 20;
  }
  
  .md3-button-filled {
    background: var(--md-sys-color-primary);
    color: var(--md-sys-color-on-primary);
  }
  
  .md3-button-filled:hover {
    background: var(--md-sys-color-primary);
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }
  
  .md3-button-tonal {
    background: var(--md-sys-color-secondary-container);
    color: var(--md-sys-color-on-secondary-container);
  }
  
  .md3-button-tonal:hover {
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }
  
  .md3-button-outlined {
    background: transparent;
    color: var(--md-sys-color-primary);
    border: 1px solid var(--md-sys-color-outline);
  }
  
  .md3-button-outlined:hover {
    background: var(--md-sys-color-primary-container);
  }
  
  .md3-button-error {
    background: transparent;
    color: var(--md-sys-color-error);
  }
  
  .md3-button-error:hover {
    background: var(--md-sys-color-error-container);
  }
  
  .md3-icon-button {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border: none;
    background: transparent;
    cursor: pointer;
    transition: all 0.2s ease;
    color: var(--md-sys-color-on-surface-variant);
  }
  
  .md3-icon-button:hover {
    background: var(--md-sys-color-surface-container-highest);
  }
  
  .md3-icon-button.delete:hover {
    background: var(--md-sys-color-error-container);
    color: var(--md-sys-color-error);
  }
  
  @media (max-width: 768px) {
    .md3-page {
      padding: 16px;
      padding-top: 80px;
    }
    
    .roles-grid {
      grid-template-columns: 1fr;
    }
    
    .page-header {
      flex-direction: column;
      align-items: stretch;
    }
    
    .md3-button-filled {
      width: 100%;
      justify-content: center;
    }
  }
</style>
{% endblock %}

{% block content %}
  {% include 'md3-nav.html' %}
  <div class="md3-page">
    <div class="md3-container">
      <div class="page-header">
        <h1 class="page-title">Rollenverwaltung</h1>
        <a href="{{ url_for('admin.add_role', md3=1) }}" class="md3-button md3-button-filled">
          <span class="material-symbols-outlined">add_circle</span>
          Neue Rolle anlegen
        </a>
      </div>

      <div class="roles-grid">
        {% for role in roles %}
        <div class="role-card">
          <div class="role-header">
            <div class="role-info">
              <h2 class="role-name">{{ role.name }}</h2>
              <p class="role-description">{{ role.description or 'Keine Beschreibung' }}</p>
            </div>
            <div class="role-actions">
              <a href="{{ url_for('admin.edit_role', role_id=role.id, md3=1) }}" class="md3-icon-button" title="Bearbeiten">
                <span class="material-symbols-outlined">edit</span>
              </a>
              <a href="{{ url_for('admin.delete_role', role_id=role.id, md3=1) }}" class="md3-icon-button delete" onclick="return confirm('Rolle wirklich löschen?');" title="Löschen">
                <span class="material-symbols-outlined">delete</span>
              </a>
            </div>
          </div>
          
          <div class="permissions-section">
            <div class="permissions-header">
              <span>Berechtigungen</span>
              <span class="permissions-count">{{ role.permissions|length }}</span>
            </div>
            
            {% if role.permissions %}
              <div class="permissions-grid">
                {% set permission_categories = {
                  'Assets': [],
                  'Dashboard': [],
                  'Administration': [],
                  'Bestellung': [],
                  'Inventur': [],
                  'Charts': [],
                  'Reports': [],
                  'Backup': [],
                  'Standorte': [],
                  'Lieferanten': [],
                  'Hersteller': [],
                  'Kategorien': [],
                  'Ausleihen': [],
                  'Wartung': []
                } %}
                
                {% for perm in role.permissions %}
                  {% if 'asset' in perm.name %}
                    {% set _ = permission_categories['Assets'].append(perm.name) %}
                  {% elif 'dashboard' in perm.name %}
                    {% set _ = permission_categories['Dashboard'].append(perm.name) %}
                  {% elif 'user' in perm.name or 'role' in perm.name or 'changelog' in perm.name %}
                    {% set _ = permission_categories['Administration'].append(perm.name) %}
                  {% elif 'order' in perm.name %}
                    {% set _ = permission_categories['Bestellung'].append(perm.name) %}
                  {% elif 'inventory' in perm.name %}
                    {% set _ = permission_categories['Inventur'].append(perm.name) %}
                  {% elif 'chart' in perm.name %}
                    {% set _ = permission_categories['Charts'].append(perm.name) %}
                  {% elif 'csv' in perm.name or 'report' in perm.name %}
                    {% set _ = permission_categories['Reports'].append(perm.name) %}
                  {% elif 'backup' in perm.name or 'restore' in perm.name or 'archive' in perm.name %}
                    {% set _ = permission_categories['Backup'].append(perm.name) %}
                  {% elif 'location' in perm.name %}
                    {% set _ = permission_categories['Standorte'].append(perm.name) %}
                  {% elif 'supplier' in perm.name %}
                    {% set _ = permission_categories['Lieferanten'].append(perm.name) %}
                  {% elif 'manufacturer' in perm.name %}
                    {% set _ = permission_categories['Hersteller'].append(perm.name) %}
                  {% elif 'categor' in perm.name %}
                    {% set _ = permission_categories['Kategorien'].append(perm.name) %}
                  {% elif 'loan' in perm.name %}
                    {% set _ = permission_categories['Ausleihen'].append(perm.name) %}
                  {% elif 'maintenance' in perm.name %}
                    {% set _ = permission_categories['Wartung'].append(perm.name) %}
                  {% endif %}
                {% endfor %}
                
                {% for category, perms in permission_categories.items() %}
                  {% if perms|length > 0 %}
                    <div class="permission-category">
                      <div class="category-title">
                        <span class="material-symbols-outlined">folder</span>
                        {{ category }}
                      </div>
                      <div class="permission-chips">
                        {% for perm_name in perms %}
                          <span class="permission-chip">{{ perm_name }}</span>
                        {% endfor %}
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
            {% else %}
              <p style="color: var(--md-sys-color-on-surface-variant); font-size: 14px; margin: 0;">Keine Berechtigungen zugewiesen</p>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
{% endblock %}
