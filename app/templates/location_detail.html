{% extends 'base.html' %}
{% block title %}Standort: {{ location.name }}{% endblock %}
{% block content %}
<div class="container mt-4">
    {% if location.image_url %}
        <img src="/{{ location.image_url }}" alt="Profilbild" style="width:120px; height:120px; object-fit:cover; border-radius:12px; margin-bottom: 16px;">
    {% else %}
        <div style="width:120px;height:120px;background:#eee;border-radius:12px;text-align:center;line-height:120px;color:#aaa;font-size:48px;margin-bottom:16px;">—</div>
    {% endif %}
    <h2>Standort: {{ location.name }}</h2>
    <div class="box">
        <strong>Adresse:</strong> {{ location.street }}, {{ location.postal_code }} {{ location.city }}<br>
        <strong>Bundesland:</strong> {{ location.state or '-' }}<br>
        <strong>Größe:</strong> {{ location.size_sqm or '-' }} m²<br>
        <strong>Sitzplätze:</strong> {{ location.seats or '-' }}<br>
        <strong>Beschreibung:</strong> {{ location.description or '-' }}<br>
        {% if location.image_url %}
            <img src="/{{ location.image_url }}" alt="Bild Standort" style="max-width:300px; margin-top:10px;">
        {% endif %}
        <br>
        {% if location.latitude and location.longitude %}
            <strong>Koordinaten:</strong> {{ location.latitude }}, {{ location.longitude }}
        {% endif %}
    </div>
    <div class="mb-3">
        <a href="{{ url_for('main.edit_location', id=location.id) }}" class="button is-info">Bearbeiten</a>
        <a href="{{ url_for('main.delete_location', id=location.id) }}" class="button is-danger" onclick="return confirm('Standort wirklich löschen?');">Löschen</a>
        <a href="{{ url_for('main.locations') }}" class="button is-light">Zurück zur Übersicht</a>
    </div>

    <h4 class="mt-5">Standort Dokumentation / Galerie</h4>
    <form method="POST" action="{{ url_for('main.upload_location_image', id=location.id) }}" enctype="multipart/form-data" class="box mb-4">
        {{ gallery_form.hidden_tag() }}
        <div class="field is-horizontal">
            <div class="field-body">
                <div class="field">
                    <label class="label">Datei (Bild oder PDF)</label>
                    <div class="control">
                        {{ gallery_form.file(class="input", multiple=True) }}
<p class="help">Mehrere Dateien auswählbar (Bilder/PDFs, max. 10 auf einmal)</p>
                    </div>
                </div>
                <div class="field">
                    <label class="label">Beschreibung</label>
                    <div class="control">
                        {{ gallery_form.description(class="input") }}
                    </div>
                </div>
                <div class="field">
                    <label class="label">Kommentar</label>
                    <div class="control">
                        {{ gallery_form.comment(class="input") }}
                    </div>
                </div>
                <div class="field is-align-self-end">
                    <div class="control">
                        {{ gallery_form.submit(class="button is-primary") }}
                    </div>
                </div>
            </div>
        </div>
    </form>

    <div class="gallery-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 18px; margin-bottom: 2rem;">
        {% for img in gallery_images %}
            <div class="box" style="text-align:center; padding: 10px;">
                {% if img.mimetype.startswith('image') %}
                    <a href="{{ url_for('static', filename=img.filename) }}" target="_blank"><img src="{{ url_for('static', filename=img.filename) }}" alt="Dokumentation" style="max-width: 100%; max-height: 120px; object-fit: cover; border-radius: 8px;"></a>
                {% elif img.mimetype == 'application/pdf' %}
                    <a href="{{ url_for('static', filename=img.filename) }}" target="_blank" style="display:block; font-size:32px; color:#b53;">
                        <i class="fas fa-file-pdf"></i><br>PDF
                    </a>
                {% else %}
                    <a href="{{ url_for('static', filename=img.filename) }}" target="_blank">Dokument anzeigen</a>
                {% endif %}
                <div style="margin-top:8px; font-size:0.95em; color:#555;">
                    <strong>{{ img.description or '' }}</strong>
                    <div style="font-size:0.9em; color:#888;">{{ img.comment or '' }}</div>
                    <div style="font-size:0.8em; color:#aaa;">{{ img.uploader or '' }}<br>{{ img.upload_date.strftime('%d.%m.%Y %H:%M') if img.upload_date else '' }}</div>
                </div>
            </div>
        {% else %}
            <div>Keine Dokumentationsbilder/Dokumente vorhanden.</div>
        {% endfor %}
    </div>
    <h4 class="mt-4">Lagerbestand Übersicht</h4>
    <div class="columns">
        <div class="column is-half">
            <div class="box">
                <h5 class="title is-5">Bestand nach Kategorien</h5>
                <table class="table is-fullwidth is-striped">
                    <thead>
                        <tr>
                            <th>Kategorie</th>
                            <th>Anzahl</th>
                            <th>Gesamtwert</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set categories = {} %}
                        {% for asset in filtered_assets %}
                            {% set cat_name = asset.category.name if asset.category else 'Ohne Kategorie' %}
                            {% if cat_name not in categories %}
                                {% set _ = categories.update({cat_name: {'count': 0, 'value': 0}}) %}
                            {% endif %}
                            {% set _ = categories[cat_name].update({'count': categories[cat_name]['count'] + 1}) %}
                            {% set asset_value = asset.value if asset.value is not none else 0 %}
                            {% set _ = categories[cat_name].update({'value': categories[cat_name]['value'] + asset_value}) %}
                        {% endfor %}
                        
                        {% for cat_name, data in categories.items() %}
                        <tr>
                            <td>{{ cat_name }}</td>
                            <td>{{ data['count'] }}</td>
                            <td>{{ '%.2f'|format(data['value']) }} €</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="3">Keine Assets vorhanden</td>
                        </tr>
                        {% endfor %}
                        {% set total_value = 0 %}
                        {% for asset in filtered_assets %}
                            {% if asset.value is not none %}
                                {% set total_value = total_value + asset.value %}
                            {% endif %}
                        {% endfor %}
                        <tr class="has-background-light">
                            <td><strong>Gesamt</strong></td>
                            <td><strong>{{ filtered_assets|length }}</strong></td>
                            <td><strong>{{ '%.2f'|format(total_value) }} €</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="column is-half">
            <div class="box">
                <h5 class="title is-5">Inventurstatus</h5>
                <div class="notification {% if location.inventory_status == 'Abgeschlossen' %}is-success{% elif location.inventory_status == 'In Bearbeitung' %}is-warning{% elif location.inventory_status == 'Geplant' %}is-info{% else %}is-light{% endif %} is-light">
                    <p><strong>Letzte Inventur:</strong> {% if location.last_inventory_date %}{{ location.last_inventory_date.strftime('%d.%m.%Y') }}{% else %}Noch keine Inventur durchgeführt{% endif %}</p>
                    <p><strong>Status:</strong> {% if location.inventory_status %}{{ location.inventory_status }}{% else %}Keine Informationen{% endif %}</p>
                    {% if latest_inventory %}
                    <p><strong>Aktuelle Inventur:</strong> {{ latest_inventory.name }}</p>
                    <p><strong>Zeitraum:</strong> {{ latest_inventory.start_date.strftime('%d.%m.%Y') }} - {{ latest_inventory.end_date.strftime('%d.%m.%Y') }}</p>
                    {% endif %}
                </div>
                <div class="buttons">
                    <a href="{{ url_for('main.inventory_location_plan', location_id=location.id) }}" class="button is-primary">
                        <span class="icon"><i class="fas fa-clipboard-check"></i></span>
                        <span>Inventur planen/durchführen</span>
                    </a>
                    <a href="{{ url_for('main.inventory_location_history', location_id=location.id) }}" class="button is-info">
                        <span class="icon"><i class="fas fa-history"></i></span>
                        <span>Inventurhistorie</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="box mt-4">
        <h5 class="title is-5">Bestand nach Name</h5>
        <table class="table is-fullwidth is-striped">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Soll</th>
                    <th>Ist</th>
                    <th>Diff</th>
                    <th>Wert</th>
                </tr>
            </thead>
            <tbody>
                {% for name, data in stock_by_name.items()|sort %}
                <tr>
                    <td>{{ name }}</td>
                    <td>{{ data['count'] }}</td>
                    <td>{{ data['actual_count'] }}</td>
                    <td>
                        {% set diff = data['actual_count'] - data['count'] %}
                        <span class="{% if diff < 0 %}has-text-danger{% elif diff > 0 %}has-text-success{% endif %}">
                            {{ diff }}
                        </span>
                    </td>
                    <td>{{ '%.2f'|format(data['value']) }} €</td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5">Keine Assets vorhanden</td>
                </tr>
                {% endfor %}
                
                {% set total_expected = 0 %}
                {% set total_actual = 0 %}
                {% set total_value = 0 %}
                {% for name, data in stock_by_name.items() %}
                    {% set total_expected = total_expected + data['count'] %}
                    {% set total_actual = total_actual + data['actual_count'] %}
                    {% set total_value = total_value + data['value'] %}
                {% endfor %}
                
                <tr class="has-background-light">
                    <td><strong>Gesamt</strong></td>
                    <td><strong>{{ total_expected }}</strong></td>
                    <td><strong>{{ total_actual }}</strong></td>
                    <td>
                        {% set total_diff = total_actual - total_expected %}
                        <strong class="{% if total_diff < 0 %}has-text-danger{% elif total_diff > 0 %}has-text-success{% endif %}">
                            {{ total_diff }}
                        </strong>
                    </td>
                    <td><strong>{{ '%.2f'|format(total_value) }} €</strong></td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <h4 class="mt-4">Assets an diesem Standort ({{ filtered_assets|length }})</h4>
    <div class="tabs is-toggle is-toggle-rounded mb-2">
      <ul>
        <li class="{% if selected_status == 'active' %}is-active{% endif %}">
          <a href="{{ url_for('main.location_detail', id=location.id, status='active') }}">Aktiv</a>
        </li>
        <li class="{% if selected_status == 'inactive' %}is-active{% endif %}">
          <a href="{{ url_for('main.location_detail', id=location.id, status='inactive') }}">Inaktiv</a>
        </li>
        <li class="{% if selected_status == 'all' %}is-active{% endif %}">
          <a href="{{ url_for('main.location_detail', id=location.id, status='all') }}">Alle</a>
        </li>
      </ul>
    </div>
    <table class="table is-striped">
        <thead>
            <tr>
                <th>Name</th>
                <th>Kategorie</th>
                <th>Status</th>
                <th>Wert</th>
                <th>Aktionen</th>
            </tr>
        </thead>
        <tbody>
            {% for asset in filtered_assets %}
            <tr>
                <td><a href="{{ url_for('main.asset_details', id=asset.id) }}">{{ asset.name }}</a></td>
                <td>{{ asset.category.name if asset.category else '-' }}</td>
                <td>{{ asset.get_status_display() }}</td>
                <td>{{ '%.2f'|format(asset.value or 0) }} €</td>
                <td>
                    <a href="{{ url_for('main.edit_asset', id=asset.id) }}" class="button is-small is-info">Bearbeiten</a>
                </td>
            </tr>
            {% else %}
            <tr><td colspan="5">Keine Assets an diesem Standort.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
